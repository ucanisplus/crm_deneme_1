// GalvanizliTelNetsis.jsx - DÃ¼zeltilmiÅŸ Versiyon
// Son gÃ¼ncelleme: 20 MayÄ±s 2025
// YapÄ±lan dÃ¼zeltmeler:
// 1. saveRecipesToDatabase fonksiyonu tamamen yeniden yazÄ±ldÄ±
// 2. API 404 hatalarÄ± durumunda doÄŸru ÅŸekilde stok_kodu Ã¼retimi saÄŸlandÄ±
// 3. MMGT ve YMGT arasÄ±ndaki sequence tutarsÄ±zlÄ±klarÄ± otomatik olarak dÃ¼zeltiliyor
// 4. ReÃ§ete kayÄ±tlarÄ±nda daha fazla Netsis uyumlu alan eklendi
// 5. Hata durumlarÄ±nda daha gÃ¼Ã§lÃ¼ error handling eklendi
import React, { useState, useEffect, useMemo } from 'react';
import { useAuth } from '@/context/AuthContext';
import { API_URLS, fetchWithAuth, normalizeInputValue } from '@/api-config';
import { fetchWithCorsProxy, CORS_PROXY_API_URLS } from '@/lib/cors-proxy';
import { toast } from 'react-toastify';
import ExcelJS from 'exceljs';
import { saveAs } from 'file-saver';

const GalvanizliTelNetsis = () => {
  const { user, hasPermission } = useAuth();
  
  // Ana state deÄŸiÅŸkenleri
  const [currentStep, setCurrentStep] = useState('input'); // input, summary, processing
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [successMessage, setSuccessMessage] = useState('');
  
  // User input values for calculations
  const [userInputValues, setUserInputValues] = useState({
    ash: 5.54, // Ash (KÃ¼l) (Kg/tonne)
    lapa: 2.73, // Lapa (Kg/tonne)
    uretim_kapasitesi_aylik: 2800,
    toplam_tuketilen_asit: 30000,
    ortalama_uretim_capi: 3.08,
    paketlemeDkAdet: 10
  });
  
  // Talep yÃ¶netimi state'leri
  const [requests, setRequests] = useState([]);
  const [selectedRequest, setSelectedRequest] = useState(null);
  const [showRequestsModal, setShowRequestsModal] = useState(false);
  const [isRequestUsed, setIsRequestUsed] = useState(false); // Talep kullanÄ±lma durumu
  
  // Mevcut MM GT seÃ§imi iÃ§in state'ler
  const [existingMmGts, setExistingMmGts] = useState([]);
  const [selectedExistingMmGt, setSelectedExistingMmGt] = useState(null);
  const [showExistingMmGtModal, setShowExistingMmGtModal] = useState(false);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const [itemToDelete, setItemToDelete] = useState(null);
  const [deleteType, setDeleteType] = useState('mmgt'); // 'mmgt' or 'ymst'
  
  // Settings modal for user input values
  const [showSettingsModal, setShowSettingsModal] = useState(false);
  
  // YM ST ekleme modalÄ±
  const [showAddYmStModal, setShowAddYmStModal] = useState(false);
  const [newYmStData, setNewYmStData] = useState({
    cap: '',
    filmasin: '',
    quality: ''
  });
  
  // YMST listesi iÃ§in stateler
  const [existingYmSts, setExistingYmSts] = useState([]);
  const [activeDbTab, setActiveDbTab] = useState('mmgt'); // 'mmgt' or 'ymst'
  const [mainYmStIndex, setMainYmStIndex] = useState(0); // Ana YMST'nin index'i (1:1:n iliÅŸkisi iÃ§in)
  
  // Session tracking - aynÄ± oturumda kaydedilen Ã¼rÃ¼nleri takip etmek iÃ§in
  const [sessionSavedProducts, setSessionSavedProducts] = useState({
    mmGtIds: [],
    ymGtId: null,
    ymStIds: []
  });
  
  // Form verileri - Decimal deÄŸerleri nokta formatÄ±na Ã§eviren yardÄ±mcÄ± fonksiyon - NOKTA KULLAN
  const normalizeDecimalDisplay = (value) => {
    // Handle null or undefined
    if (value === null || value === undefined) {
      return '';
    }
    
    // For numbers, force specific formatting with points
    if (typeof value === 'number') {
      // Use string conversion to force point as decimal separator
      return value.toString();
    }
    
    // For strings with commas, convert to points
    if (typeof value === 'string' && value.includes(',')) {
      return value.replace(/,/g, '.');
    }
    
    // For strings that are already properly formatted with points, return as is
    if (typeof value === 'string') {
      return value;
    }
    
    // Fallback
    return value ? value.toString() : '';
  };
  
  // Form verileri - NOKTA kullan decimal iÃ§in
  const [mmGtData, setMmGtData] = useState({
    cap: '2.50', // Ensure point decimal separator 
    kod_2: 'NIT',
    kaplama: '50', // Integer value
    min_mukavemet: '350', // Integer value
    max_mukavemet: '550', // Integer value
    kg: '500', // Integer value
    ic_cap: 45,
    dis_cap: 75,
    tolerans_plus: '0.05', // Ensure point decimal separator
    tolerans_minus: '0.06', // Ensure point decimal separator
    shrink: 'evet',
    unwinding: '',
    cast_kont: '',
    helix_kont: '',
    elongation: ''
  });
  
  // Hesaplanan/oluÅŸturulan veriler
  const [ymGtData, setYmGtData] = useState(null);
  const [suitableYmSts, setSuitableYmSts] = useState([]);
  const [selectedYmSts, setSelectedYmSts] = useState([]);
  const [autoGeneratedYmSts, setAutoGeneratedYmSts] = useState([]);
  
  // ReÃ§ete verileri - Her YM ST iÃ§in MM GT, YM GT ve YM ST reÃ§eteleri
  const [allRecipes, setAllRecipes] = useState({
    mmGtRecipes: {}, // { ymStIndex: { recipe } }
    ymGtRecipe: {}, // Tek YM GT reÃ§etesi (sequence matching)
    ymStRecipes: {} // { ymStIndex: { recipe } }
  });
  
  // ReÃ§ete durumu takibi - hangi alan nereden geldi
  const [recipeStatus, setRecipeStatus] = useState({
    mmGtRecipes: {}, // { ymStIndex: { bilesen_kodu: 'database' | 'auto' | 'manual' } }
    ymGtRecipe: {}, // { bilesen_kodu: 'database' | 'auto' | 'manual' }
    ymStRecipes: {} // { ymStIndex: { bilesen_kodu: 'database' | 'auto' | 'manual' } }
  });
  
  // Aktif reÃ§ete sekmesi
  const [activeRecipeTab, setActiveRecipeTab] = useState(0); // Hangi YM ST'nin reÃ§etesi gÃ¶steriliyor
  
  // VeritabanÄ± state'leri
  const [savedToDatabase, setSavedToDatabase] = useState(false);
  const [databaseIds, setDatabaseIds] = useState({
    mmGtIds: [], // Ã‡oklu MM GT ID'ler
    ymGtId: null,
    ymStIds: []
  });

  // DostÃ§a alan adlarÄ±
  const friendlyNames = {
    'TLC01': 'Tel Ã‡ekme SÃ¼re (TLC01)',
    'SM.HÄ°DROLÄ°K.ASÄ°T': 'HCL Asit (SM.HÄ°DROLÄ°K.ASÄ°T)',
    '150 03': 'Ã‡inko (150 03)',
    'AMB.APEX CEMBER 38X080': 'Ã‡elik Ã§ember (AMB.APEX CEMBER 38X080)',
    'AMB.TOKA.SIGNODE.114P. DKP': 'Ã‡ember tokasÄ± (AMB.TOKA.SIGNODE.114P. DKP)',
    'SM.7MMHALKA': 'KaldÄ±rma kancasÄ± (SM.7MMHALKA)',
    'AMB.SHRÄ°NK.200*140CM': 'Shrink (AMB.SHRÄ°NK.200*140CM)',
    'AMB.SHRÄ°NK.200*160CM': 'Shrink (AMB.SHRÄ°NK.200*160CM)',
    'AMB.SHRÄ°NK.200*190CM': 'Shrink (AMB.SHRÄ°NK.200*190CM)',
    'AMB.Ã‡EM.KARTON.GAL': 'Karton (AMB.Ã‡EM.KARTON.GAL)',
    'GTPKT01': 'Paketleme SÃ¼re (GTPKT01)',
    'GLV01': 'Galvaniz SÃ¼re (GLV01)',
    'SM.DESÄ°.PAK': 'Silkajel TÃ¼ketimi (AD)'
  };

  // Ä°zin kontrolÃ¼
  if (!hasPermission('access:galvanizli-tel')) {
    return (
      <div className="p-4 text-center">
        <div className="bg-red-50 border border-red-200 rounded-md p-4">
          <p className="text-red-700">Bu modÃ¼le eriÅŸim izniniz bulunmamaktadÄ±r.</p>
        </div>
      </div>
    );
  }

  // Sayfa yÃ¼klendiÄŸinde talepleri getir
  useEffect(() => {
    fetchRequests();
    fetchExistingMmGts();
    fetchExistingYmSts();
    fetchUserInputValues();
  }, []);
  
  // Fetch user input values from database
  const fetchUserInputValues = async () => {
    try {
      // Check if the API endpoint URL is defined
      if (!API_URLS.galUserInputValues) {
        console.warn('galUserInputValues API endpoint is not defined, using default values');
        return;
      }
      
      const response = await fetch(API_URLS.galUserInputValues);
      if (response && response.ok) {
        const data = await response.json();
        // Get the latest entry
        if (data && data.length > 0) {
          // Sort by created_at in descending order to get the latest
          const sortedData = data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          const latestValues = sortedData[0];
          
          setUserInputValues({
            ash: parseFloat(latestValues.ash) || 5.54,
            lapa: parseFloat(latestValues.lapa) || 2.73,
            uretim_kapasitesi_aylik: parseFloat(latestValues.uretim_kapasitesi_aylik) || 2800,
            toplam_tuketilen_asit: parseFloat(latestValues.toplam_tuketilen_asit) || 30000,
            ortalama_uretim_capi: parseFloat(latestValues.ortalama_uretim_capi) || 3.08,
            paketlemeDkAdet: parseFloat(latestValues.paketlemeDkAdet) || 10
          });
        }
      }
    } catch (error) {
      console.error('Error fetching user input values:', error);
    }
  };
  
  // Save user input values to database
  const saveUserInputValues = async () => {
    try {
      setIsLoading(true);
      
      // Make sure all inputs are valid numbers
      const validatedInputs = {
        ash: parseFloat(userInputValues.ash) || 5.54,
        lapa: parseFloat(userInputValues.lapa) || 2.73,
        uretim_kapasitesi_aylik: parseFloat(userInputValues.uretim_kapasitesi_aylik) || 2800,
        toplam_tuketilen_asit: parseFloat(userInputValues.toplam_tuketilen_asit) || 30000,
        ortalama_uretim_capi: parseFloat(userInputValues.ortalama_uretim_capi) || 3.08,
        paketlemeDkAdet: parseFloat(userInputValues.paketlemeDkAdet) || 10
      };
      
      // Update the state with validated values
      setUserInputValues(validatedInputs);
      
      // Check if the API endpoint URL is defined
      if (API_URLS.galUserInputValues) {
        // Save to database if endpoint exists
        const response = await fetch(API_URLS.galUserInputValues, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(validatedInputs)
        });
        
        if (response.ok) {
          toast.success('Hesaplama deÄŸerleri baÅŸarÄ±yla kaydedildi.');
        } else {
          toast.error('Hesaplama deÄŸerleri kaydedilirken bir hata oluÅŸtu.');
        }
      } else {
        // Just update local state if no endpoint
        toast.success('Hesaplama deÄŸerleri gÃ¼ncellendi.');
      }
      
      // Close the modal
      setShowSettingsModal(false);
      
      // Recalculate recipes with new values if any exist
      if (Object.keys(allRecipes.ymGtRecipe).length > 0 || 
          Object.keys(allRecipes.ymStRecipes).length > 0) {
        calculateAutoRecipeValues();
      }
    } catch (error) {
      console.error('Error saving user input values:', error);
      toast.error('Hesaplama deÄŸerleri kaydedilirken bir hata oluÅŸtu.');
    } finally {
      setIsLoading(false);
    }
  };

  // Cap deÄŸeri deÄŸiÅŸtiÄŸinde DÄ±ÅŸ Ã‡ap'Ä± otomatik hesapla
  useEffect(() => {
    if (mmGtData.cap && mmGtData.ic_cap) {
      const cap = parseFloat(mmGtData.cap) || 0;
      const icCap = parseInt(mmGtData.ic_cap) || 45;
      let disCap;
      
      // Ã‡ap ve iÃ§ Ã§apa gÃ¶re dÄ±ÅŸ Ã§ap hesaplama
      if (icCap === 45) disCap = 75;
      else if (icCap === 50) disCap = 90;
      else if (icCap === 55) disCap = 105;
      else disCap = icCap + (cap * 10); // Genel hesaplama
      
      setMmGtData(prev => ({ ...prev, dis_cap: disCap }));
    }
  }, [mmGtData.cap, mmGtData.ic_cap]);

  // Kod-2 deÄŸiÅŸikliÄŸinde kaplama deÄŸerini gÃ¼ncelle
  useEffect(() => {
    if (mmGtData.kod_2 === 'PAD') {
      setMmGtData(prev => ({ ...prev, kaplama: '50' }));
    }
  }, [mmGtData.kod_2]);

  // Talepleri getir
  const fetchRequests = async () => {
    try {
      setIsLoading(true);
      const response = await fetchWithAuth(`${API_URLS.galSalRequests}?status=pending`);
      if (response && response.ok) {
        const data = await response.json();
        setRequests(Array.isArray(data) ? data : []);
      }
    } catch (error) {
      console.error('Talepler getirilirken hata:', error);
      toast.error('Talepler getirilemedi');
    } finally {
      setIsLoading(false);
    }
  };

  // Mevcut MM GT'leri getir
  const fetchExistingMmGts = async () => {
    try {
      const response = await fetchWithAuth(API_URLS.galMmGt);
      if (response && response.ok) {
        const data = await response.json();
        setExistingMmGts(Array.isArray(data) ? data : []);
      }
    } catch (error) {
      console.error('Mevcut MM GT listesi getirilirken hata:', error);
      toast.error('Mevcut MM GT listesi getirilemedi');
    }
  };

  // Mevcut YM ST'leri getir
  const fetchExistingYmSts = async () => {
    try {
      const response = await fetchWithAuth(API_URLS.galYmSt);
      if (response && response.ok) {
        const data = await response.json();
        setExistingYmSts(Array.isArray(data) ? data : []);
      }
    } catch (error) {
      console.error('Mevcut YM ST listesi getirilirken hata:', error);
      toast.error('Mevcut YM ST listesi getirilemedi');
    }
  };

  // Mevcut reÃ§ete verilerini getir (daha gÃ¼Ã§lÃ¼)
  const fetchExistingRecipes = async (mmGtId, ymGtId, ymStIds) => {
    try {
      setIsLoading(true);
      let statusUpdates = {
        mmGtRecipes: {},
        ymGtRecipe: {},
        ymStRecipes: {}
      };
      
      // MM GT reÃ§etelerini getir
      if (mmGtId) {
        const mmGtRecipeResponse = await fetchWithAuth(`${API_URLS.galMmGtRecete}?mm_gt_id=${mmGtId}`);
        if (mmGtRecipeResponse && mmGtRecipeResponse.ok) {
          const mmGtRecipeData = await mmGtRecipeResponse.json();
          // Parse recipe data
          const parsedMmGtRecipe = {};
          mmGtRecipeData.forEach(item => {
            parsedMmGtRecipe[item.bilesen_kodu] = item.miktar;
            if (!statusUpdates.mmGtRecipes[0]) statusUpdates.mmGtRecipes[0] = {};
            statusUpdates.mmGtRecipes[0][item.bilesen_kodu] = 'database';
          });
          setAllRecipes(prev => ({
            ...prev,
            mmGtRecipes: { ...prev.mmGtRecipes, 0: parsedMmGtRecipe }
          }));
        }
      }
      
      // YM GT reÃ§etesini getir
      if (ymGtId) {
        const ymGtRecipeResponse = await fetchWithAuth(`${API_URLS.galYmGtRecete}?ym_gt_id=${ymGtId}`);
        if (ymGtRecipeResponse && ymGtRecipeResponse.ok) {
          const ymGtRecipeData = await ymGtRecipeResponse.json();
          const parsedYmGtRecipe = {};
          ymGtRecipeData.forEach(item => {
            parsedYmGtRecipe[item.bilesen_kodu] = item.miktar;
            statusUpdates.ymGtRecipe[item.bilesen_kodu] = 'database';
          });
          setAllRecipes(prev => ({
            ...prev,
            ymGtRecipe: parsedYmGtRecipe
          }));
        }
      }
      
      // YM ST reÃ§etelerini getir
      if (ymStIds.length > 0) {
        for (let i = 0; i < ymStIds.length; i++) {
          const ymStId = ymStIds[i];
          const ymStRecipeResponse = await fetchWithAuth(`${API_URLS.galYmStRecete}?ym_st_id=${ymStId}`);
          if (ymStRecipeResponse && ymStRecipeResponse.ok) {
            const ymStRecipeData = await ymStRecipeResponse.json();
            const parsedYmStRecipe = {};
            ymStRecipeData.forEach(item => {
              parsedYmStRecipe[item.bilesen_kodu] = item.miktar;
              if (!statusUpdates.ymStRecipes[i]) statusUpdates.ymStRecipes[i] = {};
              statusUpdates.ymStRecipes[i][item.bilesen_kodu] = 'database';
            });
            setAllRecipes(prev => ({
              ...prev,
              ymStRecipes: { ...prev.ymStRecipes, [i]: parsedYmStRecipe }
            }));
          }
        }
      }
      
      // ReÃ§ete durumlarÄ±nÄ± gÃ¼ncelle
      setRecipeStatus(statusUpdates);
      
    } catch (error) {
      console.error('Mevcut reÃ§eteler getirilirken hata:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // VeritabanÄ±ndan reÃ§ete getir fonksiyonu
  const fetchRecipesFromDatabase = async () => {
    try {
      setIsLoading(true);
      const allYmSts = [...selectedYmSts, ...autoGeneratedYmSts];
      let foundAny = false;
      let statusUpdates = {
        mmGtRecipes: {},
        ymGtRecipe: {},
        ymStRecipes: {}
      };
      
      // Ã–NEMLÄ°: Bu kÄ±sÄ±m sadece mevcut reÃ§eteleri kontrol etmek iÃ§in kullanÄ±lÄ±yor
      // Burada sadece mainYmSt iÃ§in MMGT reÃ§etesi aranmalÄ±
      const mainYmStIndex = 0; // Ana YMST'yi kullan
      
      // Sequence iÃ§in veritabanÄ±nÄ± kontrol et, eÄŸer yeni Ã¼rÃ¼n ise '00'
      let mainSequence = '00';
      for (let i = 0; i < 1; i++) { // Sadece bir kez Ã§alÄ±ÅŸtÄ±r (ana YMST iÃ§in)
        const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
        // EÄŸer yeni Ã¼rÃ¼n deÄŸilse mevcut sequence kullanÄ±lacak
        const mmGtStokKodu = `GT.${mmGtData.kod_2}.${capFormatted}.${mainSequence}`;
        
        // MM GT'yi bul
        const mmGtResponse = await fetchWithAuth(`${API_URLS.galMmGt}?stok_kodu=${encodeURIComponent(mmGtStokKodu)}`);
        if (mmGtResponse && mmGtResponse.ok) {
          const mmGtData = await mmGtResponse.json();
          if (mmGtData.length > 0) {
            const mmGtId = mmGtData[0].id;
            
            // MM GT reÃ§etesini getir
            const mmGtRecipeResponse = await fetchWithAuth(`${API_URLS.galMmGtRecete}?mm_gt_id=${mmGtId}`);
            if (mmGtRecipeResponse && mmGtRecipeResponse.ok) {
              const mmGtRecipeData = await mmGtRecipeResponse.json();
              if (mmGtRecipeData.length > 0) {
                const parsedMmGtRecipe = {};
                mmGtRecipeData.forEach(item => {
                  parsedMmGtRecipe[item.bilesen_kodu] = item.miktar;
                  if (!statusUpdates.mmGtRecipes[i]) statusUpdates.mmGtRecipes[i] = {};
                  statusUpdates.mmGtRecipes[i][item.bilesen_kodu] = 'database';
                });
                setAllRecipes(prev => ({
                  ...prev,
                  mmGtRecipes: { ...prev.mmGtRecipes, [i]: parsedMmGtRecipe }
                }));
                foundAny = true;
              }
            }
          }
        }
      }
      
      // YM GT reÃ§etelerini getir (her sequence iÃ§in)
      for (let i = 0; i < allYmSts.length; i++) {
        const sequence = i.toString().padStart(2, '0');
        const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
        const ymGtStokKodu = `YM.GT.${mmGtData.kod_2}.${capFormatted}.${sequence}`;
        
        // YM GT'yi bul
        const ymGtResponse = await fetchWithAuth(`${API_URLS.galYmGt}?stok_kodu=${encodeURIComponent(ymGtStokKodu)}`);
        if (ymGtResponse && ymGtResponse.ok) {
          const ymGtData = await ymGtResponse.json();
          if (ymGtData.length > 0) {
            const ymGtId = ymGtData[0].id;
            
            // YM GT reÃ§etesini getir
            const ymGtRecipeResponse = await fetchWithAuth(`${API_URLS.galYmGtRecete}?ym_gt_id=${ymGtId}`);
            if (ymGtRecipeResponse && ymGtRecipeResponse.ok) {
              const ymGtRecipeData = await ymGtRecipeResponse.json();
              if (ymGtRecipeData.length > 0) {
                const parsedYmGtRecipe = {};
                ymGtRecipeData.forEach(item => {
                  // YM ST baÄŸlantÄ±sÄ±nÄ± sequence'e gÃ¶re gÃ¼ncelle
                  if (item.bilesen_kodu.includes('YM.ST.')) {
                    parsedYmGtRecipe[allYmSts[i].stok_kodu] = item.miktar;
                    statusUpdates.ymGtRecipe[allYmSts[i].stok_kodu] = 'database';
                  } else {
                    parsedYmGtRecipe[item.bilesen_kodu] = item.miktar;
                    statusUpdates.ymGtRecipe[item.bilesen_kodu] = 'database';
                  }
                });
                setAllRecipes(prev => ({
                  ...prev,
                  ymGtRecipe: parsedYmGtRecipe
                }));
                foundAny = true;
              }
            }
          }
        }
      }
      
      // YM ST reÃ§etelerini getir
      for (let i = 0; i < allYmSts.length; i++) {
        const ymSt = allYmSts[i];
        
        // YM ST'yi bul
        let ymStResponse;
        if (ymSt.id) {
          // VeritabanÄ±ndan seÃ§ilmiÅŸ YM ST
          ymStResponse = await fetchWithAuth(`${API_URLS.galYmSt}/${ymSt.id}`);
        } else {
          // Otomatik oluÅŸturulmuÅŸ YM ST iÃ§in stok koduna gÃ¶re ara
          ymStResponse = await fetchWithAuth(`${API_URLS.galYmSt}?stok_kodu=${encodeURIComponent(ymSt.stok_kodu)}`);
        }
        
        if (ymStResponse && ymStResponse.ok) {
          let ymStData = await ymStResponse.json();
          if (Array.isArray(ymStData)) ymStData = ymStData[0];
          
          if (ymStData && ymStData.id) {
            // YM ST reÃ§etesini getir
            const ymStRecipeResponse = await fetchWithAuth(`${API_URLS.galYmStRecete}?ym_st_id=${ymStData.id}`);
            if (ymStRecipeResponse && ymStRecipeResponse.ok) {
              const ymStRecipeData = await ymStRecipeResponse.json();
              if (ymStRecipeData.length > 0) {
                const parsedYmStRecipe = {};
                ymStRecipeData.forEach(item => {
                  parsedYmStRecipe[item.bilesen_kodu] = item.miktar;
                  if (!statusUpdates.ymStRecipes[i]) statusUpdates.ymStRecipes[i] = {};
                  statusUpdates.ymStRecipes[i][item.bilesen_kodu] = 'database';
                });
                setAllRecipes(prev => ({
                  ...prev,
                  ymStRecipes: { ...prev.ymStRecipes, [i]: parsedYmStRecipe }
                }));
                foundAny = true;
              }
            }
          }
        }
      }
      
      // ReÃ§ete durumlarÄ±nÄ± gÃ¼ncelle
      setRecipeStatus(statusUpdates);
      
      if (!foundAny) {
        toast.info('VeritabanÄ±nda eÅŸleÅŸen reÃ§ete bulunamadÄ±');
        // AlanlarÄ± temizle
        setAllRecipes({
          mmGtRecipes: {},
          ymGtRecipe: {},
          ymStRecipes: {}
        });
        setRecipeStatus({
          mmGtRecipes: {},
          ymGtRecipe: {},
          ymStRecipes: {}
        });
      } else {
        toast.success('VeritabanÄ±ndan reÃ§eteler baÅŸarÄ±yla getirildi');
      }
    } catch (error) {
      console.error('VeritabanÄ±ndan reÃ§ete getirme hatasÄ±:', error);
      toast.error('VeritabanÄ±ndan reÃ§ete getirme hatasÄ±: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  // Talep sil fonksiyonu
  const deleteRequest = async (requestId) => {
    try {
      setIsLoading(true);
      const response = await fetchWithAuth(`${API_URLS.galSalRequests}/${requestId}`, {
        method: 'DELETE'
      });
      
      if (response && response.ok) {
        toast.success('Talep baÅŸarÄ±yla silindi');
        fetchRequests(); // Listeyi yenile
      } else {
        toast.error('Talep silinirken hata oluÅŸtu');
      }
    } catch (error) {
      console.error('Talep silme hatasÄ±:', error);
      toast.error('Talep silme hatasÄ±: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  // MM GT silme fonksiyonu - Ä°yileÅŸtirilmiÅŸ hata yÃ¶netimi
  const deleteMmGt = async (mmGt) => {
    try {
      setIsLoading(true);
      
      // Sequential MM GT'leri bul ve sil
      const baseCode = mmGt.stok_kodu.substring(0, mmGt.stok_kodu.lastIndexOf('.'));
      const existingMmGts = await fetchWithAuth(`${API_URLS.galMmGt}?stok_kodu_like=${encodeURIComponent(baseCode)}`);
      
      let mmGtIdsToDelete = [];
      if (existingMmGts && existingMmGts.ok) {
        const mmGtList = await existingMmGts.json();
        mmGtIdsToDelete = mmGtList.map(item => item.id);
      }
      
      // Her MM GT iÃ§in baÄŸlantÄ±lÄ± verileri sil
      for (const mmGtId of mmGtIdsToDelete) {
        // MM GT reÃ§etelerini sil
        try {
          const mmGtRecipes = await fetchWithAuth(`${API_URLS.galMmGtRecete}?mm_gt_id=${mmGtId}`);
          if (mmGtRecipes && mmGtRecipes.ok) {
            const recipes = await mmGtRecipes.json();
            for (const recipe of recipes) {
              await fetchWithAuth(`${API_URLS.galMmGtRecete}/${recipe.id}`, { method: 'DELETE' });
            }
          }
        } catch (error) {
          console.log('MM GT reÃ§etesi bulunamadÄ± veya silinirken hata:', error);
        }
        
        // MM GT-YM ST iliÅŸkilerini sil
        try {
          const mmGtYmStRelations = await fetchWithAuth(`${API_URLS.galMmGtYmSt}?mm_gt_id=${mmGtId}`);
          if (mmGtYmStRelations && mmGtYmStRelations.ok) {
            const relations = await mmGtYmStRelations.json();
            for (const relation of relations) {
              await fetchWithAuth(`${API_URLS.galMmGtYmSt}/${relation.id}`, { method: 'DELETE' });
            }
          }
        } catch (error) {
          console.log('MM GT-YM ST iliÅŸkisi bulunamadÄ± veya silinirken hata:', error);
        }
        
        // MM GT'yi sil
        await fetchWithAuth(`${API_URLS.galMmGt}/${mmGtId}`, { method: 'DELETE' });
      }
      
      // Ä°liÅŸkili YM GT'leri bul ve sil
      const ymGtBaseCode = baseCode.replace('GT.', 'YM.GT.');
      try {
        const existingYmGts = await fetchWithAuth(`${API_URLS.galYmGt}?stok_kodu_like=${encodeURIComponent(ymGtBaseCode)}`);
        
        if (existingYmGts && existingYmGts.ok) {
          const ymGtList = await existingYmGts.json();
          for (const ymGt of ymGtList) {
            // YM GT reÃ§etelerini sil
            try {
              const ymGtRecipes = await fetchWithAuth(`${API_URLS.galYmGtRecete}?ym_gt_id=${ymGt.id}`);
              if (ymGtRecipes && ymGtRecipes.ok) {
                const recipes = await ymGtRecipes.json();
                for (const recipe of recipes) {
                  await fetchWithAuth(`${API_URLS.galYmGtRecete}/${recipe.id}`, { method: 'DELETE' });
                }
              }
            } catch (error) {
              console.log('YM GT reÃ§etesi bulunamadÄ± veya silinirken hata:', error);
            }
            
            // YM GT'yi sil
            await fetchWithAuth(`${API_URLS.galYmGt}/${ymGt.id}`, { method: 'DELETE' });
          }
        }
      } catch (error) {
        console.log('YM GT bulunamadÄ± veya silinirken hata:', error);
      }
      
      // Listeyi yenile
      await fetchExistingMmGts();
      
      setShowDeleteConfirm(false);
      setItemToDelete(null);
      toast.success('MM GT ve baÄŸlÄ± veriler baÅŸarÄ±yla silindi');
    } catch (error) {
      console.error('MM GT silme hatasÄ±:', error);
      toast.error('MM GT silme hatasÄ±: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  // YMST silme fonksiyonu
  const deleteYmSt = async (ymSt) => {
    try {
      setIsLoading(true);
      
      // YMST reÃ§etelerini sil
      try {
        const ymStRecipes = await fetchWithAuth(`${API_URLS.galYmStRecete}?ym_st_id=${ymSt.id}`);
        if (ymStRecipes && ymStRecipes.ok) {
          const recipes = await ymStRecipes.json();
          for (const recipe of recipes) {
            await fetchWithAuth(`${API_URLS.galYmStRecete}/${recipe.id}`, { method: 'DELETE' });
          }
        }
      } catch (error) {
        console.log('YM ST reÃ§etesi bulunamadÄ± veya silinirken hata:', error);
      }
      
      // YMST'yi sil
      await fetchWithAuth(`${API_URLS.galYmSt}/${ymSt.id}`, { method: 'DELETE' });
      
      // Listeyi yenile
      await fetchExistingYmSts();
      
      setShowDeleteConfirm(false);
      setItemToDelete(null);
      toast.success('YM ST ve baÄŸlÄ± veriler baÅŸarÄ±yla silindi');
    } catch (error) {
      console.error('YM ST silme hatasÄ±:', error);
      toast.error('YM ST silme hatasÄ±: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  // Silme onayÄ± aÃ§
  const handleDeleteClick = (item, type) => {
    setItemToDelete(item);
    setDeleteType(type);
    setShowDeleteConfirm(true);
  };

  // Silme onayÄ± kapat
  const handleDeleteCancel = () => {
    setShowDeleteConfirm(false);
    setItemToDelete(null);
    setDeleteType('mmgt');
  };

  // Talep seÃ§imi
  const handleSelectRequest = (request) => {
    setSelectedRequest(request);
    setIsRequestUsed(true); // Talep kullanÄ±ldÄ± olarak iÅŸaretle
    // Use normalized decimal display for all numeric values to ensure points not commas
    setMmGtData({
      cap: request.cap ? normalizeDecimalDisplay(request.cap) : '',
      kod_2: request.kod_2 || 'NIT',
      kaplama: request.kaplama ? normalizeDecimalDisplay(request.kaplama) : '',
      min_mukavemet: request.min_mukavemet ? normalizeDecimalDisplay(request.min_mukavemet) : '',
      max_mukavemet: request.max_mukavemet ? normalizeDecimalDisplay(request.max_mukavemet) : '',
      kg: request.kg ? normalizeDecimalDisplay(request.kg) : '',
      ic_cap: request.ic_cap || 45,
      dis_cap: request.dis_cap || 75,
      tolerans_plus: request.tolerans_plus ? normalizeDecimalDisplay(request.tolerans_plus) : '',
      tolerans_minus: request.tolerans_minus ? normalizeDecimalDisplay(request.tolerans_minus) : '',
      shrink: request.shrink || 'evet',
      unwinding: request.unwinding || '',
      cast_kont: '',
      helix_kont: '',
      elongation: ''
    });
    setShowRequestsModal(false);
    setCurrentStep('summary');
    generateYmGtData();
    findSuitableYmSts();
  };

  // Mevcut MM GT seÃ§imi
  const handleSelectExistingMmGt = async (mmGt) => {
    setSelectedExistingMmGt(mmGt);
    // Use normalized decimal display for numeric values to ensure points not commas
    setMmGtData({
      cap: mmGt.cap ? normalizeDecimalDisplay(mmGt.cap) : '',
      kod_2: mmGt.kod_2 || 'NIT',
      kaplama: mmGt.kaplama ? normalizeDecimalDisplay(mmGt.kaplama) : '',
      min_mukavemet: mmGt.min_mukavemet ? normalizeDecimalDisplay(mmGt.min_mukavemet) : '',
      max_mukavemet: mmGt.max_mukavemet ? normalizeDecimalDisplay(mmGt.max_mukavemet) : '',
      kg: mmGt.kg ? normalizeDecimalDisplay(mmGt.kg) : '',
      ic_cap: mmGt.ic_cap || 45,
      dis_cap: mmGt.dis_cap || 75,
      tolerans_plus: mmGt.tolerans_plus ? normalizeDecimalDisplay(mmGt.tolerans_plus) : '',
      tolerans_minus: mmGt.tolerans_minus ? normalizeDecimalDisplay(mmGt.tolerans_minus) : '',
      shrink: mmGt.shrink || 'evet',
      unwinding: mmGt.unwinding || '',
      cast_kont: mmGt.cast_kont || '',
      helix_kont: mmGt.helix_kont || '',
      elongation: mmGt.elongation || ''
    });
    setShowExistingMmGtModal(false);
    setCurrentStep('summary');
    generateYmGtData();
    findSuitableYmSts();
    
    // Mevcut reÃ§eteleri getir
    const ymGtId = mmGt.ym_gt_id; // EÄŸer MM GT ile baÄŸlantÄ±lÄ± YM GT varsa
    const ymStIds = []; // MM GT ile baÄŸlantÄ±lÄ± YM ST'leri getir
    if (mmGt.id) {
      await fetchExistingRecipes(mmGt.id, ymGtId, ymStIds);
    }
  };

  // YM GT verilerini otomatik oluÅŸtur
  const generateYmGtData = () => {
    if (!mmGtData.cap) return;
    
    // Ã‡ap formatÄ±nÄ± dÃ¼zelt: 2.50 -> 0250 (tam 4 karakter)
    const capValue = parseFloat(mmGtData.cap);
    const capFormatted = Math.round(capValue * 100).toString().padStart(4, '0');
    const sequence = '00'; // Ä°lk YM GT iÃ§in
    
    const ymGt = {
      stok_kodu: `YM.GT.${mmGtData.kod_2}.${capFormatted}.${sequence}`,
      stok_adi: `YM Galvanizli Tel ${capValue.toFixed(2)} mm -${Math.abs(parseFloat(mmGtData.tolerans_minus || 0)).toFixed(2)}/+${parseFloat(mmGtData.tolerans_plus || 0).toFixed(2)} ${mmGtData.kaplama || '0'} gr/mÂ²${mmGtData.min_mukavemet || '0'}-${mmGtData.max_mukavemet || '0'} MPa ID:${mmGtData.ic_cap || '45'} cm OD:${mmGtData.dis_cap || '75'} cm ${mmGtData.kg || '0'} kg`,
      cap: capValue,
      kod_2: mmGtData.kod_2,
      kaplama: parseInt(mmGtData.kaplama) || 0,
      min_mukavemet: parseInt(mmGtData.min_mukavemet) || 0,
      max_mukavemet: parseInt(mmGtData.max_mukavemet) || 0,
      kg: parseInt(mmGtData.kg) || 0,
      ic_cap: mmGtData.ic_cap,
      dis_cap: mmGtData.dis_cap,
      tolerans_plus: parseFloat(mmGtData.tolerans_plus) || 0,
      tolerans_minus: parseFloat(mmGtData.tolerans_minus) || 0,
      shrink: mmGtData.shrink,
      unwinding: mmGtData.unwinding
    };
    
    setYmGtData(ymGt);
  };

  // Uygun YM ST'leri bul - yeniden arama yapma fonksiyonu
  const findSuitableYmSts = async () => {
    try {
      setIsLoading(true);
      const response = await fetchWithAuth(API_URLS.galYmSt);
      if (response && response.ok) {
        const allYmSts = await response.json();
        const cap = parseFloat(mmGtData.cap) || 0;
        let filtered = [];
        
        if (Array.isArray(allYmSts)) {
          // Ã–nce tam eÅŸleÅŸme olup olmadÄ±ÄŸÄ±nÄ± kontrol et
          const exactMatch = allYmSts.find(ymSt => {
            const ymStCap = parseFloat(ymSt.cap) || 0;
            return Math.abs(ymStCap - cap) < 0.01; // Tam eÅŸleÅŸme iÃ§in tolerance
          });
          
          if (exactMatch) {
            filtered.push(exactMatch);
          }
          
          // ArdÄ±ndan geniÅŸ aralÄ±kta filtrele
          if (mmGtData.kod_2 === 'PAD') {
            // PAD iÃ§in Ã§ap aralÄ±ÄŸÄ± kriterlerine gÃ¶re filtrele
            if (cap >= 0.12 && cap <= 0.14) {
              const rangeFilter = allYmSts.filter(ymSt => {
                const ymStCap = parseFloat(ymSt.cap) || 0;
                return ymStCap >= 0.12 && ymStCap <= 0.14 && !filtered.includes(ymSt);
              });
              filtered = [...filtered, ...rangeFilter];
            } else if (cap >= 0.15 && cap <= 2.55) {
              const rangeFilter = allYmSts.filter(ymSt => {
                const ymStCap = parseFloat(ymSt.cap) || 0;
                return ymStCap >= 0.15 && ymStCap <= 2.55 && !filtered.includes(ymSt);
              });
              filtered = [...filtered, ...rangeFilter];
            } else if (cap >= 2.60 && cap <= 4.25) {
              const rangeFilter = allYmSts.filter(ymSt => {
                const ymStCap = parseFloat(ymSt.cap) || 0;
                return ymStCap >= 2.60 && ymStCap <= 4.25 && !filtered.includes(ymSt);
              });
              filtered = [...filtered, ...rangeFilter];
            } else if (cap >= 4.30 && cap <= 5.90) {
              const rangeFilter = allYmSts.filter(ymSt => {
                const ymStCap = parseFloat(ymSt.cap) || 0;
                return ymStCap >= 4.30 && ymStCap <= 5.90 && !filtered.includes(ymSt);
              });
              filtered = [...filtered, ...rangeFilter];
            } else if (cap >= 6.00 && cap <= 7.00) {
              const rangeFilter = allYmSts.filter(ymSt => {
                const ymStCap = parseFloat(ymSt.cap) || 0;
                return ymStCap >= 6.00 && ymStCap <= 7.00 && !filtered.includes(ymSt);
              });
              filtered = [...filtered, ...rangeFilter];
            } else if (cap >= 7.30 && cap <= 7.40) {
              const rangeFilter = allYmSts.filter(ymSt => {
                const ymStCap = parseFloat(ymSt.cap) || 0;
                return ymStCap >= 7.30 && ymStCap <= 7.40 && !filtered.includes(ymSt);
              });
              filtered = [...filtered, ...rangeFilter];
            } else if (cap >= 7.70 && cap <= 8.00) {
              const rangeFilter = allYmSts.filter(ymSt => {
                const ymStCap = parseFloat(ymSt.cap) || 0;
                return ymStCap >= 7.70 && ymStCap <= 8.00 && !filtered.includes(ymSt);
              });
              filtered = [...filtered, ...rangeFilter];
            }
          } else if (mmGtData.kod_2 === 'NIT') {
            // NIT iÃ§in hesaplanan Ã§ap aralÄ±ÄŸÄ±na gÃ¶re filtrele (prompt'ta belirtilen formÃ¼llerle)
            const minYmStCap = cap * 0.935; // %6.5 azalma
            const maxYmStCap = cap * 0.995; // %0.5 azalma
            const rangeFilter = allYmSts.filter(ymSt => {
              const ymStCap = parseFloat(ymSt.cap) || 0;
              return ymStCap >= minYmStCap && ymStCap <= maxYmStCap && !filtered.includes(ymSt);
            });
            filtered = [...filtered, ...rangeFilter];
          }
          
          // En yakÄ±n 5 Ã¼rÃ¼nle sÄ±nÄ±rla
          filtered = filtered.slice(0, 5);
        }
        
        setSuitableYmSts(filtered);
      }
    } catch (error) {
      console.error('YM ST listesi getirilirken hata:', error);
      toast.error('YM ST listesi getirilemedi');
    } finally {
      setIsLoading(false);
    }
  };

  // Otomatik YM ST oluÅŸtur - 2 farklÄ± adet (dÃ¼zeltildi)
  const generateAutoYmSts = () => {
    const cap = parseFloat(mmGtData.cap) || 0;
    const autoYmSts = [];
    
    if (mmGtData.kod_2 === 'PAD') {
      // PAD iÃ§in otomatik YM ST oluÅŸtur - 2 farklÄ± versiyonla
      const baseAdjustedCap = cap; // PAD iÃ§in Ã§ap ayarlamasÄ± yok
      const filmasinCap = getFilmasinForCap(cap);
      const quality = getQualityForCap(cap);
      
      // Ä°lk YM ST - Tam Ã¶lÃ§Ã¼
      const capStr1 = Math.round(baseAdjustedCap * 100).toString().padStart(4, '0');
      autoYmSts.push({
        stok_kodu: `YM.ST.${capStr1}.${filmasinCap}.${quality}`,
        stok_adi: `YM Siyah Tel ${capStr1} mm HM:${filmasinCap}.${quality}`,
        cap: baseAdjustedCap,
        filmasin: parseInt(filmasinCap),
        quality: quality,
        source: 'auto-generated'
      });
      
      // Ä°kinci YM ST - Alternatif Ã¶lÃ§Ã¼ (%1 azaltÄ±lmÄ±ÅŸ)
      const alternativeCap = baseAdjustedCap * 0.99;
      // Format to 2 decimals for display
      const alternativeCapFormatted = Number(alternativeCap.toFixed(2));
      const capStr2 = Math.round(alternativeCapFormatted * 100).toString().padStart(4, '0');
      autoYmSts.push({
        stok_kodu: `YM.ST.${capStr2}.${filmasinCap}.${quality}`,
        stok_adi: `YM Siyah Tel ${alternativeCapFormatted.toFixed(2)} mm HM:${filmasinCap}.${quality}`,
        cap: alternativeCapFormatted,
        filmasin: parseInt(filmasinCap),
        quality: quality,
        source: 'auto-generated'
      });
    } else if (mmGtData.kod_2 === 'NIT') {
      // NIT iÃ§in otomatik YM ST oluÅŸtur - 2 farklÄ± versiyonla
      const baseAdjustedCap = cap * 0.96; // NIT iÃ§in %4 azaltma
      // Format to 2 decimals for display
      const baseAdjustedCapFormatted = Number(baseAdjustedCap.toFixed(2));
      const filmasinCap = getFilmasinForCap(baseAdjustedCapFormatted);
      const quality = getQualityForCap(baseAdjustedCapFormatted);
      
      // Ä°lk YM ST
      const capStr1 = Math.round(baseAdjustedCapFormatted * 100).toString().padStart(4, '0');
      autoYmSts.push({
        stok_kodu: `YM.ST.${capStr1}.${filmasinCap}.${quality}`,
        stok_adi: `YM Siyah Tel ${baseAdjustedCapFormatted.toFixed(2)} mm HM:${filmasinCap}.${quality}`,
        cap: baseAdjustedCapFormatted,
        filmasin: parseInt(filmasinCap),
        quality: quality,
        source: 'auto-generated'
      });
      
      // Ä°kinci YM ST - FarklÄ± variant
      const alternativeCap = cap * 0.94; // Daha fazla azaltma
      // Format to 2 decimals for display
      const alternativeCapFormatted = Number(alternativeCap.toFixed(2));
      const capStr2 = Math.round(alternativeCapFormatted * 100).toString().padStart(4, '0');
      autoYmSts.push({
        stok_kodu: `YM.ST.${capStr2}.${filmasinCap}.${quality}`,
        stok_adi: `YM Siyah Tel ${alternativeCapFormatted.toFixed(2)} mm HM:${filmasinCap}.${quality}`,
        cap: alternativeCapFormatted,
        filmasin: parseInt(filmasinCap),
        quality: quality,
        source: 'auto-generated'
      });
    }
    
    setAutoGeneratedYmSts(autoYmSts);
    
    // If this is the first time we're adding YMSTs and there are none selected yet,
    // auto-set the first auto-generated YMST as the main one
    const totalYmSts = selectedYmSts.length + autoYmSts.length;
    if (totalYmSts > 0 && selectedYmSts.length === 0 && autoYmSts.length > 0) {
      setMainYmStIndex(0);
    }
    
    // Otomatik oluÅŸturulan YM ST'ler iÃ§in reÃ§eteleri hesapla
    setTimeout(() => {
      calculateAutoRecipeValues();
    }, 100);
  };

  // Ã‡ap deÄŸerine gÃ¶re filmaÅŸin seÃ§
  const getFilmasinForCap = (cap) => {
    if (cap < 2.0) return '0550';
    if (cap >= 2.0 && cap < 3.0) return '0600';
    if (cap >= 3.0 && cap < 4.5) return '0600';
    if (cap >= 4.5 && cap < 6.0) return '0700';
    if (cap >= 6.0 && cap < 7.5) return '0800';
    return '1000';
  };

  // Ã‡ap deÄŸerine gÃ¶re kalite seÃ§
  const getQualityForCap = (cap) => {
    if (cap < 2.0) return '1006';
    if (cap >= 2.0 && cap < 3.0) return '1006';
    if (cap >= 3.0 && cap < 4.5) return '1008';
    if (cap >= 4.5 && cap < 6.0) return '1010';
    if (cap >= 6.0 && cap < 7.5) return '1010';
    return '1010';
  };

  // Otomatik reÃ§ete deÄŸerlerini hesapla - NOKTA kullan
  const calculateAutoRecipeValues = () => {
    if (!mmGtData.kg || !mmGtData.cap) return;
    
    // DÃœZELTME: mmGtSequence deÄŸiÅŸkenini tanÄ±mla
    const sequence = '00'; // Default sequence
    
    const cap = parseFloat(mmGtData.cap) || 0;
    const kg = parseFloat(mmGtData.kg) || 0;
    const kaplama = parseInt(mmGtData.kaplama) || 0;
    const allYmSts = [...selectedYmSts, ...autoGeneratedYmSts];
    
    // TÃ¼m YM ST'ler iÃ§in reÃ§eteler hesapla
    const newMmGtRecipes = {};
    const newYmStRecipes = {};
    let newYmGtRecipe = {};
    
    // ReÃ§ete durumlarÄ±nÄ± gÃ¼ncelle
    const newRecipeStatus = {
      mmGtRecipes: {},
      ymGtRecipe: {},
      ymStRecipes: {}
    };
    
    // Her YM ST iÃ§in sequence deÄŸer hesapla
    allYmSts.forEach((ymSt, index) => {
      const sequence = index.toString().padStart(2, '0');
      const capFormatted = Math.round(cap * 100).toString().padStart(4, '0');
      
      // MM GT ReÃ§ete - her MM GT iÃ§in
      // DÃœZELTME: YMGT kod oluÅŸtur - sequence parametresini kullan
      let correctYmGtStokKodu = `YM.GT.${mmGtData.kod_2}.${capFormatted}.${sequence}`;
      console.log(`ðŸ”„ MMGT reÃ§etesi iÃ§in YMGT kodu oluÅŸturuluyor: ${correctYmGtStokKodu}`);
      
      // Shrink tipi ve miktarÄ±nÄ± otomatik belirle
      const shrinkCode = getShrinkCode(mmGtData.ic_cap);
      const shrinkAmount = calculateShrinkAmount(kg);
      
      // Updated formulas based on GalvanizliFormulas.txt
      // NAYLON (KG/TON): =(1*(1000/'COIL WEIGHT (KG)'))/1000
      const naylonValue = parseFloat(((1 * (1000 / kg)) / 1000).toFixed(5));
      
      // AMB.APEX CEMBER 38X080: =(1.2*(1000/'COIL WEIGHT (KG)'))/1000
      const cemberValue = parseFloat(((1.2 * (1000 / kg)) / 1000).toFixed(5));
      
      // AMB.TOKA.SIGNODE.114P. DKP: =(4*(1000/'COIL WEIGHT (KG)'))/1000
      const tokaValue = parseFloat(((4 * (1000 / kg)) / 1000).toFixed(5));
      
      // SM.7MMHALKA: =(4*(1000/'COIL WEIGHT (KG)'))/1000
      const halkaValue = parseFloat(((4 * (1000 / kg)) / 1000).toFixed(5));
      
      // AMB.Ã‡EM.KARTON.GAL: (8*(1000/'COIL WEIGHT (KG)'))/1000
      const kartonValue = parseFloat(((8 * (1000 / kg)) / 1000).toFixed(5));
      
      // GTPKT01: =(1000/'COIL WEIGHT (KG)'*'PaketlemeDkAdet')/1000
      const gtpktValue = parseFloat(((1000 / kg * userInputValues.paketlemeDkAdet) / 1000).toFixed(5));
      
      // SM.DESÄ°.PAK = 0.1231* AMB.Ã‡EM.KARTON.GAL + 0.0154* shrink deÄŸeri
      const desiValue = parseFloat((0.1231 * kartonValue + 0.0154 * shrinkAmount).toFixed(5));
      
      newMmGtRecipes[index] = {
        [correctYmGtStokKodu]: 1, // YM GT bileÅŸeni - MMGT ile aynÄ± sequence kullanÄ±lmalÄ±
        'GTPKT01': gtpktValue,
        // Naylon yerine sadece shrinkCode kullanÄ±lÄ±yor - shrink kapsamÄ±na giriyor
        'AMB.Ã‡EM.KARTON.GAL': kartonValue,
        [shrinkCode]: shrinkAmount, // Otomatik shrink tipi ve miktarÄ±
        'SM.7MMHALKA': halkaValue,
        'AMB.APEX CEMBER 38X080': cemberValue,
        'AMB.TOKA.SIGNODE.114P. DKP': tokaValue,
        'SM.DESÄ°.PAK': desiValue
      };
      
      // ReÃ§ete durumlarÄ±nÄ± 'auto' olarak iÅŸaretle
      newRecipeStatus.mmGtRecipes[index] = {};
      Object.keys(newMmGtRecipes[index]).forEach(key => {
        newRecipeStatus.mmGtRecipes[index][key] = 'auto';
      });
      
      // YM ST ReÃ§ete
      const ymStCap = parseFloat(ymSt.cap) || cap;
      const filmasinKodu = getFilmasinKodu(ymSt);
      
      // Extract HM_Cap from filmasinKodu (e.g., "FLM.0800.1010" -> 8)
      const hmCapMatch = filmasinKodu.match(/FLM\.0*(\d+)\./);
      const hmCap = hmCapMatch ? parseFloat(hmCapMatch[1]) / 100 : 6; // Default to 6 if not found
      
      // Calculate TLC_Hiz using the lookup table with the DÃœÅžEYARA formula
      // TLC_Hiz= =DÃœÅžEYARA(BÄ°RLEÅžTÄ°R(HM_Cap;"x"; Ã‡ap);'TLC_HÄ±zlar'!C:F;4;YANLIÅž)*0.7
      const tlcHiz = calculateTlcHiz(hmCap, ymStCap);
      
      // Calculate TLC01 using the formula: TLC01 = 1000*4000/3.14/7.85/Cap/Cap/TLC_Hiz/60
      const tlcValue = parseFloat((1000 * 4000 / Math.PI / 7.85 / ymStCap / ymStCap / tlcHiz / 60).toFixed(5));
      
      newYmStRecipes[index] = {
        [filmasinKodu]: 1, // Use the FilmaÅŸin code directly
        'TLC01': tlcValue
      };
      
      // YM ST reÃ§ete durumlarÄ±nÄ± 'auto' olarak iÅŸaretle
      newRecipeStatus.ymStRecipes[index] = {};
      Object.keys(newYmStRecipes[index]).forEach(key => {
        newRecipeStatus.ymStRecipes[index][key] = 'auto';
      });
    });
    
    // YM GT ReÃ§ete (sequence 00 iÃ§in)
    if (allYmSts.length > 0) {
      // Calculate DV (Durdurma VinÃ§) value based on Min Mukavemet
      const dvValue = calculateDV(parseInt(mmGtData.min_mukavemet));
      
      // GLV01:= =1000*4000/ Ã‡ap/ Ã‡ap /PI()/7.85/'DV'* Ã‡ap
      // Convert to minutes by dividing by 1000 and 60 (result is in DK)
      const glvTime = parseFloat(((1000 * 4000 / cap / cap / Math.PI / 7.85 / dvValue * cap) / 1000 / 60).toFixed(5));
      
      // 150 03(Ã‡inko) : =((1000*4000/3.14/7.85/'DIA (MM)'/'DIA (MM)'*'DIA (MM)'*3.14/1000*'ZING COATING (GR/M2)'/1000)+('Ash'*0.6)+('Lapa'*0.7))/1000
      const zincConsumption = parseFloat((
        ((1000 * 4000 / Math.PI / 7.85 / cap / cap * cap * Math.PI / 1000 * kaplama / 1000) + 
        (userInputValues.ash * 0.6) + 
        (userInputValues.lapa * 0.7)) / 1000
      ).toFixed(5));
      
      // SM.HÄ°DROLÄ°K.ASÄ°T: =('YuzeyAlani'*'tuketilenAsit')/1000
      const yuzeyAlani = calculateYuzeyAlani(cap);
      const tuketilenAsit = calculateTuketilenAsit();
      const acidConsumption = parseFloat(((yuzeyAlani * tuketilenAsit) / 1000).toFixed(5));
      
      newYmGtRecipe = {
        [allYmSts[0].stok_kodu]: 1, // Ä°lk YM ST
        'GLV01': glvTime,
        '150 03': zincConsumption,
        'SM.HÄ°DROLÄ°K.ASÄ°T': acidConsumption
      };
      
      // YM GT reÃ§ete durumlarÄ±nÄ± 'auto' olarak iÅŸaretle
      Object.keys(newYmGtRecipe).forEach(key => {
        newRecipeStatus.ymGtRecipe[key] = 'auto';
      });
    }
    
    setAllRecipes(prev => ({
      ...prev,
      mmGtRecipes: newMmGtRecipes,
      ymGtRecipe: newYmGtRecipe,
      ymStRecipes: newYmStRecipes
    }));
    
    setRecipeStatus(prev => ({
      ...prev,
      ...newRecipeStatus
    }));
  };

  // Shrink miktarÄ± hesapla - NOKTA deÄŸer dÃ¶ndÃ¼r with 5 decimals - Excel ile tam uyumlu
  const calculateShrinkAmount = (kg) => {
    // Calculate with full precision, then format to 5 decimal places to match Excel
    const result = 1 / kg;
    return parseFloat(result.toFixed(5));
  };

  // Asit tÃ¼ketimi hesaplama (Excel formÃ¼lÃ¼) - NOKTA deÄŸer dÃ¶ndÃ¼r with 5 decimals - Excel ile tam uyumlu
  const calculateAcidConsumption = (cap, kg, kaplama) => {
    const yuzeyAlani = 1000 * 4000 / Math.PI / cap / cap / 7.85 * cap * Math.PI / 1000;
    const tuketilenAsit = 0.0647625; // kg/m2 - match Excel formula exactly
    
    // Calculate with full precision, then format to 5 decimal places to match Excel
    const result = (yuzeyAlani * tuketilenAsit) / 1000;
    return parseFloat(result.toFixed(5));
  };

  // Desi tÃ¼ketimi hesapla (formÃ¼le gÃ¶re) - NOKTA deÄŸer dÃ¶ndÃ¼r with 5 decimals - Excel ile tam uyumlu
  const calculateDesiConsumption = (kg, cap) => {
    // Return values with 5 decimal places for consistency with Excel
    // Ã–nce kg kategorisine gÃ¶re
    if (kg >= 500 && kg < 600) return 0.00200;
    if (kg >= 600 && kg < 650) return 0.00170;
    if (kg >= 650 && kg < 750) return 0.00150;
    if (kg >= 750 && kg <= 800) return 0.00130;
    if (kg > 800 && kg < 850) return 0.00120;
    if (kg >= 850 && kg < 900) return 0.00110;
    if (kg >= 900) return 0.00090;
    
    // Ã‡apa gÃ¶re fallback
    if (cap < 2.0) return 0.00200;
    if (cap >= 2.0 && cap <= 4.0) return 0.00130;
    return 0.00110;
  };

  // Shrink kodu belirle (tam kod ile)
  const getShrinkCode = (icCap) => {
    switch (parseInt(icCap)) {
      case 45: return 'AMB.SHRÄ°NK.200*140CM';
      case 50: return 'AMB.SHRÄ°NK.200*160CM';
      case 55: return 'AMB.SHRÄ°NK.200*190CM';
      default: return 'AMB.SHRÄ°NK.200*140CM';
    }
  };

  // GÃ¼mrÃ¼k Tarife Kodu belirle
  const getGumrukTarifeKodu = () => {
    const cap = parseFloat(mmGtData.cap) || 0;
    if (cap >= 0.8 && cap < 1.5) return '721720300011';
    if (cap >= 1.5 && cap < 6.0) return '721720300012';
    return '721720300013';
  };

  // Form deÄŸiÅŸikliklerini iÅŸle - her zaman nokta formatÄ± kullan
  // Comma to point conversion handler for onKeyDown
  const handleCommaToPoint = (e, field) => {
    // Allow decimal comma input but convert to point
    if (e.key === ',') {
      e.preventDefault();
      // Get current value and caret position
      const input = e.target;
      const currentValue = input.value;
      const caretPos = input.selectionStart;
      
      // Insert decimal point where the comma would have gone
      const newValue = currentValue.substring(0, caretPos) + '.' + currentValue.substring(input.selectionEnd);
      
      // Update input value and reset caret position
      handleInputChange(field, newValue);
      // Need to use setTimeout to let React update the DOM
      setTimeout(() => {
        input.selectionStart = input.selectionEnd = caretPos + 1;
      }, 0);
    }
    
    // Ensure periods can be entered anywhere in the input
    if (e.key === '.') {
      // Allow periods even if the field already has one
      // Do nothing special, let the default behavior proceed
    }
  };
  
  // Comma to point conversion handler for recipe inputs
  const handleRecipeCommaToPoint = (e, recipeType, ymStIndex, key) => {
    // Allow decimal comma input but convert to point
    if (e.key === ',') {
      e.preventDefault();
      // Get current value and caret position
      const input = e.target;
      const currentValue = input.value;
      const caretPos = input.selectionStart;
      
      // Insert decimal point where the comma would have gone
      const newValue = currentValue.substring(0, caretPos) + '.' + currentValue.substring(input.selectionEnd);
      
      // Update recipe value and reset caret position
      updateRecipeValue(recipeType, ymStIndex, key, newValue);
      // Need to use setTimeout to let React update the DOM
      setTimeout(() => {
        input.selectionStart = input.selectionEnd = caretPos + 1;
      }, 0);
    }
    
    // Ensure periods can be entered anywhere in the input
    if (e.key === '.') {
      // Check if the input already contains a period
      const input = e.target;
      const currentValue = input.value;
      
      // Allow periods even if the field already has one
      // This will let users enter periods anywhere, and validation will happen elsewhere
      // Do nothing special, let the default behavior proceed
    }
  };

  const handleInputChange = (field, value) => {
    // Enforce point as decimal separator for any input value
    let normalizedValue;
    
    // First ensure the value is trimmed
    const trimmedValue = typeof value === 'string' ? value.trim() : value;
    
    // Special case for decimal inputs - maintain exact format
    if (typeof trimmedValue === 'string' && trimmedValue.includes('.')) {
      // If the string contains a decimal point, preserve its format exactly
      setMmGtData(prev => ({
        ...prev,
        [field]: trimmedValue
      }));
      return;
    }
    
    if (typeof trimmedValue === 'string' && trimmedValue.includes(',')) {
      // If input contains comma, replace with point
      normalizedValue = trimmedValue.replace(/,/g, '.');
    } else {
      // Otherwise use the trimmed value or normalize if not a string
      normalizedValue = typeof trimmedValue === 'string' ? trimmedValue : normalizeInputValue(trimmedValue);
    }
    
    // For numeric fields, ensure we store with point decimal separator but keep as strings
    if (['cap', 'kaplama', 'min_mukavemet', 'max_mukavemet', 'kg', 'tolerans_plus', 'tolerans_minus'].includes(field)) {
      if (typeof normalizedValue === 'string' && normalizedValue !== '') {
        // Remove any commas first and replace with points to be sure
        const valueWithPoints = normalizedValue.replace(/,/g, '.');
        
        // If it's a valid number, ensure it uses point as decimal separator
        const num = parseFloat(valueWithPoints);
        if (!isNaN(num)) {
          // For decimal input, keep the decimal part as-is to preserve user input exactly as entered
          if (valueWithPoints.includes('.')) {
            // If user is typing a decimal number, keep their input exactly as is (with points)
            normalizedValue = valueWithPoints;
          } else {
            // For whole numbers, no decimal formatting needed
            normalizedValue = valueWithPoints;
          }
        }
      }
    }
    
    setMmGtData(prev => ({
      ...prev,
      [field]: normalizedValue
    }));
  };

  // Manuel YM ST ekleme iÅŸleyicisi
  const handleAddYmSt = () => {
    if (!newYmStData.cap || !newYmStData.filmasin || !newYmStData.quality) {
      toast.error('LÃ¼tfen tÃ¼m alanlarÄ± doldurun');
      return;
    }
    
    const capValue = parseFloat(newYmStData.cap);
    const capStr = Math.round(capValue * 100).toString().padStart(4, '0');
    const newYmSt = {
      stok_kodu: `YM.ST.${capStr}.${newYmStData.filmasin}.${newYmStData.quality}`,
      stok_adi: `YM Siyah Tel ${capStr} mm HM:${newYmStData.filmasin}.${newYmStData.quality}`,
      cap: capValue,
      filmasin: parseInt(newYmStData.filmasin),
      quality: newYmStData.quality,
      source: 'manual-added'
    };
    
    setSelectedYmSts(prev => [...prev, newYmSt]);
    setShowAddYmStModal(false);
    setNewYmStData({ cap: '', filmasin: '', quality: '' });
    
    // Yeni eklenen YM ST iÃ§in reÃ§eteleri hesapla
    setTimeout(() => {
      calculateAutoRecipeValues();
    }, 100);
  };

  // Manuel giriÅŸe geri dÃ¶n - tÃ¼m state'i temizle
  const handleBackToManual = () => {
    setCurrentStep('input');
    setSelectedRequest(null);
    setSelectedExistingMmGt(null);
    setIsRequestUsed(false); // Talep kullanÄ±m durumunu sÄ±fÄ±rla
    setYmGtData(null);
    setSuitableYmSts([]);
    setSelectedYmSts([]);
    setAutoGeneratedYmSts([]);
    setSavedToDatabase(false);
    setDatabaseIds({ mmGtIds: [], ymGtId: null, ymStIds: [] });
    setAllRecipes({ mmGtRecipes: {}, ymGtRecipe: {}, ymStRecipes: {} });
    setRecipeStatus({ mmGtRecipes: {}, ymGtRecipe: {}, ymStRecipes: {} });
    setActiveRecipeTab(0);
    setError(null);
    setSuccessMessage('');
    
    // Session tracking temizle
    setSessionSavedProducts({ mmGtIds: [], ymGtId: null, ymStIds: [] });
    
    // Formu temizle - NOKTA ile default deÄŸerler
    setMmGtData({
      cap: '2.50', // Using point as decimal separator
      kod_2: 'NIT',
      kaplama: '50',
      min_mukavemet: '350',
      max_mukavemet: '550',
      kg: '500',
      ic_cap: 45,
      dis_cap: 75,
      tolerans_plus: '0.05',
      tolerans_minus: '0.06',
      shrink: 'evet',
      unwinding: '',
      cast_kont: '',
      helix_kont: '',
      elongation: ''
    });
  };

  // Ä°leri butonu
  const handleNext = () => {
    if (!mmGtData.cap || !mmGtData.kaplama || !mmGtData.min_mukavemet || !mmGtData.max_mukavemet || !mmGtData.kg) {
      toast.error('LÃ¼tfen tÃ¼m gerekli alanlarÄ± doldurun');
      return;
    }
    
    setCurrentStep('summary');
    generateYmGtData();
    findSuitableYmSts();
    calculateAutoRecipeValues();
  };

  // YM ST seÃ§imi
  const handleYmStSelection = (ymSt) => {
    const isSelected = selectedYmSts.find(item => item.stok_kodu === ymSt.stok_kodu);
    if (isSelected) {
      // If removing a YM ST, check if it's the main one
      const removedIndex = selectedYmSts.findIndex(item => item.stok_kodu === ymSt.stok_kodu);
      if (removedIndex === mainYmStIndex) {
        // If we're removing the main YMST, set a new main index
        const totalLength = selectedYmSts.length + autoGeneratedYmSts.length;
        if (totalLength > 1) {
          // If there are still YMSTs left, select a new main YMST
          // Prefer to keep the main YMST among selected YMSTs
          if (selectedYmSts.length > 1) {
            // If there are other selected YMSTs, choose one of them
            setMainYmStIndex(removedIndex === selectedYmSts.length - 1 ? removedIndex - 1 : 0);
          } else if (autoGeneratedYmSts.length > 0) {
            // Fall back to the first auto-generated YMST
            setMainYmStIndex(0);
          }
        }
      } else if (removedIndex < mainYmStIndex) {
        // If removing an YMST with index less than main, adjust main index
        setMainYmStIndex(mainYmStIndex - 1);
      }
      
      setSelectedYmSts(prev => prev.filter(item => item.stok_kodu !== ymSt.stok_kodu));
    } else {
      // Adding a new YMST
      setSelectedYmSts(prev => {
        const newYmSts = [...prev, { ...ymSt, source: 'database' }];
        
        // If this is the first YMST (either selected or auto), make it the main one
        const totalYmSts = newYmSts.length + autoGeneratedYmSts.length;
        if (totalYmSts === 1) {
          setMainYmStIndex(0);
        }
        
        return newYmSts;
      });
    }
    
    // SeÃ§im deÄŸiÅŸtiÄŸinde reÃ§eteleri yeniden hesapla
    setTimeout(() => {
      calculateAutoRecipeValues();
    }, 100);
  };

  // Otomatik oluÅŸturulan YM ST'yi sil
  const removeAutoGeneratedYmSt = (index) => {
    // The auto index in the overall selection
    const autoIndex = selectedYmSts.length + index;
    
    // If removing the main YMST, set a new main YMST
    if (autoIndex === mainYmStIndex) {
      const totalLength = selectedYmSts.length + autoGeneratedYmSts.length;
      if (totalLength > 1) {
        // Prefer to keep the main among auto YMSTs if possible
        if (autoGeneratedYmSts.length > 1) {
          const newMainIndex = index === autoGeneratedYmSts.length - 1 
            ? autoIndex - 1 
            : autoIndex + 1 < totalLength ? autoIndex + 1 : 0;
          setMainYmStIndex(newMainIndex);
        } else if (selectedYmSts.length > 0) {
          // Fall back to selected YMSTs
          setMainYmStIndex(0);
        }
      }
    } else if (autoIndex < mainYmStIndex) {
      // If removing an YMST with index less than main, adjust main index
      setMainYmStIndex(mainYmStIndex - 1);
    }
    
    setAutoGeneratedYmSts(prev => prev.filter((_, i) => i !== index));
    setTimeout(() => {
      calculateAutoRecipeValues();
    }, 100);
  };

  // SeÃ§ili YM ST'yi sil
  const removeSelectedYmSt = (index) => {
    // If removing the main YMST, set a new main YMST
    if (index === mainYmStIndex) {
      const totalLength = selectedYmSts.length + autoGeneratedYmSts.length;
      if (totalLength > 1) {
        // Prefer to keep the main among selected YMSTs if possible
        if (selectedYmSts.length > 1) {
          const newMainIndex = index === selectedYmSts.length - 1 ? index - 1 : index + 1 < selectedYmSts.length ? index + 1 : 0;
          setMainYmStIndex(newMainIndex);
        } else if (autoGeneratedYmSts.length > 0) {
          // Fall back to auto YMSTs, which start at index selectedYmSts.length
          setMainYmStIndex(selectedYmSts.length - 1); // Will be correct after removal
        }
      }
    } else if (index < mainYmStIndex) {
      // If removing an YMST with index less than main, adjust main index
      setMainYmStIndex(mainYmStIndex - 1);
    }
    
    setSelectedYmSts(prev => prev.filter((_, i) => i !== index));
    setTimeout(() => {
      calculateAutoRecipeValues();
    }, 100);
  };

  // ReÃ§ete gÃ¼ncelleme fonksiyonu - NOKTA kullan
  const updateRecipeValue = (recipeType, ymStIndex, key, value) => {
    // Handle comma to point conversion first (direct replacement)
    let inputValue = value;
    if (typeof inputValue === 'string' && inputValue.includes(',')) {
      inputValue = inputValue.replace(/,/g, '.');
    }
    
    // Special case handling for direct decimal input
    // This allows decimal points to be properly entered and maintained in the field
    if (typeof inputValue === 'string') {
      // If we have a string with a decimal point (.5 or 3.1), preserve its exact format
      // This handles decimal points that were just added by the user
      if (inputValue.includes('.')) {
        // Store it as is to maintain positions of digits and decimal points
        setRecipeStatus(prev => ({
          ...prev,
          [recipeType === 'mmgt' 
            ? 'mmGtRecipes' 
            : recipeType === 'ymgt' 
              ? 'ymGtRecipe' 
              : 'ymStRecipes']: recipeType === 'ymgt' 
                ? { ...prev.ymGtRecipe, [key]: 'manual' }
                : {
                    ...prev[recipeType === 'mmgt' ? 'mmGtRecipes' : 'ymStRecipes'],
                    [ymStIndex]: {
                      ...prev[recipeType === 'mmgt' ? 'mmGtRecipes' : 'ymStRecipes'][ymStIndex],
                      [key]: 'manual'
                    }
                  }
        }));
        
        // Update the appropriate recipe with the exact string value
        if (recipeType === 'mmgt') {
          setAllRecipes(prev => ({
            ...prev,
            mmGtRecipes: {
              ...prev.mmGtRecipes,
              [ymStIndex]: {
                ...prev.mmGtRecipes[ymStIndex],
                [key]: inputValue // Keep as string with decimal point
              }
            }
          }));
          return; // Exit early to avoid overwriting with number parsing
        } else if (recipeType === 'ymgt') {
          setAllRecipes(prev => ({
            ...prev,
            ymGtRecipe: {
              ...prev.ymGtRecipe,
              [key]: inputValue // Keep as string with decimal point
            }
          }));
          return; // Exit early
        } else {
          setAllRecipes(prev => ({
            ...prev,
            ymStRecipes: {
              ...prev.ymStRecipes,
              [ymStIndex]: {
                ...prev.ymStRecipes[ymStIndex],
                [key]: inputValue // Keep as string with decimal point
              }
            }
          }));
          return; // Exit early
        }
      }
    }
    
    // For other cases (non-decimal string, empty string, number, etc.)
    // Continue with standard handling
    const normalizedValue = typeof inputValue === 'string' ? inputValue : normalizeInputValue(inputValue);
    
    // Ensure we have a proper numeric value with point decimal separator
    // Store the formatted string to maintain proper decimal display
    const numValue = parseFloat(normalizedValue) || 0;
    const formattedValue = numValue.toLocaleString('en-US', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 5,
      useGrouping: false // No thousand separators
    });

    if (recipeType === 'mmgt') {
      setAllRecipes(prev => ({
        ...prev,
        mmGtRecipes: {
          ...prev.mmGtRecipes,
          [ymStIndex]: {
            ...prev.mmGtRecipes[ymStIndex],
            [key]: formattedValue // Store as formatted string with point decimal
          }
        }
      }));
      // Manuel deÄŸiÅŸiklik olarak iÅŸaretle
      setRecipeStatus(prev => ({
        ...prev,
        mmGtRecipes: {
          ...prev.mmGtRecipes,
          [ymStIndex]: {
            ...prev.mmGtRecipes[ymStIndex],
            [key]: 'manual'
          }
        }
      }));
    } else if (recipeType === 'ymgt') {
      setAllRecipes(prev => ({
        ...prev,
        ymGtRecipe: {
          ...prev.ymGtRecipe,
          [key]: formattedValue // Store as formatted string with point decimal
        }
      }));
      // Manuel deÄŸiÅŸiklik olarak iÅŸaretle
      setRecipeStatus(prev => ({
        ...prev,
        ymGtRecipe: {
          ...prev.ymGtRecipe,
          [key]: 'manual'
        }
      }));
    } else if (recipeType === 'ymst') {
      setAllRecipes(prev => ({
        ...prev,
        ymStRecipes: {
          ...prev.ymStRecipes,
          [ymStIndex]: {
            ...prev.ymStRecipes[ymStIndex],
            [key]: formattedValue // Store as formatted string with point decimal
          }
        }
      }));
      // Manuel deÄŸiÅŸiklik olarak iÅŸaretle
      setRecipeStatus(prev => ({
        ...prev,
        ymStRecipes: {
          ...prev.ymStRecipes,
          [ymStIndex]: {
            ...prev.ymStRecipes[ymStIndex],
            [key]: 'manual'
          }
        }
      }));
      // FLM deÄŸiÅŸikliÄŸi durumunda diÄŸer hesaplamalarÄ± tetikle
      if (key.includes('FLM.')) {
        setTimeout(() => {
          calculateAutoRecipeValues();
        }, 100);
      }
    }
  };

  // ReÃ§ete durumunu gÃ¶sterir
  const getRecipeStatusText = (recipeType, ymStIndex, key) => {
    let status = '';
    if (recipeType === 'mmgt') {
      status = recipeStatus.mmGtRecipes[ymStIndex]?.[key];
    } else if (recipeType === 'ymgt') {
      status = recipeStatus.ymGtRecipe[key];
    } else if (recipeType === 'ymst') {
      status = recipeStatus.ymStRecipes[ymStIndex]?.[key];
    }
    
    switch (status) {
      case 'database': return 'VeritabanÄ±nda seÃ§ildi';
      case 'auto': return 'Otomatik dolduruldu';
      case 'manual': return 'Elle dolduruldu';
      default: return '';
    }
  };

  // Ä°nkremental Ã¼rÃ¼n oluÅŸturma kontrolÃ¼ - DeÄŸiÅŸen mantÄ±k: Sadece stok_kodu veya stok_adÄ± etkileyen deÄŸerler deÄŸiÅŸirse
  const checkForExistingProducts = async (cap, kod_2, kaplama, minMukavemet, maxMukavemet, kg) => {
    try {
      const capFormatted = Math.round(parseFloat(cap) * 100).toString().padStart(4, '0');
      const baseCode = `GT.${kod_2}.${capFormatted}`;
      
      // AynÄ± core deÄŸerlere sahip Ã¼rÃ¼nleri ara
      const response = await fetchWithAuth(`${API_URLS.galMmGt}?stok_kodu_like=${encodeURIComponent(baseCode)}`);
      if (response && response.ok) {
        const existingProducts = await response.json();
        
        // Tamamen aynÄ± Ã¼rÃ¼n var mÄ± kontrol et (stok_kodu ve stok_adi etkileyen tÃ¼m deÄŸerler)
        const stokAdi = `Galvanizli Tel ${parseFloat(cap).toFixed(2)} mm -${Math.abs(parseFloat(mmGtData.tolerans_minus)).toFixed(2)}/+${parseFloat(mmGtData.tolerans_plus).toFixed(2)} ${kaplama} gr/mÂ² ${minMukavemet}-${maxMukavemet} MPa ID:${mmGtData.ic_cap} cm OD:${mmGtData.dis_cap} cm ${kg} kg`;
        
        // Tamamen eÅŸleÅŸen bir Ã¼rÃ¼n var mÄ±?
        const exactMatch = existingProducts.find(product => {
          // Stok adÄ± ile karÅŸÄ±laÅŸtÄ±rma iÃ§in normalizasyon (boÅŸluklar ve case-sensitive olmayan karÅŸÄ±laÅŸtÄ±rma)
          const normalizedProductAdi = product.stok_adi.replace(/\s+/g, ' ').trim().toLowerCase();
          const normalizedStokAdi = stokAdi.replace(/\s+/g, ' ').trim().toLowerCase();
          
          // Stok kodu base'i ve stok adÄ± eÅŸleÅŸiyorsa
          return normalizedProductAdi === normalizedStokAdi;
        });
        
        if (exactMatch) {
          // KullanÄ±cÄ±ya gÃ¼ncelleme onayÄ± gÃ¶ster
          const confirmUpdate = window.confirm(
            `Tam olarak aynÄ± deÄŸerlere sahip bir Ã¼rÃ¼n mevcut:\n${exactMatch.stok_kodu} - ${exactMatch.stok_adi}\n\nKayÄ±tlÄ± Ã¼rÃ¼nÃ¼ gÃ¼ncellemek istediÄŸinize emin misiniz?`
          );
          
          if (confirmUpdate) {
            // Bu Ã¼rÃ¼nÃ¼n sequence kodunu kullan
            const sequencePart = exactMatch.stok_kodu.split('.').pop();
            const sequenceNum = parseInt(sequencePart);
            return sequenceNum; // Mevcut sequence'i kullan
          } else {
            // KullanÄ±cÄ± Ä°ptal'e tÄ±kladÄ±, iÅŸlemi durdur
            throw new Error('Ä°ÅŸlem kullanÄ±cÄ± tarafÄ±ndan iptal edildi');
          }
        }
        
        // EÄŸer tamamen eÅŸleÅŸen yoksa, yeni bir Ã¼rÃ¼n oluÅŸtur
        let maxSequence = -1;
        existingProducts.forEach(product => {
          const sequencePart = product.stok_kodu.split('.').pop();
          const sequenceNum = parseInt(sequencePart);
          if (!isNaN(sequenceNum) && sequenceNum > maxSequence) {
            maxSequence = sequenceNum;
          }
        });
        
        return maxSequence + 1;
      }
    } catch (error) {
      console.error('Mevcut Ã¼rÃ¼n kontrolÃ¼ hatasÄ±:', error);
    }
    return 0; // Hata durumunda 0'dan baÅŸla
  };

  // Session'daki Ã¼rÃ¼nleri gÃ¼ncelle - Yeni 1:1:n iliÅŸki modeli ile
  const updateSessionProducts = async () => {
    const allYmSts = [...selectedYmSts, ...autoGeneratedYmSts];
    
    if (sessionSavedProducts.mmGtIds.length > 0) {
      // Ana YM ST'yi belirle
      const mainYmSt = allYmSts[mainYmStIndex] || allYmSts[0];
      
      // MMGT iÃ§in doÄŸru sequence'i belirle - Ã¶zellikle key deÄŸerleri deÄŸiÅŸtiyse Ã¶nemli
      let sequence = '00';
      let oldSequence = '00';
      
      // MMGT'nin stok_kodu'ndan mevcut sequence'i al
      const mmGtResponse = await fetchWithAuth(`${API_URLS.galMmGt}/${sessionSavedProducts.mmGtIds[0]}`);
      if (mmGtResponse && mmGtResponse.ok) {
        const mmGt = await mmGtResponse.json();
        if (mmGt && mmGt.stok_kodu) {
          oldSequence = mmGt.stok_kodu.split('.').pop();
          console.log(`Mevcut MMGT sequence: ${oldSequence}, stok_kodu: ${mmGt.stok_kodu}`);
          
          // Key deÄŸerlerinde deÄŸiÅŸim var mÄ± Ã§ok dikkatli kontrol et
          const currentKey = `${mmGtData.cap}|${mmGtData.kod_2}|${mmGtData.kaplama}|${mmGtData.min_mukavemet}|${mmGtData.max_mukavemet}|${mmGtData.kg}`;
          const oldKey = `${mmGt.cap}|${mmGt.kod_2}|${mmGt.kaplama}|${mmGt.min_mukavemet}|${mmGt.max_mukavemet}|${mmGt.kg}`;
          
          if (currentKey !== oldKey) {
            console.log(`Key deÄŸerlerinde deÄŸiÅŸim tespit edildi!`);
            console.log(`Eski: ${oldKey}`);
            console.log(`Yeni: ${currentKey}`);
            
            // Ã–NEMLÄ°: Ã–nce veritabanÄ±nda aynÄ± key deÄŸerlere sahip Ã¼rÃ¼n var mÄ± kontrol et
            const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
            const baseCode = `GT.${mmGtData.kod_2}.${capFormatted}`;
            
            try {
              // AynÄ± base koda sahip Ã¼rÃ¼nleri ara
              const response = await fetchWithAuth(`${API_URLS.galMmGt}?stok_kodu_like=${encodeURIComponent(baseCode)}`);
              if (response && response.ok) {
                const existingProducts = await response.json();
                console.log(`${existingProducts.length} adet benzer Ã¼rÃ¼n bulundu`);
                
                if (existingProducts.length > 0) {
                  // Tam eÅŸleÅŸen bir Ã¼rÃ¼n ara
                  const stokAdi = `Galvanizli Tel ${parseFloat(mmGtData.cap).toFixed(2)} mm -${Math.abs(parseFloat(mmGtData.tolerans_minus)).toFixed(2)}/+${parseFloat(mmGtData.tolerans_plus).toFixed(2)} ${mmGtData.kaplama} gr/mÂ² ${mmGtData.min_mukavemet}-${mmGtData.max_mukavemet} MPa ID:${mmGtData.ic_cap} cm OD:${mmGtData.dis_cap} cm ${mmGtData.kg} kg`;
                  const normalizedStokAdi = stokAdi.replace(/\s+/g, ' ').trim().toLowerCase();
                  
                  let exactMatch = null;
                  for (const product of existingProducts) {
                    if (product.id === sessionSavedProducts.mmGtIds[0]) continue; // Kendisi olmamalÄ±
                    
                    const normalizedProductAdi = product.stok_adi.replace(/\s+/g, ' ').trim().toLowerCase();
                    if (normalizedProductAdi === normalizedStokAdi) {
                      exactMatch = product;
                      break;
                    }
                  }
                  
                  if (exactMatch) {
                    // Tam eÅŸleÅŸen Ã¼rÃ¼n bulundu - bu Ã¼rÃ¼nÃ¼n sequence'ini kullan
                    sequence = exactMatch.stok_kodu.split('.').pop();
                    console.log(`Tam eÅŸleÅŸen Ã¼rÃ¼n bulundu, sequence kullanÄ±lacak: ${sequence}`);
                  } else {
                    // En yÃ¼ksek sequence'i bul
                    let maxSequence = -1;
                    existingProducts.forEach(product => {
                      const sequencePart = product.stok_kodu.split('.').pop();
                      const sequenceNum = parseInt(sequencePart);
                      if (!isNaN(sequenceNum) && sequenceNum > maxSequence) {
                        maxSequence = sequenceNum;
                      }
                    });
                    
                    // Yeni Ã¼rÃ¼n iÃ§in sequence artÄ±r
                    sequence = (maxSequence + 1).toString().padStart(2, '0');
                    console.log(`Key deÄŸiÅŸimi nedeniyle yeni sequence hesaplandÄ±: ${sequence}`);
                  }
                } else {
                  // Benzer Ã¼rÃ¼n bulunamadÄ± - yeni sequence hesapla
                  sequence = '00';
                  console.log(`Benzer Ã¼rÃ¼n bulunamadÄ±, yeni sequence hesaplanacak`);
                }
              }
            } catch (error) {
              console.error('VeritabanÄ± sorgulama hatasÄ±:', error);
            }
            
            // Hala sequence belirlenemedi ise yeni hesapla
            if (sequence === '00') {
              // Key deÄŸiÅŸmiÅŸse yeni sequence hesapla
              const nextSequence = await checkForExistingProducts(
                mmGtData.cap,
                mmGtData.kod_2,
                mmGtData.kaplama,
                mmGtData.min_mukavemet,
                mmGtData.max_mukavemet,
                mmGtData.kg
              );
              sequence = nextSequence.toString().padStart(2, '0');
              console.log(`checkForExistingProducts ile yeni sequence hesaplandÄ±: ${sequence}`);
            }
          } else {
            // Key deÄŸiÅŸmemiÅŸse mevcut sequence'i kullan
            sequence = oldSequence;
            console.log(`Key deÄŸerleri deÄŸiÅŸmemiÅŸ, mevcut sequence kullanÄ±lÄ±yor: ${sequence}`);
          }
        }
      }
      
      console.log(`ÃœrÃ¼n gÃ¼ncellemesi iÃ§in kullanÄ±lacak sequence: ${sequence}`);
      // Eski ve yeni sequence farklÄ± ise kullanÄ±cÄ±yÄ± uyar
      if (oldSequence !== '00' && sequence !== oldSequence) {
        console.warn(`Sequence deÄŸiÅŸiyor: ${oldSequence} -> ${sequence}`);
      }
      
      // Sadece 1 MM GT'yi gÃ¼ncelle
      if (sessionSavedProducts.mmGtIds[0]) {
        await fetchWithAuth(`${API_URLS.galMmGt}/${sessionSavedProducts.mmGtIds[0]}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(generateMmGtDatabaseData(sequence))
        });
      }
      
      // Sadece 1 YM GT'yi gÃ¼ncelle
      if (sessionSavedProducts.ymGtId) {
        await fetchWithAuth(`${API_URLS.galYmGt}/${sessionSavedProducts.ymGtId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(generateYmGtDatabaseData(sequence))
        });
      }
      
      // TÃ¼m YM ST'leri gÃ¼ncelle
      for (let i = 0; i < allYmSts.length && i < sessionSavedProducts.ymStIds.length; i++) {
        // YM ST'yi gÃ¼ncelle (eÄŸer otomatik oluÅŸturulmuÅŸsa)
        if (sessionSavedProducts.ymStIds[i] && 
            (allYmSts[i].source === 'auto-generated' || allYmSts[i].source === 'manual-added')) {
          await fetchWithAuth(`${API_URLS.galYmSt}/${sessionSavedProducts.ymStIds[i]}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(generateYmStDatabaseData(allYmSts[i]))
          });
        }
      }
      
      // MM GT - Ana YM ST iliÅŸkisini gÃ¼ncelle - iliÅŸkileri sil ve yeniden oluÅŸtur
      try {
        // Ã–nce iliÅŸkileri sil
        if (sessionSavedProducts.mmGtIds[0]) {
          await fetchWithAuth(`${API_URLS.galMmGtYmSt}/mm_gt/${sessionSavedProducts.mmGtIds[0]}`, {
            method: 'DELETE'
          });
        }
        
        // Yeni iliÅŸkiyi oluÅŸtur
        if (sessionSavedProducts.mmGtIds[0] && sessionSavedProducts.ymStIds[mainYmStIndex]) {
          await fetchWithAuth(API_URLS.galMmGtYmSt, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              mm_gt_id: sessionSavedProducts.mmGtIds[0],
              ym_st_id: sessionSavedProducts.ymStIds[mainYmStIndex]
            })
          });
        }
      } catch (error) {
        console.error('Ä°liÅŸki gÃ¼ncelleme hatasÄ±:', error);
      }
      
      return {
        mmGtIds: [sessionSavedProducts.mmGtIds[0]], // ArtÄ±k sadece 1 MM GT var
        ymGtId: sessionSavedProducts.ymGtId,
        ymStIds: sessionSavedProducts.ymStIds
      };
    }
    
    return null;
  };

  // VeritabanÄ±na kaydet - Yeni 1:1:n iliÅŸki modeli ile
  const saveToDatabase = async () => {
    try {
      setIsLoading(true);
      setError(null);
      
      // Session'da mevcut Ã¼rÃ¼nler varsa gÃ¼ncelle
      const updatedIds = await updateSessionProducts();
      if (updatedIds) {
        // ReÃ§eteleri gÃ¼ncelle
        await saveRecipesToDatabase(updatedIds.mmGtIds, updatedIds.ymGtId, updatedIds.ymStIds);
        
        setDatabaseIds(updatedIds);
        setSavedToDatabase(true);
        setSuccessMessage('Veriler baÅŸarÄ±yla gÃ¼ncellendi');
        toast.success('Veriler baÅŸarÄ±yla gÃ¼ncellendi');
        
        // Session'daki Ã¼rÃ¼nleri gÃ¼ncelle
        setSessionSavedProducts(updatedIds);
        
        setIsLoading(false);
        return;
      }
      
      // Talep kullanÄ±ldÄ±ysa uyarÄ± gÃ¶ster
      if (isRequestUsed) {
        const confirmDelete = window.confirm('Bir talep seÃ§tiniz. VeritabanÄ±na kaydedildikten sonra bu talebi silmek ister misiniz?');
        if (confirmDelete && selectedRequest) {
          try {
            await deleteRequest(selectedRequest.id);
            setIsRequestUsed(false);
            setSelectedRequest(null);
          } catch (error) {
            console.error('Talep silme hatasÄ±:', error);
            // Talep silinemese bile kaydetmeye devam et
          }
        }
      }
      
      const allYmSts = [...selectedYmSts, ...autoGeneratedYmSts];
      
      if (allYmSts.length === 0) {
        toast.error('En az bir YM ST seÃ§melisiniz veya oluÅŸturmalÄ±sÄ±nÄ±z');
        setIsLoading(false);
        return;
      }
      
      // Ana YM ST'yi belirle
      const mainYmSt = allYmSts[mainYmStIndex] || allYmSts[0];
      
      // Ä°nkremental numara kontrolÃ¼ yap - artÄ±k sadece 1 MM GT ve 1 YM GT oluÅŸturulacak
      let nextSequence;
      try {
        nextSequence = await checkForExistingProducts(
          mmGtData.cap,
          mmGtData.kod_2,
          mmGtData.kaplama,
          mmGtData.min_mukavemet,
          mmGtData.max_mukavemet,
          mmGtData.kg
        );
      } catch (sequenceError) {
        // KullanÄ±cÄ± Ä°ptal'e tÄ±kladÄ±ÄŸÄ±nda
        console.log('Sequence kontrolÃ¼ iptal edildi:', sequenceError.message);
        setIsLoading(false);
        if (sequenceError.message === 'Ä°ÅŸlem kullanÄ±cÄ± tarafÄ±ndan iptal edildi') {
          toast.info('Ä°ÅŸlem iptal edildi');
        } else {
          toast.error('Sequence kontrolÃ¼ sÄ±rasÄ±nda hata: ' + sequenceError.message);
        }
        return; // Ä°ÅŸlemi tamamen durdur
      }
      
      const mmGtIds = [];
      const ymStIds = [];
      let ymGtId = null;
      
      // AynÄ± sequence ile 1 tane YM GT oluÅŸtur (MMGT ile aynÄ± sequence)
      const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
      const sequence = nextSequence.toString().padStart(2, '0');
      // MMGT ile aynÄ± sequence'i kullan
      console.log(`YM GT iÃ§in kullanÄ±lan sequence: ${sequence}`);
      // DÃœZELTME: sequence'i kullan - bu Ã¶nemli!
      // Ã–nce mevcut YM GT'yi kontrolden geÃ§ir
      const ymGtStokKodu = `YM.GT.${mmGtData.kod_2}.${capFormatted}.${sequence}`;
      console.log(`VeritabanÄ± iÅŸlemleri iÃ§in YMGT stok kodu: ${ymGtStokKodu}, sequence: ${sequence}`);
      const existingYmGt = await checkExistingProduct(API_URLS.galYmGt, ymGtStokKodu);
      
      if (existingYmGt) {
        // YM GT mevcut - gÃ¼ncelle
        const ymGtResponse = await fetchWithAuth(`${API_URLS.galYmGt}/${existingYmGt.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(generateYmGtDatabaseData(sequence))
        });
        if (ymGtResponse && ymGtResponse.ok) {
          ymGtId = existingYmGt.id;
        }
      } else {
        // YM GT yeni - oluÅŸtur
        const ymGtResponse = await fetchWithAuth(API_URLS.galYmGt, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(generateYmGtDatabaseData(sequence))
        });
        
        if (ymGtResponse && ymGtResponse.ok) {
          const ymGtResult = await ymGtResponse.json();
          ymGtId = ymGtResult.id;
        }
      }
      
      // AynÄ± sequence ile 1 tane MM GT oluÅŸtur
      const mmGtStokKodu = `GT.${mmGtData.kod_2}.${capFormatted}.${sequence}`;
      console.log(`MM GT iÃ§in kullanÄ±lan sequence: ${sequence}, stok_kodu: ${mmGtStokKodu}`);
      const existingMmGt = await checkExistingProduct(API_URLS.galMmGt, mmGtStokKodu);
      
      if (existingMmGt) {
        // MM GT mevcut - gÃ¼ncelle
        const mmGtResponse = await fetchWithAuth(`${API_URLS.galMmGt}/${existingMmGt.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(generateMmGtDatabaseData(sequence))
        });
        if (mmGtResponse && mmGtResponse.ok) {
          mmGtIds.push(existingMmGt.id);
        }
      } else {
        // MM GT yeni - oluÅŸtur
        const mmGtResponse = await fetchWithAuth(API_URLS.galMmGt, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(generateMmGtDatabaseData(sequence))
        });
        
        if (mmGtResponse && mmGtResponse.ok) {
          const mmGtResult = await mmGtResponse.json();
          mmGtIds.push(mmGtResult.id);
        }
      }
      
      // TÃ¼m YM ST'leri kaydet
      for (let i = 0; i < allYmSts.length; i++) {
        const ymSt = allYmSts[i];
        
        // YM ST kontrolÃ¼ ve kaydetme
        if (ymSt.source === 'auto-generated' || ymSt.source === 'manual-added') {
          const existingYmSt = await checkExistingProduct(API_URLS.galYmSt, ymSt.stok_kodu);
          
          if (existingYmSt) {
            ymStIds.push(existingYmSt.id);
          } else {
            const ymStResponse = await fetchWithAuth(API_URLS.galYmSt, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(generateYmStDatabaseData(ymSt))
            });
            
            if (ymStResponse && ymStResponse.ok) {
              const ymStResult = await ymStResponse.json();
              ymStIds.push(ymStResult.id);
            }
          }
        } else {
          // Mevcut YM ST'nin ID'sini al
          ymStIds.push(ymSt.id);
        }
      }
      
      // Sadece ana YM ST ile MM GT arasÄ±nda iliÅŸki kur
      try {
        await fetchWithAuth(API_URLS.galMmGtYmSt, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mm_gt_id: mmGtIds[0],
            ym_st_id: ymStIds[mainYmStIndex]
          })
        });
      } catch (relationError) {
        console.log('Ä°liÅŸki zaten mevcut veya hata oluÅŸtu:', relationError);
      }
      
      // ReÃ§eteleri kaydet - sadece 1 MM GT, 1 YM GT ve tÃ¼m YM ST'ler iÃ§in
      await saveRecipesToDatabase(mmGtIds, ymGtId, ymStIds);
      
      setDatabaseIds({
        mmGtIds: mmGtIds,
        ymGtId: ymGtId,
        ymStIds: ymStIds
      });
      
      // Session'da kaydedilen Ã¼rÃ¼nleri takip et
      setSessionSavedProducts({
        mmGtIds: mmGtIds,
        ymGtId: ymGtId,
        ymStIds: ymStIds
      });
      
      setSavedToDatabase(true);
      setSuccessMessage('Veriler baÅŸarÄ±yla veritabanÄ±na kaydedildi');
      toast.success('Veriler baÅŸarÄ±yla veritabanÄ±na kaydedildi');
      
    } catch (error) {
      console.error('VeritabanÄ±na kaydetme hatasÄ±:', error);
      setError('VeritabanÄ±na kaydetme hatasÄ±: ' + error.message);
      toast.error('VeritabanÄ±na kaydetme hatasÄ±: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  // Var olan Ã¼rÃ¼n kontrolÃ¼
  const checkExistingProduct = async (apiUrl, stokKodu) => {
    try {
      if (!stokKodu) {
        console.error('GeÃ§ersiz stok_kodu ile Ã¼rÃ¼n kontrolÃ¼ yapÄ±lamaz:', stokKodu);
        return null;
      }
      
      const response = await fetchWithAuth(`${apiUrl}?stok_kodu=${encodeURIComponent(stokKodu)}`);
      if (response && response.ok) {
        const data = await response.json();
        if (Array.isArray(data) && data.length > 0) {
          console.log(`"${stokKodu}" stok kodu ile Ã¼rÃ¼n bulundu. ID: ${data[0].id}`);
          return data[0];
        } else {
          console.log(`"${stokKodu}" stok kodu ile Ã¼rÃ¼n bulunamadÄ±`);
          return null;
        }
      } else if (response && response.status === 404) {
        console.log(`"${stokKodu}" stok kodu ile Ã¼rÃ¼n bulunamadÄ± (404 hatasÄ±)`);
      } else {
        console.error(`"${stokKodu}" stok kodu ile Ã¼rÃ¼n kontrolÃ¼ sÄ±rasÄ±nda API hatasÄ±: ${response?.status || 'Bilinmiyor'}`);
      }
    } catch (error) {
      console.error(`"${stokKodu}" stok kodu ile Ã¼rÃ¼n kontrol hatasÄ±:`, error.message);
    }
    return null;
  };

  // VeritabanÄ± iÃ§in MM GT verisi oluÅŸtur - Excel formatÄ±yla tam uyuÅŸum iÃ§in gÃ¼ncellendi
  /**
   * Verilen bir sequence deÄŸerini kontrol eder ve geÃ§erli olduÄŸunu doÄŸrular
   * @param {string} sequence - Kontrol edilecek sequence
   * @returns {string} - DoÄŸrulanmÄ±ÅŸ sequence deÄŸeri
   */
  const validateSequence = (sequence) => {
    if (!sequence) return '00';
    
    // Sequence deÄŸeri bir sayÄ± ve 0-99 arasÄ±nda olmalÄ±
    if (!/^\d{1,2}$/.test(sequence)) {
      console.error(`GeÃ§ersiz sequence formatÄ±: ${sequence}, varsayÄ±lan 00 kullanÄ±lÄ±yor`);
      return '00';
    }
    
    // 1-9 arasÄ± deÄŸerleri 01-09 formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
    return sequence.padStart(2, '0');
  };

  /**
   * Bir sequence deÄŸerini bir arttÄ±rÄ±r ve doÄŸru formatÄ± saÄŸlar
   * @param {string} sequence - ArttÄ±rÄ±lacak sequence
   * @returns {string} - ArttÄ±rÄ±lmÄ±ÅŸ sequence deÄŸeri
   */
  const incrementSequence = (sequence) => {
    // Sequence null/undefined ise veya geÃ§ersiz ise 00 kullan
    if (!sequence || !/^\d{1,2}$/.test(sequence)) {
      console.warn(`GeÃ§ersiz sequence: ${sequence}, 01 ile baÅŸlanÄ±yor`);
      return '01';
    }
    
    // 00 ise, 01 ile baÅŸla
    if (sequence === '00') {
      return '01';
    }
    
    // Mevcut sequence'i arttÄ±r
    const nextVal = parseInt(sequence, 10) + 1;
    
    // 99'dan bÃ¼yÃ¼kse 00'a geri dÃ¶n (dÃ¶ngÃ¼sel)
    if (nextVal > 99) {
      console.warn('Sequence 99\'u aÅŸtÄ±, 00\'a sÄ±fÄ±rlanÄ±yor');
      return '00';
    }
    
    // Padded 2-digit format ile dÃ¶n
    return nextVal.toString().padStart(2, '0');
  };

  const generateMmGtDatabaseData = (sequence = '00') => {
    // Sequence deÄŸerini doÄŸrula
    const validSequence = validateSequence(sequence);
    const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
    const capValue = parseFloat(mmGtData.cap);
    
    // Preserve the exact format in existing Excel files
    const capForExcel = capValue.toFixed(2);
    const toleransPlusValue = parseFloat(mmGtData.tolerans_plus) || 0;
    const toleransMinusValue = parseFloat(mmGtData.tolerans_minus) || 0;

    // Hem stok_kodu'nda hem de iÃ§eride kullanÄ±lan sequence deÄŸerini gÃ¼ncel tut
    console.log(`MMGT iÃ§in doÄŸrulanmÄ±ÅŸ sequence deÄŸeri: ${validSequence}`);
    return {
      stok_kodu: `GT.${mmGtData.kod_2}.${capFormatted}.${validSequence}`,
      stok_adi: generateStokAdi(), // Use the function that's known to be working for Excel
      grup_kodu: 'MM',
      kod_1: 'GT',
      kod_2: mmGtData.kod_2,
      muh_detay: '26',
      depo_kodu: '36',
      br_1: 'KG',
      br_2: 'TN',
      pay_1: 1,
      payda_1: 1000, // Use 1000 without decimal in database
      cevrim_degeri_1: 0.001, // Use 0.001 in database
      olcu_br_3: 'AD',
      cevrim_pay_2: 1,
      cevrim_payda_2: 1,
      cevrim_degeri_2: 1,
      cap: capValue, // Store as number for calculations
      kaplama: parseInt(mmGtData.kaplama),
      min_mukavemet: parseInt(mmGtData.min_mukavemet),
      max_mukavemet: parseInt(mmGtData.max_mukavemet),
      kg: parseInt(mmGtData.kg),
      ic_cap: parseInt(mmGtData.ic_cap),
      dis_cap: parseInt(mmGtData.dis_cap),
      cap2: capValue.toFixed(2), // Use point decimal formatting for database
      tolerans_plus: toleransPlusValue, // Store as number for calculations
      tolerans_minus: toleransMinusValue, // Store as number for calculations
      shrink: mmGtData.shrink,
      unwinding: mmGtData.unwinding || '',
      cast_kont: mmGtData.cast_kont || '',
      helix_kont: mmGtData.helix_kont || '',
      elongation: mmGtData.elongation || '',
      amb_shrink: getShrinkCode(mmGtData.ic_cap),
      satis_kdv_orani: '20', // Match Excel format as string
      alis_kdv_orani: '20', // Match Excel format as string
      stok_turu: 'D',
      fiyat_birimi: 1,
      satis_tipi: 1,
      birim_agirlik: parseInt(mmGtData.kg),
      esnek_yapilandir: 'H',
      super_recete_kullanilsin: 'H',
      alis_doviz_tipi: 2,
      gumruk_tarife_kodu: getGumrukTarifeKodu(),
      ingilizce_isim: generateEnglishName(), // Use the function that's known to be working for Excel
      // Technical spec columns - match Excel format exactly
      metarial: 'Low Carbon Steel Wire',
      dia_mm: capValue.toFixed(2).replace('.', ','), // Use comma decimal for display with safe formatting
      dia_tol_mm_plus: toleransPlusValue, 
      dia_tol_mm_minus: toleransMinusValue,
      zing_coating: `${mmGtData.kaplama} gr/mÂ²`,
      tensile_st_min: `${mmGtData.min_mukavemet} MPa`,
      tensile_st_max: `${mmGtData.max_mukavemet} MPa`,
      wax: 'NONE',
      lifting_lugs: mmGtData.shrink === 'evet' ? 'YES' : 'NO',
      coil_dimensions_id: mmGtData.ic_cap.toString(),
      coil_dimensions_od: mmGtData.dis_cap.toString(),
      coil_weight: mmGtData.kg.toString(),
      coil_weight_min: (parseInt(mmGtData.kg) * 0.95).toFixed(0),
      coil_weight_max: (parseInt(mmGtData.kg) * 1.05).toFixed(0)
    };
  };

  // VeritabanÄ± iÃ§in YM GT verisi oluÅŸtur - Excel formatÄ±na tam uyumlu
  const generateYmGtDatabaseData = (sequence = '00') => {
    // Sequence deÄŸerini doÄŸrula - MMGT ile aynÄ± sequence kullanÄ±lmalÄ±
    const validSequence = validateSequence(sequence);
    const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
    const capValue = parseFloat(mmGtData.cap);
    const capForExcel = capValue.toFixed(2);
    const toleransPlusValue = parseFloat(mmGtData.tolerans_plus) || 0;
    const toleransMinusValue = parseFloat(mmGtData.tolerans_minus) || 0;
    
    // Sequence deÄŸerlerinin MMGT ile aynÄ± olduÄŸunu logla
    console.log(`YMGT iÃ§in kullanÄ±lan sequence deÄŸeri: ${validSequence} (MMGT ile aynÄ± olmalÄ±)`);
    
    return {
      stok_kodu: `YM.GT.${mmGtData.kod_2}.${capFormatted}.${validSequence}`,
      stok_adi: generateYmGtStokAdi(validSequence), // Use the function that's known to be working for Excel
      grup_kodu: 'YM',
      kod_1: 'GT',
      kod_2: mmGtData.kod_2,
      muh_detay: '83',
      depo_kodu: '35',
      br_1: 'KG',
      br_2: 'TN',
      pay_1: 1,
      payda_1: 1000, // Use 1000 without decimal in database
      cevrim_degeri_1: 0.001, // Use 0.001 in database
      olcu_br_3: 'AD',
      cevrim_pay_2: 1,
      cevrim_payda_2: 1,
      cevrim_degeri_2: 1,
      cap: capValue, // Store as number for calculations
      kaplama: parseInt(mmGtData.kaplama),
      min_mukavemet: parseInt(mmGtData.min_mukavemet),
      max_mukavemet: parseInt(mmGtData.max_mukavemet),
      kg: parseInt(mmGtData.kg),
      ic_cap: parseInt(mmGtData.ic_cap),
      dis_cap: parseInt(mmGtData.dis_cap),
      cap2: capValue.toFixed(2), // Use point decimal formatting for database
      tolerans_plus: toleransPlusValue,
      tolerans_minus: toleransMinusValue,
      shrink: mmGtData.shrink,
      unwinding: mmGtData.unwinding || '',
      cast_kont: mmGtData.cast_kont || '',
      helix_kont: mmGtData.helix_kont || '',
      elongation: mmGtData.elongation || '',
      satis_kdv_orani: '20', // Match Excel format as string
      alis_kdv_orani: '20', // Match Excel format as string
      stok_turu: 'D',
      fiyat_birimi: 1,
      satis_tipi: 1,
      birim_agirlik: parseInt(mmGtData.kg),
      esnek_yapilandir: 'H',
      super_recete_kullanilsin: 'H',
      alis_doviz_tipi: 2,
      ingilizce_isim: generateYmGtInglizceIsim() // Use the function that's known to be working for Excel
    };
  };

  // VeritabanÄ± iÃ§in YM ST verisi oluÅŸtur - Excel formatÄ±na tam uyumlu
  const generateYmStDatabaseData = (ymSt) => {
    const capValue = parseFloat(ymSt.cap);
    const capForExcel = capValue.toFixed(2);
    
    return {
      stok_kodu: ymSt.stok_kodu,
      stok_adi: ymSt.stok_adi,
      grup_kodu: 'YM',
      kod_1: 'ST',
      kod_2: ymSt.filmasin.toString(), // Store filmasin value in kod_2 to match Excel
      kod_3: ymSt.quality, // Store quality value in kod_3 to match Excel
      muh_detay: '28',
      depo_kodu: '35',
      br_1: 'KG',
      br_2: 'TN',
      pay_1: 1,
      payda_1: 1000, // Use 1000 without decimal in database
      cevrim_degeri_1: 0.001, // Use 0.001 in database
      olcu_br_3: 'AD',
      cevrim_pay_2: 1,
      cevrim_payda_2: 1,
      cevrim_degeri_2: 1,
      satis_kdv_orani: '20', // Match Excel format as string
      cap: capValue, // Store as number for calculations
      filmasin: parseInt(ymSt.filmasin),
      quality: ymSt.quality,
      ozel_saha_1_say: parseInt(ymSt.filmasin), // This stores the filmasin value as in Excel
      birim_agirlik: ymSt.kg || 0,
      fiyat_birimi: 1,
      doviz_tip: 1,
      stok_turu: 'D',
      ingilizce_isim: `YM Black Wire ${capValue.toFixed(2).replace('.', ',')} mm Quality: ${ymSt.quality || ''}`,
      esnek_yapilandir: 'H',
      super_recete_kullanilsin: 'H'
    };
  };

  // ReÃ§eteleri kaydet - Yeni 1:1:n iliÅŸki modeli ile
  /**
   * AynÄ± cap, kod_2, vb. Ã¶zelliklere sahip Ã¼rÃ¼nler iÃ§in en yÃ¼ksek sequence deÄŸerini bulur
   * @returns {Promise<string>} - Bulunan en yÃ¼ksek sequence deÄŸeri veya '00'
   */
  const findHighestSequence = async () => {
    try {
      // Ã‡ap ve kod_2 deÄŸerleri iÃ§in arama kriterleri oluÅŸtur
      const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
      const searchPattern = `GT.${mmGtData.kod_2}.${capFormatted}.`;
      
      // TÃ¼m MM GT Ã¼rÃ¼nlerini getir
      const mmGtResponse = await fetchWithAuth(API_URLS.galMmGt);
      if (!mmGtResponse || !mmGtResponse.ok) {
        console.warn('MM GT Ã¼rÃ¼nleri alÄ±namadÄ±, sequence "00" kullanÄ±lacak');
        return '00';
      }
      
      const allMmGt = await mmGtResponse.json();
      if (!Array.isArray(allMmGt) || allMmGt.length === 0) {
        console.warn('MM GT Ã¼rÃ¼nÃ¼ bulunamadÄ±, sequence "00" kullanÄ±lacak');
        return '00';
      }
      
      // Benzer Ã¼rÃ¼nleri filtrele
      const similarProducts = allMmGt.filter(product => 
        product.stok_kodu && product.stok_kodu.startsWith(searchPattern)
      );
      
      if (similarProducts.length === 0) {
        console.log('Benzer Ã¼rÃ¼n bulunamadÄ±, sequence "00" kullanÄ±lacak');
        return '00';
      }
      
      // En yÃ¼ksek sequence deÄŸerini bul
      let highestSequence = '00';
      
      for (const product of similarProducts) {
        const parts = product.stok_kodu.split('.');
        if (parts.length === 4) {
          const currentSequence = parts[3];
          
          // Mevcut sequence numerik deÄŸer kontrolÃ¼
          if (/^\d{2}$/.test(currentSequence)) {
            // SayÄ±sal olarak karÅŸÄ±laÅŸtÄ±r (00 < 01 < 02 < ... < 99)
            if (parseInt(currentSequence, 10) > parseInt(highestSequence, 10)) {
              highestSequence = currentSequence;
            }
          }
        }
      }
      
      // Bir sonraki sequence deÄŸerini hesapla
      const nextSequence = incrementSequence(highestSequence);
      console.log(`Bulunan en yÃ¼ksek sequence deÄŸeri: ${highestSequence}, bir sonraki: ${nextSequence}`);
      return nextSequence;
    } catch (error) {
      console.error('Sequence arama hatasÄ±:', error);
      return '00';
    }
  };
  

  /**
   * ReÃ§eteleri veritabanÄ±na kaydetme fonksiyonu
   * Bu fonksiyon, MMGT ve YMGT Ã¼rÃ¼nleri iÃ§in reÃ§eteleri veritabanÄ±na kaydeder
   * Ã–NEMLÄ°: 404 hatalarÄ± ve diÄŸer API hatalarÄ± durumunda otomatik olarak stok_kodu Ã¼retip devam eder
   * MMGT ve YMGT sequence'leri aynÄ± olmasÄ±nÄ± garantiler
   */
  const saveRecipesToDatabase = async (mmGtIds, ymGtId, ymStIds) => {
    try {
      const allYmSts = [...selectedYmSts, ...autoGeneratedYmSts];
      const mainYmSt = allYmSts[mainYmStIndex] || allYmSts[0];
      
      // Ã–NEMLÄ° KRÄ°TÄ°K FIX: Artan sequence'i doÄŸru ÅŸekilde almak MMGT ve YMGT reÃ§eteleri iÃ§in hayati
      let mmGtSequence = '00';
      let mmGtStokKodu = '';
      let ymGtSequence = '00';
      let ymGtStokKodu = '';
      
      // 1. MMGT stok_kodu'nu direkt olarak veritabanÄ±ndan al
      if (mmGtIds.length > 0) {
        const mmGtId = mmGtIds[0];
        
        try {
          // MMGT'nin stok_kodu'nu direkt veritabanÄ±ndan al
          const mmGtResponse = await fetchWithAuth(`${API_URLS.galMmGt}/${mmGtId}`);
          if (mmGtResponse && mmGtResponse.ok) {
            const mmGt = await mmGtResponse.json();
            if (mmGt && mmGt.stok_kodu) {
              mmGtStokKodu = mmGt.stok_kodu;
              mmGtSequence = mmGt.stok_kodu.split('.').pop();
              
              if (mmGtSequence === '00') {
                console.warn(`UYARI: MMGT Ã¼rÃ¼nÃ¼ veritabanÄ±nda "00" sequence ile kaydedilmiÅŸ`);
              } else {
                console.log(`KRÄ°TÄ°K FIX! MMGT veritabanÄ±nda bulunan GERÃ‡EK stok_kodu: ${mmGtStokKodu} (sequence: ${mmGtSequence})`);
              }
            } else {
              console.error(`MMGT veritabanÄ±nda stok_kodu bulunamadÄ±! ID: ${mmGtId}`);
              // ÃœrÃ¼n bulunamadÄ± durumunda otomatik kod oluÅŸtur
              const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
              mmGtStokKodu = `GT.${mmGtData.kod_2}.${capFormatted}.00`;
              mmGtSequence = '00';
              console.log(`MMGT iÃ§in otomatik stok_kodu oluÅŸturuldu: ${mmGtStokKodu}`);
            }
          } else {
            console.error(`MMGT veritabanÄ±ndan alÄ±namadÄ±! ID: ${mmGtId}`);
            // API 404 hatasÄ± durumunda otomatik kod oluÅŸtur
            const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
            mmGtStokKodu = `GT.${mmGtData.kod_2}.${capFormatted}.00`;
            mmGtSequence = '00';
            console.log(`MMGT iÃ§in otomatik stok_kodu oluÅŸturuldu: ${mmGtStokKodu}`);
          }
        } catch (error) {
          console.error(`MMGT bilgileri alÄ±nÄ±rken hata: ${error.message}`);
          // Hata durumunda otomatik kod oluÅŸtur
          const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
          mmGtStokKodu = `GT.${mmGtData.kod_2}.${capFormatted}.00`;
          mmGtSequence = '00';
          console.log(`MMGT iÃ§in otomatik stok_kodu oluÅŸturuldu: ${mmGtStokKodu}`);
        }
      }
      
      // 2. YMGT stok_kodu'nu direkt olarak veritabanÄ±ndan al
      if (ymGtId) {
        try {
          const ymGtResponse = await fetchWithAuth(`${API_URLS.galYmGt}/${ymGtId}`);
          if (ymGtResponse && ymGtResponse.ok) {
            const ymGt = await ymGtResponse.json();
            if (ymGt && ymGt.stok_kodu) {
              ymGtStokKodu = ymGt.stok_kodu;
              ymGtSequence = ymGt.stok_kodu.split('.').pop();
              
              if (ymGtSequence === '00') {
                console.warn(`UYARI: YMGT Ã¼rÃ¼nÃ¼ veritabanÄ±nda "00" sequence ile kaydedilmiÅŸ`);
              } else {
                console.log(`KRÄ°TÄ°K FIX! YMGT veritabanÄ±nda bulunan GERÃ‡EK stok_kodu: ${ymGtStokKodu} (sequence: ${ymGtSequence})`);
              }
              
              // MMGT ve YMGT aynÄ± sequence'e sahip olmalÄ±!
              if (mmGtSequence !== ymGtSequence) {
                console.error(`SORUN! MMGT ve YMGT farklÄ± sequence'lere sahip! MMGT: ${mmGtSequence}, YMGT: ${ymGtSequence}`);
                // YMGT sequence'i MMGT ile aynÄ± yap - kritik dÃ¼zeltme
                ymGtSequence = mmGtSequence;
              }
            } else {
              console.error(`YMGT veritabanÄ±nda stok_kodu bulunamadÄ±! ID: ${ymGtId}`);
              // ÃœrÃ¼n bulunamadÄ± durumunda otomatik kod oluÅŸtur
              const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
              ymGtStokKodu = `YM.GT.${mmGtData.kod_2}.${capFormatted}.${mmGtSequence}`;
              console.log(`YMGT iÃ§in otomatik stok_kodu oluÅŸturuldu: ${ymGtStokKodu}`);
            }
          } else {
            console.error(`YMGT veritabanÄ±ndan alÄ±namadÄ±! ID: ${ymGtId}`);
            // API 404 hatasÄ± durumunda otomatik kod oluÅŸtur
            const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
            ymGtStokKodu = `YM.GT.${mmGtData.kod_2}.${capFormatted}.${mmGtSequence}`;
            console.log(`YMGT iÃ§in otomatik stok_kodu oluÅŸturuldu: ${ymGtStokKodu}`);
          }
        } catch (error) {
          console.error(`YMGT bilgileri alÄ±nÄ±rken hata: ${error.message}`);
          // Hata durumunda otomatik kod oluÅŸtur
          const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
          ymGtStokKodu = `YM.GT.${mmGtData.kod_2}.${capFormatted}.${mmGtSequence}`;
          console.log(`YMGT iÃ§in otomatik stok_kodu oluÅŸturuldu: ${ymGtStokKodu}`);
        }
      }
      
      console.log(`REÃ‡ETELER Ä°Ã‡Ä°N KULLANILACAK SEQUENCE: ${mmGtSequence}`);
      console.log(`MMGT MAMUL_KODU: ${mmGtStokKodu}`);
      console.log(`YMGT MAMUL_KODU: ${ymGtStokKodu}`);
      
      // Sadece 1 MM GT reÃ§etesini kaydet
      if (mmGtIds.length > 0) {
        // mmGtStokKodu null ise oluÅŸtur
        if (!mmGtStokKodu) {
          const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
          mmGtStokKodu = `GT.${mmGtData.kod_2}.${capFormatted}.00`;
          mmGtSequence = '00';
          console.log(`MMGT iÃ§in yedek stok_kodu oluÅŸturuldu: ${mmGtStokKodu}`);
        }
        
        const mmGtId = mmGtIds[0]; // ArtÄ±k sadece 1 tane MM GT var
        const mmGtRecipe = allRecipes.mmGtRecipes[mainYmStIndex] || {}; // Ana YM ST'ye baÄŸlÄ± MM GT reÃ§etesi
        
        console.log(`MMGT reÃ§eteleri iÃ§in ID: ${mmGtId}, stok_kodu: ${mmGtStokKodu}, sequence: ${mmGtSequence}`);
        
        // MMGT iÃ§in mevcut tÃ¼m reÃ§eteleri kontrol et ve sil
        try {
          // 1. TÃ¼m mevcut reÃ§eteleri getir
          const allRecipesResponse = await fetchWithAuth(`${API_URLS.galMmGtRecete}?mm_gt_id=${mmGtId}`);
          if (allRecipesResponse && allRecipesResponse.ok) {
            const allRecipesData = await allRecipesResponse.json();
            console.log(`${allRecipesData.length} adet MMGT reÃ§etesi bulundu`);
            
            // 2. Her reÃ§eteyi kontrol et, yanlÄ±ÅŸ mamul_kodu veya bilesen_kodu iÃ§erenleri sil
            for (const recipe of allRecipesData) {
              // mamul_kodu mmGtStokKodu ile aynÄ± deÄŸilse sil
              if (recipe.mamul_kodu !== mmGtStokKodu) {
                console.log(`YANLIÅž MAMUL_KODU MMGT reÃ§etesi siliniyor: ID=${recipe.id}, mamul_kodu=${recipe.mamul_kodu}, doÄŸrusu=${mmGtStokKodu}`);
                try {
                  await fetchWithAuth(`${API_URLS.galMmGtRecete}/${recipe.id}`, { method: 'DELETE' });
                } catch (deleteError) {
                  console.error(`MMGT reÃ§etesi silinemedi: ${deleteError.message}`);
                }
              }
            }
          } else {
            console.log(`MMGT iÃ§in reÃ§ete bulunamadÄ± - 404 hatasÄ± olabilir`);
          }
        } catch (error) {
          console.error('MMGT reÃ§eteleri kontrol edilirken hata:', error);
          // Hata durumunda iÅŸleme devam et
        }
        
        // TÃ¼m mevcut reÃ§eteleri sil - gÃ¼venlik iÃ§in
        await deleteExistingRecipes('mmgt', mmGtId);
        
        let siraNo = 1;
        const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
        
        // KRÄ°TÄ°K: mamul_kodu kesinlikle ve kesinlikle MMGT stok kartÄ± tablosundaki stok_kodu ile aynÄ± olmalÄ±
        const mamulKodu = mmGtStokKodu;
        console.log(`MMGT REÃ‡ETELERÄ° Ä°Ã‡Ä°N KULLANILACAK MAMUL_KODU: ${mamulKodu} (sequence: ${mmGtSequence})`);
        
        // Son bir kontrol: mmGtStokKodu boÅŸ olmamalÄ± ve doÄŸru formatta olmalÄ±
        if (!mamulKodu || !mamulKodu.includes('.')) {
          console.error(`HATA! GeÃ§ersiz MMGT stok_kodu: ${mamulKodu}`);
          throw new Error(`GeÃ§ersiz MMGT stok_kodu: ${mamulKodu}`);
        }
        
        console.log(`MMGT reÃ§ete iÃ§in kullanÄ±lacak mamul_kodu: ${mamulKodu} (sequence: ${mmGtSequence})`);
        
        // Son bir kontrol: sequence doÄŸru mu?
        const recordSequence = mamulKodu.split('.').pop();
        if (recordSequence !== mmGtSequence) {
          console.error(`UYARI! Sequence tutarsÄ±zlÄ±ÄŸÄ±: ReÃ§ete iÃ§in ${recordSequence}, Stok iÃ§in ${mmGtSequence}`);
        }
        
        // MMGT reÃ§ete sÄ±ralamasÄ±: 1) YM.GT bileÅŸeni, 2) GTPKT01 operasyonu, 3) diÄŸer bileÅŸenler
        const recipeEntries = Object.entries(mmGtRecipe);
        const ymGtEntry = recipeEntries.find(([key]) => key.includes('YM.GT.'));
        const operationEntry = recipeEntries.find(([key]) => key === 'GTPKT01');
        const otherEntries = recipeEntries.filter(([key]) => !key.includes('YM.GT.') && key !== 'GTPKT01');
        
        // SÄ±rayla ekle
        const orderedEntries = [ymGtEntry, operationEntry, ...otherEntries].filter(Boolean);
        
        for (const [key, value] of orderedEntries) {
          if (value > 0) {
            // Operasyon/BileÅŸen sÄ±nÄ±flandÄ±rmasÄ± dÃ¼zeltmesi
            const operasyonBilesen = (key === 'GTPKT01' || key === 'GLV01' || key === 'TLC01') ? 'Operasyon' : 'BileÅŸen';
            
            // Format the value exactly as it would appear in Excel, using points as decimal separators
            let formattedValue = value;
            if (typeof value === 'number') {
              formattedValue = value.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 5,
                useGrouping: false // No thousand separators
              });
            }
            
            // Son bir kontrol: mamulKodu'nun sequence'ini doÄŸrula
            const recordSequence = mamulKodu.split('.').pop();
            if (recordSequence !== mmGtSequence) {
              console.error(`Sequence uyuÅŸmazlÄ±ÄŸÄ±! ReÃ§ete kaydediliyor: ${recordSequence}, olmasÄ± gereken: ${mmGtSequence}`);
            }
            
            console.log(`MMGT reÃ§ete kaydÄ±: ${mmGtId}, ${mamulKodu}, ${key}, ${formattedValue}`);
            
            // BURADA Ã–NEMLÄ°: MMGT reÃ§eteleri iÃ§in her zaman doÄŸru sequence'i iÃ§eren mamul_kodu kullanmak Ã§ok Ã¶nemli
            console.log(`MMGT REÃ‡ETE EKLEME (FIX): mamul_kodu=${mamulKodu}, bilesen_kodu=${key}, mm_gt_id=${mmGtId}`);
            
            // TÃ¼m parametreleri logla
            const receteParams = {
              mm_gt_id: mmGtId,
              mamul_kodu: mamulKodu, // Ã–NEMLÄ°: Her zaman doÄŸru sequence ile gÃ¼ncel mamul_kodu
              bilesen_kodu: key,
              miktar: formattedValue,
              sira_no: siraNo++,
              operasyon_bilesen: operasyonBilesen,
              olcu_br: getOlcuBr(key),
            };
            console.log("REÃ‡ETE PARAMETRE KONTROLÃœ:", JSON.stringify(receteParams));
            
            // BaÅŸka bir reÃ§ete ile Ã§akÄ±ÅŸma olabilir mi kontrol et
            try {
              const checkResponse = await fetchWithAuth(`${API_URLS.galMmGtRecete}?mm_gt_id=${mmGtId}`);
              if (checkResponse && checkResponse.ok) {
                const existingRecipes = await checkResponse.json();
                const conflictRecipe = existingRecipes.find(r => r.bilesen_kodu === key && r.mamul_kodu !== mamulKodu);
                if (conflictRecipe) {
                  console.error(`Ã‡AKIÅžMA! FarklÄ± mamul_kodu ile reÃ§ete mevcut: ${conflictRecipe.mamul_kodu} (silinecek)`);
                  try {
                    await fetchWithAuth(`${API_URLS.galMmGtRecete}/${conflictRecipe.id}`, { method: 'DELETE' });
                  } catch (deleteError) {
                    console.error(`Ã‡akÄ±ÅŸan MMGT reÃ§etesi silinemedi: ${deleteError.message}`);
                  }
                }
              }
            } catch (checkError) {
              console.error(`MMGT reÃ§eteleri kontrol edilirken hata: ${checkError.message}`);
              // Hataya raÄŸmen devam et
            }
            
            try {
              console.log(`MMGT reÃ§etesi kaydediliyor: ${mmGtId}, ${mamulKodu}, ${key}`);
              const receteResponse = await fetchWithAuth(API_URLS.galMmGtRecete, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  ...receteParams,
                  olcu_br_bilesen: '1',
                  aciklama: getReceteAciklama(key),
                  ua_dahil_edilsin: 'evet',
                  son_operasyon: 'evet',
                  recete_top: 1,
                  fire_orani: 0.0004, // Match Excel format
                  // Additional fields for better Netsis compatibility - match Excel
                  miktar_sabitle: 'H',
                  stok_maliyet: 'S',
                  fire_mik: '0',
                  sabit_fire_mik: '0',
                  istasyon_kodu: '',
                  hazirlik_suresi: key.includes('01') ? 0 : null,
                  uretim_suresi: key.includes('01') ? formattedValue : null, // Use formatted value
                  oncelik: '0',
                  planlama_orani: '100',
                  alt_pol_da_transfer: 'H',
                  alt_pol_ambar_cikis: 'H',
                  alt_pol_uretim_kaydi: 'H',
                  alt_pol_mrp: 'H',
                  ic_dis: 'I'
                })
              });
              
              if (receteResponse && receteResponse.ok) {
                console.log(`MMGT reÃ§etesi baÅŸarÄ±yla kaydedildi: ${key}`);
              } else {
                console.error(`MMGT reÃ§etesi kaydedilemedi: ${key}`);
              }
            } catch (saveError) {
              console.error(`MMGT reÃ§etesi kaydedilirken hata: ${saveError.message}`);
              // Hataya raÄŸmen devam et
            }
          }
        }
      }
      
      // Sadece 1 YM GT iÃ§in reÃ§ete kaydet - Excel formatÄ±yla tam uyumlu
      if (ymGtId && Object.keys(allRecipes.ymGtRecipe).length > 0) {
        // ymGtStokKodu null ise oluÅŸtur
        if (!ymGtStokKodu) {
          const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
          ymGtStokKodu = `YM.GT.${mmGtData.kod_2}.${capFormatted}.${mmGtSequence}`;
          console.log(`YMGT iÃ§in yedek stok_kodu oluÅŸturuldu: ${ymGtStokKodu}`);
        }
        
        console.log(`YMGT reÃ§eteleri iÃ§in ID: ${ymGtId}, stok_kodu: ${ymGtStokKodu}, sequence: ${ymGtSequence}`);
        
        // MMGT ve YMGT sequence deÄŸerlerini karÅŸÄ±laÅŸtÄ±r ve gerekirse YMGT'yi gÃ¼ncelle
        if (mmGtSequence !== ymGtSequence && mmGtSequence !== '00') {
          console.error(`UYARI! YMGT sequence (${ymGtSequence}) ile MMGT sequence (${mmGtSequence}) eÅŸleÅŸmiyor!`);
          
          // YMGT'yi MMGT ile aynÄ± sequence'e gÃ¼ncelle
          const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
          const updatedYmGtStokKodu = `YM.GT.${mmGtData.kod_2}.${capFormatted}.${mmGtSequence}`;
          
          try {
            console.warn(`YMGT stok_kodu dÃ¼zeltiliyor: ${ymGtStokKodu} â†’ ${updatedYmGtStokKodu}`);
            
            await fetchWithAuth(`${API_URLS.galYmGt}/${ymGtId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                ...generateYmGtDatabaseData(mmGtSequence),
                stok_kodu: updatedYmGtStokKodu
              })
            });
            
            // GÃ¼ncellenmiÅŸ kodu kullan
            ymGtStokKodu = updatedYmGtStokKodu;
            ymGtSequence = mmGtSequence;
            
            console.log(`YMGT stok_kodu gÃ¼ncellendi: ${ymGtStokKodu}`);
          } catch (updateError) {
            console.error(`YMGT gÃ¼ncellenirken hata: ${updateError.message}`);
          }
        }
        
        // Son kontrol: ymGtStokKodu geÃ§erli olmalÄ±
        if (!ymGtStokKodu || !ymGtStokKodu.includes('.')) {
          console.error(`HATA! GeÃ§ersiz YMGT stok_kodu: ${ymGtStokKodu}`);
          throw new Error(`GeÃ§ersiz YMGT stok_kodu: ${ymGtStokKodu}`);
        }
        
        // YMGT iÃ§in mevcut tÃ¼m reÃ§eteleri kontrol et ve sil
        try {
          // 1. TÃ¼m mevcut reÃ§eteleri getir
          const allRecipesResponse = await fetchWithAuth(`${API_URLS.galYmGtRecete}?ym_gt_id=${ymGtId}`);
          if (allRecipesResponse && allRecipesResponse.ok) {
            const allRecipesData = await allRecipesResponse.json();
            console.log(`${allRecipesData.length} adet YMGT reÃ§etesi bulundu`);
            
            // 2. Her reÃ§eteyi kontrol et, yanlÄ±ÅŸ mamul_kodu iÃ§erenleri sil
            for (const recipe of allRecipesData) {
              // mamul_kodu ymGtStokKodu ile aynÄ± deÄŸilse sil
              if (recipe.mamul_kodu !== ymGtStokKodu) {
                console.log(`YANLIÅž MAMUL_KODU YMGT reÃ§etesi siliniyor: ID=${recipe.id}, mamul_kodu=${recipe.mamul_kodu}, doÄŸrusu=${ymGtStokKodu}`);
                try {
                  await fetchWithAuth(`${API_URLS.galYmGtRecete}/${recipe.id}`, { method: 'DELETE' });
                } catch (deleteError) {
                  console.error(`YMGT reÃ§etesi silinemedi: ${deleteError.message}`);
                }
              }
            }
          } else {
            console.log(`YMGT iÃ§in reÃ§ete bulunamadÄ± - 404 hatasÄ± olabilir`);
          }
        } catch (error) {
          console.error('YMGT reÃ§eteleri kontrol edilirken hata:', error);
          // Hata durumunda iÅŸleme devam et
        }
        
        // GÃ¼venlik iÃ§in tÃ¼m reÃ§eteleri temizle
        await deleteExistingRecipes('ymgt', ymGtId);
        
        console.log(`YMGT REÃ‡ETELERÄ° Ä°Ã‡Ä°N KULLANILACAK MAMUL_KODU: ${ymGtStokKodu} (sequence: ${ymGtSequence})`);
        
        // YM GT'yi bul - oluÅŸturulmuÅŸ stok kodu ile
        const existingYmGt = await checkExistingProduct(API_URLS.galYmGt, ymGtStokKodu);
        
        if (existingYmGt) {
          // Ã–NEMLÄ°: Ã–nce reÃ§eteleri sil, her durumda mevcut reÃ§eteleri silip yeniden oluÅŸtur
          console.log(`YMGT reÃ§eteleri siliniyor: YMGT ID=${existingYmGt.id}`);
          await deleteExistingRecipes('ymgt', existingYmGt.id);
          
          let siraNo = 1;
          
          // YMGT reÃ§ete sÄ±ralamasÄ±: 1) YM.ST bileÅŸeni (ana YM ST), 2) GLV01 operasyonu, 3) diÄŸer bileÅŸenler
          const recipeEntries = Object.entries(allRecipes.ymGtRecipe);
          const ymStEntry = recipeEntries.find(([key]) => key.includes('YM.ST.') || key === mainYmSt.stok_kodu);
          const operationEntry = recipeEntries.find(([key]) => key === 'GLV01');
          const otherEntries = recipeEntries.filter(([key]) => !key.includes('YM.ST.') && key !== 'GLV01' && key !== mainYmSt.stok_kodu);
          
          // SÄ±rayla ekle
          const orderedEntries = [
            ymStEntry ? [mainYmSt.stok_kodu, ymStEntry[1]] : null, // Ana YM ST'yi kullan
            operationEntry,
            ...otherEntries
          ].filter(Boolean);
          
          for (const [key, value] of orderedEntries) {
            if (value > 0) {
              // Format the value exactly as it would appear in Excel, using points as decimal separators
              let formattedValue = value;
              if (typeof value === 'number') {
                formattedValue = value.toLocaleString('en-US', {
                  minimumFractionDigits: 0,
                  maximumFractionDigits: 5,
                  useGrouping: false // No thousand separators
                });
              }
              
              // Son bir kontrol: ymGtStokKodu'nun sequence'ini doÄŸrula
              const recordSequence = ymGtStokKodu.split('.').pop();
              if (recordSequence !== mmGtSequence) {
                console.error(`YMGT Sequence uyuÅŸmazlÄ±ÄŸÄ±! ReÃ§ete kaydediliyor: ${recordSequence}, olmasÄ± gereken: ${mmGtSequence}`);
                
                // Sequence farklÄ±ysa doÄŸru sequence ile dÃ¼zelt - Ã‡OK Ã–NEMLÄ°
                const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
                const updatedYmGtStokKodu = `YM.GT.${mmGtData.kod_2}.${capFormatted}.${mmGtSequence}`;
                
                // YMGT veritabanÄ±ndaki kaydÄ± gÃ¼ncelle
                try {
                  console.warn(`YMGT stok_kodu son kez dÃ¼zeltiliyor: ${ymGtStokKodu} â†’ ${updatedYmGtStokKodu}`);
                  
                  await fetchWithAuth(`${API_URLS.galYmGt}/${ymGtId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      ...generateYmGtDatabaseData(mmGtSequence),
                      stok_kodu: updatedYmGtStokKodu
                    })
                  });
                  
                  // GÃ¼ncellenmiÅŸ kodu kullan
                  ymGtStokKodu = updatedYmGtStokKodu;
                  console.log(`YMGT stok_kodu gÃ¼ncellendi: ${ymGtStokKodu}`);
                } catch (updateError) {
                  console.error(`YMGT kaydÄ± gÃ¼ncellenirken hata: ${updateError.message}`);
                }
              }
              
              console.log(`YMGT reÃ§ete kaydÄ±: ${existingYmGt.id}, ${ymGtStokKodu}, ${key}, ${formattedValue}`);
              
              // BURADA Ã–NEMLÄ°: YMGT reÃ§eteleri iÃ§in her zaman doÄŸru sequence'i iÃ§eren mamul_kodu kullanmak Ã§ok Ã¶nemli
              console.log(`YMGT REÃ‡ETE EKLEME (FIX): mamul_kodu=${ymGtStokKodu}, bilesen_kodu=${key}, ym_gt_id=${existingYmGt.id}`);
              
              // Son bir kez daha kontrol et - YMGT'nin stok_kodu ile tamamÄ±yla aynÄ± olmasÄ±nÄ± garantile
              const doubleCheckYmGtResponse = await fetchWithAuth(`${API_URLS.galYmGt}/${existingYmGt.id}`);
              if (doubleCheckYmGtResponse && doubleCheckYmGtResponse.ok) {
                const doubleCheckYmGt = await doubleCheckYmGtResponse.json();
                if (doubleCheckYmGt && doubleCheckYmGt.stok_kodu) {
                  if (doubleCheckYmGt.stok_kodu !== ymGtStokKodu) {
                    console.warn(`UYARI! YMGT stok_kodu (${doubleCheckYmGt.stok_kodu}) ile reÃ§ete mamul_kodu (${ymGtStokKodu}) eÅŸleÅŸmiyor!`);
                    
                    // TutarsÄ±zlÄ±ÄŸÄ± Ã§Ã¶z - stok tablosundaki kodu kullanmak yerine, stok tablosunu dÃ¼zeltmeyi dene
                    const dbSequence = doubleCheckYmGt.stok_kodu.split('.').pop();
                    if (dbSequence !== mmGtSequence) {
                      // MMGT'den gelen sequence'i kullanmalÄ±yÄ±z - veritabanÄ±nÄ± dÃ¼zelt!
                      try {
                        console.warn(`YMGT stok tablosundaki kaydÄ± dÃ¼zeltme giriÅŸimi: ${doubleCheckYmGt.stok_kodu} â†’ ${ymGtStokKodu}`);
                        
                        await fetchWithAuth(`${API_URLS.galYmGt}/${existingYmGt.id}`, {
                          method: 'PUT',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({
                            ...generateYmGtDatabaseData(mmGtSequence),
                            stok_kodu: ymGtStokKodu
                          })
                        });
                        
                        console.log(`YMGT stok tablosu doÄŸru sequence (${mmGtSequence}) ile gÃ¼ncellendi: ${ymGtStokKodu}`);
                      } catch (error) {
                        console.error(`YMGT stok tablosu gÃ¼ncellenirken hata: ${error.message}`);
                        
                        // GÃ¼ncellenemezse mevcut veritabanÄ± kodunu kullan
                        ymGtStokKodu = doubleCheckYmGt.stok_kodu;
                        console.log(`YMGT reÃ§etesi iÃ§in veritabanÄ±ndaki stok_kodu kullanÄ±lacak: ${ymGtStokKodu}`);
                      }
                    } else {
                      // EÅŸit sequence deÄŸerleri, ama farklÄ± stok_kodu - veritabanÄ±ndaki kodu kullan
                      ymGtStokKodu = doubleCheckYmGt.stok_kodu;
                      console.log(`YMGT reÃ§etesi iÃ§in veritabanÄ±ndaki stok_kodu kullanÄ±lacak: ${ymGtStokKodu}`);
                    }
                  } else {
                    console.log(`ONAY: YMGT stok_kodu ve reÃ§ete mamul_kodu eÅŸleÅŸiyor: ${ymGtStokKodu}`);
                  }
                } else {
                  console.warn(`UYARI: YMGT stok kaydÄ±nda stok_kodu bulunamadÄ±!`);
                }
              } else {
                console.warn(`UYARI: YMGT stok kaydÄ±na eriÅŸilemedi!`);
              }
              
              // TÃ¼m parametreleri logla
              const receteParams = {
                ym_gt_id: existingYmGt.id,
                mamul_kodu: ymGtStokKodu, // Ã–NEMLÄ°: Her zaman doÄŸru sequence ile gÃ¼ncel mamul_kodu
                bilesen_kodu: key,
                miktar: formattedValue,
                sira_no: siraNo++,
                operasyon_bilesen: key.includes('01') ? 'Operasyon' : 'BileÅŸen',
                olcu_br: getOlcuBr(key),
              };
              console.log("YMGT REÃ‡ETE PARAMETRE KONTROLÃœ:", JSON.stringify(receteParams));
              
              // BaÅŸka bir reÃ§ete ile Ã§akÄ±ÅŸma olabilir mi kontrol et
              try {
                const checkResponse = await fetchWithAuth(`${API_URLS.galYmGtRecete}?ym_gt_id=${existingYmGt.id}`);
                if (checkResponse && checkResponse.ok) {
                  const existingRecipes = await checkResponse.json();
                  const conflictRecipe = existingRecipes.find(r => r.bilesen_kodu === key && r.mamul_kodu !== ymGtStokKodu);
                  if (conflictRecipe) {
                    console.error(`Ã‡AKIÅžMA! FarklÄ± mamul_kodu ile YMGT reÃ§ete mevcut: ${conflictRecipe.mamul_kodu} (silinecek)`);
                    try {
                      await fetchWithAuth(`${API_URLS.galYmGtRecete}/${conflictRecipe.id}`, { method: 'DELETE' });
                    } catch (deleteError) {
                      console.error(`Ã‡akÄ±ÅŸan YMGT reÃ§etesi silinemedi: ${deleteError.message}`);
                    }
                  }
                }
              } catch (checkError) {
                console.error(`YMGT reÃ§eteleri kontrol edilirken hata: ${checkError.message}`);
                // Hataya raÄŸmen devam et
              }
              
              try {
                console.log(`YMGT reÃ§etesi kaydediliyor: ${existingYmGt.id}, ${ymGtStokKodu}, ${key}`);
                const receteResponse = await fetchWithAuth(API_URLS.galYmGtRecete, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    ...receteParams,
                    olcu_br_bilesen: '1',
                    aciklama: getReceteAciklama(key),
                    recete_top: 1,
                    fire_orani: 0.0004, // Match Excel format
                    ua_dahil_edilsin: 'evet',
                    son_operasyon: 'evet',
                    // Additional fields for better Netsis compatibility - match Excel format
                    miktar_sabitle: 'H',
                    stok_maliyet: 'S',
                    fire_mik: '0',
                    sabit_fire_mik: '0',
                    istasyon_kodu: '',
                    hazirlik_suresi: key.includes('01') ? 0 : null,
                    uretim_suresi: key.includes('01') ? formattedValue : null, // Use formatted value
                    oncelik: '0',
                    planlama_orani: '100',
                    alt_pol_da_transfer: 'H',
                    alt_pol_ambar_cikis: 'H',
                    alt_pol_uretim_kaydi: 'H',
                    alt_pol_mrp: 'H',
                    ic_dis: 'I'
                  })
                });
                
                if (receteResponse && receteResponse.ok) {
                  console.log(`YMGT reÃ§etesi baÅŸarÄ±yla kaydedildi: ${key}`);
                } else {
                  console.error(`YMGT reÃ§etesi kaydedilemedi: ${key}`);
                }
              } catch (saveError) {
                console.error(`YMGT reÃ§etesi kaydedilirken hata: ${saveError.message}`);
                // Hataya raÄŸmen devam et
              }
            }
          }
        }
      }
      
      // TÃ¼m YM ST reÃ§etelerini kaydet - Excel formatÄ±yla tam uyumlu
      for (let i = 0; i < ymStIds.length; i++) {
        const ymStId = ymStIds[i];
        const ymSt = [...selectedYmSts, ...autoGeneratedYmSts][i];
        const ymStRecipe = allRecipes.ymStRecipes[i] || {};
        
        await deleteExistingRecipes('ymst', ymStId);
        
        let siraNo = 1;
        
        // YMST reÃ§ete sÄ±ralamasÄ±: 1) FLM bileÅŸeni, 2) TLC01 operasyonu
        const recipeEntries = Object.entries(ymStRecipe);
        const flmEntry = recipeEntries.find(([key]) => key.includes('FLM.'));
        const operationEntry = recipeEntries.find(([key]) => key === 'TLC01');
        
        // SÄ±rayla ekle
        const orderedEntries = [flmEntry, operationEntry].filter(Boolean);
        
        for (const [key, value] of orderedEntries) {
          if (value > 0) {
            // Format the value exactly as it would appear in Excel, using points as decimal separators
            let formattedValue = value;
            if (typeof value === 'number') {
              formattedValue = value.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 5,
                useGrouping: false // No thousand separators
              });
            }
            
            try {
              console.log(`YMST reÃ§etesi kaydediliyor: ${ymStId}, ${ymSt.stok_kodu}, ${key}`);
              const receteResponse = await fetchWithAuth(API_URLS.galYmStRecete, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  ym_st_id: ymStId,
                  mamul_kodu: ymSt.stok_kodu,
                  bilesen_kodu: key,
                  miktar: formattedValue, // Use formatted value to match Excel
                  sira_no: siraNo++,
                  operasyon_bilesen: key.includes('01') ? 'Operasyon' : 'BileÅŸen',
                  olcu_br: getOlcuBr(key),
                  olcu_br_bilesen: '1',
                  aciklama: getReceteAciklama(key),
                  recete_top: 1,
                  fire_orani: 0.0004, // Match Excel format
                  ua_dahil_edilsin: 'evet',
                  son_operasyon: 'evet',
                  // Additional fields for better Netsis compatibility - match Excel
                  miktar_sabitle: 'H',
                  stok_maliyet: 'S',
                  fire_mik: '0',
                  sabit_fire_mik: '0',
                  istasyon_kodu: '',
                  hazirlik_suresi: key.includes('01') ? 0 : null,
                  uretim_suresi: key.includes('01') ? formattedValue : null, // Use formatted value
                  oncelik: '0',
                  planlama_orani: '100',
                  alt_pol_da_transfer: 'H',
                  alt_pol_ambar_cikis: 'H',
                  alt_pol_uretim_kaydi: 'H',
                  alt_pol_mrp: 'H',
                  ic_dis: 'I'
                })
              });
              
              if (receteResponse && receteResponse.ok) {
                console.log(`YMST reÃ§etesi baÅŸarÄ±yla kaydedildi: ${key}`);
              } else {
                console.error(`YMST reÃ§etesi kaydedilemedi: ${key}`);
              }
            } catch (saveError) {
              console.error(`YMST reÃ§etesi kaydedilirken hata: ${saveError.message}`);
              // Hataya raÄŸmen devam et
            }
          }
        }
      }
    } catch (error) {
      console.error('ReÃ§ete kaydetme hatasÄ±:', error);
      throw error;
    }
  };  /**
   * MMGT ve YMGT reÃ§eteleri iÃ§in stok kodu kontrolÃ¼ ve dÃ¼zeltme
   * Bu fonksiyon, mamul_kodu ile eÅŸleÅŸmeyen reÃ§eteleri siler
   */
  const checkAndFixStokKodu = async (productType, productId, expectedStokKodu) => {
    if (!productId || !expectedStokKodu) {
      console.error(`${productType} ID veya stok_kodu eksik!`);
      return;
    }
    
    let apiUrl = '';
    let paramName = '';
    
    if (productType === 'mmgt') {
      apiUrl = API_URLS.galMmGtRecete;
      paramName = 'mm_gt_id';
    } else if (productType === 'ymgt') {
      apiUrl = API_URLS.galYmGtRecete;
      paramName = 'ym_gt_id';
    } else {
      console.error(`GeÃ§ersiz Ã¼rÃ¼n tipi: ${productType}`);
      return;
    }
    
    try {
      // URL'yi doÄŸru oluÅŸtur - sorgu parametre adÄ±nÄ± ve Ã¼rÃ¼n ID'sini kontrol et
      const queryUrl = `${apiUrl}?${paramName}=${encodeURIComponent(productId)}`;
      console.log(`ðŸ” ${productType.toUpperCase()} reÃ§eteleri kontrol ediliyor. Sorgu URL: ${queryUrl}`);
      
      // TÃ¼m mevcut reÃ§eteleri getir
      const allRecipesResponse = await fetchWithAuth(queryUrl);
      
      if (allRecipesResponse && allRecipesResponse.ok) {
        const allRecipesData = await allRecipesResponse.json();
        console.log(`${allRecipesData.length} adet ${productType.toUpperCase()} reÃ§etesi bulundu`);
        
        // Her reÃ§eteyi kontrol et, yanlÄ±ÅŸ mamul_kodu iÃ§erenleri sil
        for (const recipe of allRecipesData) {
          if (recipe.mamul_kodu !== expectedStokKodu) {
            console.log(`YANLIÅž MAMUL_KODU ${productType.toUpperCase()} reÃ§etesi siliniyor: ID=${recipe.id}, mamul_kodu=${recipe.mamul_kodu}, doÄŸrusu=${expectedStokKodu}`);
            try {
              await fetchWithAuth(`${apiUrl}/${recipe.id}`, { method: 'DELETE' });
            } catch (deleteError) {
              console.error(`${productType.toUpperCase()} reÃ§etesi silinemedi: ${deleteError.message}`);
            }
          }
        }
      } else {
        if (allRecipesResponse && allRecipesResponse.status === 404) {
          console.log(`${productType.toUpperCase()} iÃ§in reÃ§ete bulunamadÄ± (404) - silinecek reÃ§ete yok`);
        } else {
          console.warn(`${productType.toUpperCase()} reÃ§eteleri alÄ±namadÄ±: HTTP ${allRecipesResponse ? allRecipesResponse.status : 'unknown'}`);
          
          // Alternatif yaklaÅŸÄ±m: tÃ¼m reÃ§eteleri getir ve filtrele
          try {
            console.log(`ðŸ”„ Alternatif yÃ¶ntem: TÃ¼m ${productType.toUpperCase()} reÃ§etelerini getirip filtreleme deneniyor...`);
            const alternativeResponse = await fetchWithAuth(apiUrl);
            
            if (alternativeResponse && alternativeResponse.ok) {
              const allRecipes = await alternativeResponse.json();
              const filteredRecipes = allRecipes.filter(recipe => recipe[paramName] === productId);
              
              console.log(`âœ… Alternatif yÃ¶ntemle ${filteredRecipes.length} reÃ§ete bulundu`);
              
              // YanlÄ±ÅŸ mamul_kodu iÃ§eren reÃ§eteleri sil
              for (const recipe of filteredRecipes) {
                if (recipe.mamul_kodu !== expectedStokKodu) {
                  console.log(`YANLIÅž MAMUL_KODU ${productType.toUpperCase()} reÃ§etesi siliniyor: ID=${recipe.id}, mamul_kodu=${recipe.mamul_kodu}, doÄŸrusu=${expectedStokKodu}`);
                  try {
                    await fetchWithAuth(`${apiUrl}/${recipe.id}`, { method: 'DELETE' });
                  } catch (deleteError) {
                    console.error(`${productType.toUpperCase()} reÃ§etesi silinemedi: ${deleteError.message}`);
                  }
                }
              }
            } else {
              console.warn(`Alternatif yÃ¶ntemle de ${productType.toUpperCase()} reÃ§eteleri alÄ±namadÄ±`);
            }
          } catch (alternativeError) {
            console.error(`Alternatif yÃ¶ntem hatasÄ±:`, alternativeError.message);
          }
        }
      }
    } catch (error) {
      console.error(`${productType.toUpperCase()} reÃ§eteleri kontrol edilirken hata:`, error);
      // Hata durumunda iÅŸleme devam et
    }
  };

  // Mevcut reÃ§eteleri sil - 404 hata yÃ¶netimi ile geliÅŸtirilmiÅŸ versiyon
  const deleteExistingRecipes = async (type, productId) => {
    try {
      if (!productId) {
        console.log(`ÃœrÃ¼n ID'si geÃ§ersiz, reÃ§ete silme iÅŸlemi atlanÄ±yor`);
        return;
      }
      
      let apiUrl = '';
      let paramName = '';
      let typeLabel = '';
      
      if (type === 'mmgt') {
        apiUrl = API_URLS.galMmGtRecete;
        paramName = 'mm_gt_id';
        typeLabel = 'MMGT';
      } else if (type === 'ymgt') {
        apiUrl = API_URLS.galYmGtRecete;
        paramName = 'ym_gt_id';
        typeLabel = 'YMGT';
      } else if (type === 'ymst') {
        apiUrl = API_URLS.galYmStRecete;
        paramName = 'ym_st_id';
        typeLabel = 'YMST';
      }
      
      console.log(`${typeLabel} reÃ§eteleri aranÄ±yor: ${paramName}=${productId}`);
      
      // URL'yi doÄŸru oluÅŸtur - sorgu parametre adÄ±nÄ± ve Ã¼rÃ¼n ID'sini kontrol et
      const queryUrl = `${apiUrl}?${paramName}=${encodeURIComponent(productId)}`;
      console.log(`ðŸ” Sorgu URL: ${queryUrl}`);
      
      // 404 hata durumunda alternatif yÃ¶ntem kullan
      let recipes = [];
      try {
        const response = await fetchWithAuth(queryUrl);
        
        // YanÄ±t varsa ve baÅŸarÄ±lÄ±ysa
        if (response && response.ok) {
          recipes = await response.json();
          console.log(`${typeLabel} iÃ§in ${recipes.length} reÃ§ete bulundu`);
        } 
        // 404 hatasÄ± veya baÅŸka bir hata durumunda
        else {
          const status = response ? response.status : 'unknown';
          console.log(`${typeLabel} iÃ§in reÃ§ete bulunamadÄ± - ${status} yanÄ±tÄ± alÄ±ndÄ±`);
          
          // 404 hatasÄ± durumunda boÅŸ dizi dÃ¶ndÃ¼r ve iÅŸleme devam et
          if (status === 404) {
            console.log(`${typeLabel} iÃ§in reÃ§ete bulunamadÄ± (404) - yeni reÃ§eteler oluÅŸturulacak`);
            return; // HiÃ§ reÃ§ete yoksa silmeye gerek yok
          }
        }
      } catch (fetchError) {
        console.error(`${typeLabel} reÃ§eteleri aranÄ±rken hata:`, fetchError.message);
        
        // HATA DURUMUNDA ALTERNATIF YÃ–NTEM: TÃ¼m reÃ§ete listesini getir ve filtrele
        try {
          console.log(`ðŸ”„ Alternatif yÃ¶ntem: TÃ¼m ${typeLabel} reÃ§etelerini getirip filtreleme deneniyor...`);
          const allRecipesResponse = await fetchWithAuth(`${apiUrl}`);
          
          if (allRecipesResponse && allRecipesResponse.ok) {
            const allRecipes = await allRecipesResponse.json();
            if (Array.isArray(allRecipes) && allRecipes.length > 0) {
              // Ä°lgili Ã¼rÃ¼ne ait reÃ§eteleri filtrele
              recipes = allRecipes.filter(recipe => recipe[paramName] === productId);
              console.log(`âœ… Alternatif yÃ¶ntemle ${recipes.length} reÃ§ete bulundu`);
            } else {
              console.log(`${typeLabel} tablosunda hiÃ§ reÃ§ete bulunmadÄ± - silmeye gerek yok`);
              return;
            }
          } else {
            console.log(`TÃ¼m ${typeLabel} reÃ§eteleri getirilemedi - silme iÅŸlemi atlanÄ±yor`);
            return;
          }
        } catch (alternativeError) {
          console.error(`Alternatif yÃ¶ntem hatasÄ±:`, alternativeError.message);
          // Hata durumunda iÅŸleme devam et - reÃ§eteler boÅŸ dizi olarak kalsÄ±n
          console.log(`Hata nedeniyle ${typeLabel} reÃ§eteleri silinemeyecek - iÅŸleme devam ediliyor`);
          return;
        }
      }
      
      // EÄŸer hiÃ§ reÃ§ete bulunmazsa mesaj gÃ¶ster ve Ã§Ä±k
      if (!recipes || recipes.length === 0) {
        console.log(`${typeLabel} iÃ§in silinecek reÃ§ete bulunamadÄ±`);
        return;
      }
      
      // ReÃ§eteleri tek tek silmeyi dene
      let successCount = 0;
      let errorCount = 0;
      
      for (const recipe of recipes) {
        console.log(`${typeLabel} reÃ§ete siliniyor: ID=${recipe.id}, mamul_kodu=${recipe.mamul_kodu}, bilesen_kodu=${recipe.bilesen_kodu}`);
        try {
          const deleteResponse = await fetchWithAuth(`${apiUrl}/${recipe.id}`, { method: 'DELETE' });
          
          if (deleteResponse && deleteResponse.ok) {
            successCount++;
          } else {
            console.error(`${typeLabel} reÃ§etesi silinemedi: ID=${recipe.id}, HTTP ${deleteResponse ? deleteResponse.status : 'unknown'}`);
            errorCount++;
          }
        } catch (deleteError) {
          console.error(`${typeLabel} reÃ§etesi silinirken hata: ${deleteError.message}`);
          errorCount++;
          // Silme hatasÄ± oluÅŸsa bile diÄŸer reÃ§eteleri silmeye devam et
        }
      }
      
      // Ã–zet bilgisi gÃ¶ster
      if (successCount > 0) {
        console.log(`${typeLabel} reÃ§eteleri silindi: ${successCount} baÅŸarÄ±lÄ±, ${errorCount} hatalÄ±`);
      } else if (errorCount > 0) {
        console.warn(`${typeLabel} reÃ§etelerinden hiÃ§biri silinemedi! (${errorCount} hata)`);
      } else {
        console.log(`${typeLabel} iÃ§in iÅŸlem yapÄ±lacak reÃ§ete bulunmadÄ±`);
      }
    } catch (error) {
      console.error(`${type.toUpperCase()} reÃ§eteleri silinirken genel hata:`, error);
      // Genel hata durumunda bile iÅŸleme devam etmesine izin ver
    }
  };

  // Ã–lÃ§Ã¼ birimi alma fonksiyonu
  const getOlcuBr = (bilesen) => {
    // For YM GT readonly component always show KG
    if (bilesen === 'readonly') return 'KG';
    
    // For process codes with 01 suffix, typically times
    if (bilesen === 'GTPKT01' || bilesen === 'TLC01' || bilesen === 'GLV01') return 'DK';
    
    // All other cases return KG for material weight
    if (bilesen.includes('03') || bilesen.includes('ASÄ°T')) return 'KG';
    if (bilesen.includes('KARTON') || bilesen.includes('HALKA') || bilesen.includes('TOKA') || bilesen.includes('DESÄ°')) return 'AD';
    if (bilesen.includes('CEMBER') || bilesen.includes('SHRÄ°NK')) return 'KG';
    if (bilesen.includes('YM.GT.')) return 'KG';
    if (bilesen.includes('FLM.')) return 'KG';
    return 'KG';
  };

  // ReÃ§ete aÃ§Ä±klama alma
  const getReceteAciklama = (bilesen) => {
    if (bilesen === 'GTPKT01') return 'Paketleme Operasyonu';
    if (bilesen === 'GLV01') return 'Galvanizleme Operasyonu';
    if (bilesen === 'TLC01') return 'Tel Ã‡ekme Operasyonu';
    if (bilesen === '150 03') return 'Ã‡inko TÃ¼ketim MiktarÄ±';
    if (bilesen === 'SM.HÄ°DROLÄ°K.ASÄ°T') return 'Asit TÃ¼ketim MiktarÄ±';
    if (bilesen.includes('FLM.')) return 'FilmaÅŸin TÃ¼ketimi';
    if (bilesen.includes('YM.GT.')) return 'Galvanizli Tel TÃ¼ketim MiktarÄ±';
    if (bilesen.includes('YM.ST.')) return 'Galvanizli Tel TÃ¼ketim MiktarÄ±';
    if (bilesen.includes('KARTON')) return 'Karton TÃ¼ketim MiktarÄ±';
    if (bilesen.includes('SHRÄ°NK')) return 'Naylon TÃ¼ketim MiktarÄ±';
    if (bilesen.includes('HALKA')) return 'KaldÄ±rma KancasÄ± TÃ¼ketim MiktarÄ±';
    if (bilesen.includes('CEMBER')) return 'Ã‡elik Ã§ember TÃ¼ketim MiktarÄ±';
    if (bilesen.includes('TOKA')) return 'Ã‡ember TokasÄ± TÃ¼ketim MiktarÄ±';
    if (bilesen.includes('DESÄ°')) return 'Slikajel TÃ¼ketim MiktarÄ±';
    return 'TÃ¼ketim MiktarÄ±';
  };

  // FilmaÅŸin kodu oluÅŸtur - Excel formatÄ±na tam uyumlu
  const getFilmasinKodu = (ymSt) => {
    if (!ymSt) return 'FLM.0600.1006';
    
    // Get cap and determine appropriate filmasin type
    const cap = parseFloat(ymSt.cap) || parseFloat(mmGtData.cap) || 0;
    let filmasin = ymSt.filmasin ? ymSt.filmasin.toString() : getFilmasinForCap(cap);
    
    // Ensure 4 digits with leading zeros - Excel formatÄ± iÃ§in Ã¶nemli!
    // Format: XXXX (0550, 0600, 0700, etc.)
    const filmasinNumber = parseInt(filmasin, 10);
    filmasin = filmasinNumber.toString().padStart(4, '0');
    
    // Get quality based on cap or use default
    let quality = ymSt.quality || getQualityForCap(cap) || '1006';
    
    // DÃœZELTME: Format kontrolÃ¼ - Excel formatÄ±yla tam uyumlu olmalÄ±
    const filmasinCode = `FLM.${filmasin}.${quality}`;
    
    // DoÄŸru format kontrolÃ¼: FLM.XXXX.XXXX (Ã¶rn. FLM.0550.1006)
    const validFormat = /^FLM\.\d{4}\.\d{4}$/.test(filmasinCode);
    
    if (!validFormat) {
      console.warn(`âš ï¸ UYARI: OluÅŸturulan FLM kodu hatalÄ± formatta: ${filmasinCode}, format dÃ¼zeltilmeli`);
    }
    
    // Return formatted code in the correct format: FLM.0800.1010
    return filmasinCode;
  };

  // TLC_Hizlar cache - we'll fetch the data from the database
  const [tlcHizlarCache, setTlcHizlarCache] = useState({});
  const [tlcHizlarLoading, setTlcHizlarLoading] = useState(false);

  // Load TLC_Hizlar data from the database when component mounts
  useEffect(() => {
    fetchTlcHizlarData();
  }, []);
  
  // Function to fetch TLC_Hizlar data from the database
  const fetchTlcHizlarData = async () => {
    try {
      setTlcHizlarLoading(true);
      // Check if API endpoint exists
      if (!API_URLS.galTlcHizlar) {
        console.warn('galTlcHizlar API endpoint is not defined, using fallback data');
        setTlcHizlarLoading(false);
        return;
      }
      
      // Try first with CORS proxy (works better with vercel deployments)
      try {
        console.log('Trying to fetch TLC_Hizlar data using CORS proxy...');
        const proxyResponse = await fetchWithCorsProxy(API_URLS.galTlcHizlar, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (proxyResponse && proxyResponse.ok) {
          const data = await proxyResponse.json();
          
          // Create a lookup table for DÃœÅžEYARA function
          const lookupMap = {};
          if (Array.isArray(data)) {
            data.forEach(item => {
              const kod = `${item.giris_capi}x${item.cikis_capi}`;
              lookupMap[kod] = item.calisma_hizi;
            });
            
            console.log(`TLC_Hizlar data loaded successfully with ${Object.keys(lookupMap).length} entries (via CORS proxy)`);
            setTlcHizlarCache(lookupMap);
            setTlcHizlarLoading(false);
            return;
          }
        }
      } catch (proxyError) {
        console.warn('CORS proxy fetch failed, trying direct methods:', proxyError);
      }
      
      // Try with standard fetch as second option
      try {
        console.log('Trying to fetch TLC_Hizlar data using standard fetch...');
        const directResponse = await fetch(API_URLS.galTlcHizlar, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
          mode: 'cors'
        });
        
        if (directResponse && directResponse.ok) {
          const data = await directResponse.json();
          
          // Create a lookup table for DÃœÅžEYARA function
          const lookupMap = {};
          if (Array.isArray(data)) {
            data.forEach(item => {
              const kod = `${item.giris_capi}x${item.cikis_capi}`;
              lookupMap[kod] = item.calisma_hizi;
            });
            
            console.log(`TLC_Hizlar data loaded successfully with ${Object.keys(lookupMap).length} entries (via direct fetch)`);
            setTlcHizlarCache(lookupMap);
            setTlcHizlarLoading(false);
            return;
          }
        }
      } catch (directFetchError) {
        console.warn('Direct fetch failed, trying fetchWithAuth:', directFetchError);
      }
      
      // If all previous attempts failed, try with fetchWithAuth
      try {
        console.log('Trying to fetch TLC_Hizlar data using fetchWithAuth...');
        const response = await fetchWithAuth(API_URLS.galTlcHizlar);
        if (response && response.ok) {
          const data = await response.json();
          
          // Create a lookup table for DÃœÅžEYARA function
          const lookupMap = {};
          if (Array.isArray(data)) {
            data.forEach(item => {
              const kod = `${item.giris_capi}x${item.cikis_capi}`;
              lookupMap[kod] = item.calisma_hizi;
            });
          }
          
          setTlcHizlarCache(lookupMap);
          console.log(`TLC_Hizlar data loaded successfully with ${Object.keys(lookupMap).length} entries (via fetchWithAuth)`);
        } else {
          console.warn('Failed to fetch TLC_Hizlar data, using default fallback values');
          initializeFallbackData();
        }
      } catch (authFetchError) {
        console.warn('Auth fetch failed, using fallback data:', authFetchError);
        initializeFallbackData();
      }
    } catch (error) {
      console.error('Error fetching TLC_Hizlar data:', error);
      initializeFallbackData();
    } finally {
      setTlcHizlarLoading(false);
    }
  };
  
  // Initialize fallback data in case API fails
  const initializeFallbackData = () => {
    // Static fallback data for most common sizes
    const fallbackData = {
      "7x5": 10.5,
      "7x5.5": 11,
      "7x6": 11,
      "8x6": 11,
      "8x6.5": 11,
      "8x7": 11.5,
      "9x7": 10.5,
      "9x7.5": 10.5,
      "9x8": 10,
      "10x7.92": 10,
      "10x8": 10
    };
    
    console.log("Using static fallback data for TLC_Hizlar");
    setTlcHizlarCache(fallbackData);
  };
  
  // No fallback data - using only database table

  // DÃœÅžEYARA (VLOOKUP) function implementation using only database data
  const duseyaraLookup = (lookupValue, rangeArray, columnIndex, exactMatch = true) => {
    // Fallback values for specific lookups - Handle known missing data
    const fallbackValues = {
      "10x8": 10,        // Common wire size with fallback value 10
      "10x7.92": 10,     // Common wire size with fallback value 10
      "7x5": 10.5,       // Common wire size with fallback value 10.5
      "7x6": 11,         // Common wire size with fallback value 11
      "8x6": 11,         // Common wire size with fallback value 11
      "8x7": 11.5,       // Common wire size with fallback value 11.5
      "9x7": 10.5,       // Common wire size with fallback value 10.5
      "9x8": 10          // Common wire size with fallback value 10
    };
    
    // Check if we have a fallback value for this exact combination
    if (fallbackValues[lookupValue]) {
      console.log(`Using fallback value for ${lookupValue}: ${fallbackValues[lookupValue]}`);
      return fallbackValues[lookupValue];
    }
    
    // Check if we have database data in the cache
    if (Object.keys(tlcHizlarCache).length > 0) {
      // Database approach: direct lookup by code (format "7x1.25")
      if (tlcHizlarCache[lookupValue]) {
        // We have an exact match in the database
        return tlcHizlarCache[lookupValue];
      }
      
      // No exact match in DB, try to find closest match
      if (!exactMatch) {
        try {
          // Parse lookupValue format "7x1.25" -> [7, 1.25]
          const [hmCap, cap] = lookupValue.split("x").map(Number);
          
          // Find all keys that match the input HM cap 
          const matchingHmCapKeys = Object.keys(tlcHizlarCache).filter(key => {
            try {
              const [keyHmCap] = key.split("x").map(Number);
              return keyHmCap === hmCap;
            } catch (e) {
              console.warn(`Invalid key format: ${key}`);
              return false;
            }
          });
          
          if (matchingHmCapKeys.length > 0) {
            // Sort by closest cap value
            matchingHmCapKeys.sort((a, b) => {
              const [, aCapValue] = a.split("x").map(Number);
              const [, bCapValue] = b.split("x").map(Number);
              return Math.abs(aCapValue - cap) - Math.abs(bCapValue - cap);
            });
            
            // Return the closest match
            return tlcHizlarCache[matchingHmCapKeys[0]];
          }
          
          // If we still don't have a match, try to find closest HM cap
          const allKeys = Object.keys(tlcHizlarCache);
          if (allKeys.length > 0) {
            // Sort by closest HM cap, then by closest cap
            allKeys.sort((a, b) => {
              try {
                const [aHmCap, aCap] = a.split("x").map(Number);
                const [bHmCap, bCap] = b.split("x").map(Number);
                
                const aHmCapDiff = Math.abs(aHmCap - hmCap);
                const bHmCapDiff = Math.abs(bHmCap - hmCap);
                
                if (aHmCapDiff !== bHmCapDiff) {
                  return aHmCapDiff - bHmCapDiff;
                }
                
                return Math.abs(aCap - cap) - Math.abs(bCap - cap);
              } catch (e) {
                console.warn(`Error sorting keys: ${a}, ${b}`);
                return 0;
              }
            });
            
            return tlcHizlarCache[allKeys[0]];
          }
        } catch (error) {
          console.warn(`Error in duseyaraLookup for ${lookupValue}:`, error);
        }
      }
    }
    
    // If we couldn't find a match or have no data, return default or a backup estimate
    console.warn(`No TLC_Hiz match found for ${lookupValue}. Using default value.`);
    
    // For any lookup value with format "Wx1.25", estimate a reasonable value
    try {
      const [hmCap, cap] = lookupValue.split("x").map(Number);
      
      // Basic estimation based on empirical data patterns
      if (hmCap >= 9) {
        return 10;  // Larger HM caps generally have speeds around a default of 10
      } else if (hmCap >= 8) {
        return 11;  // HM cap 8 generally has speeds around 11
      } else if (hmCap >= 7) {
        return 12;  // HM cap 7 generally has speeds around 12
      } else {
        return 12.5; // Smaller HM caps generally have higher speeds
      }
    } catch (e) {
      // If all else fails, return the default
      return 10;
    }
  };
  
  // Calculate YuzeyAlani based on the formula
  const calculateYuzeyAlani = (cap) => {
    // YuzeyAlani: =1000*4000/PI()/'DIA (MM)'/'DIA (MM)'/7.85*'DIA (MM)'*PI()/1000
    return (1000 * 4000 / Math.PI / cap / cap / 7.85 * cap * Math.PI / 1000);
  };
  
  // Calculate total surface area
  const calculateTotalYuzeyAlani = () => {
    // toplam_yuzey_alani= uretim_kapasitesi_aylik *1000*4000/ ortalama_uretim_capi / ortalama_uretim_capi /3.14/7.85* ortalama_uretim_capi *3.14/1000
    const { uretim_kapasitesi_aylik, ortalama_uretim_capi } = userInputValues;
    return uretim_kapasitesi_aylik * 1000 * 4000 / ortalama_uretim_capi / ortalama_uretim_capi / Math.PI / 7.85 * ortalama_uretim_capi * Math.PI / 1000;
  };
  
  // Calculate Durdurma VinÃ§ (DV) based on Min Mukavemet
  const calculateDV = (minMukavemet) => {
    // DV = EÄžER('Min Mukavemet'=400;140;EÄžER('Min Mukavemet'=500;160;EÄžER('Min Mukavemet'=600;180;EÄžER'Min Mukavemet'=700;200;"yok"))))
    if (minMukavemet === 400) return 140;
    else if (minMukavemet === 500) return 160;
    else if (minMukavemet === 600) return 180;
    else if (minMukavemet === 700) return 200;
    else return 140; // Use default value instead of null to avoid formula errors
  };

  // Calculate tuketilenAsit
  const calculateTuketilenAsit = () => {
    // tuketilenAsit: = toplam_tuketilen_asit / toplam_yuzey_alani
    const { toplam_tuketilen_asit } = userInputValues;
    const totalYuzeyAlani = calculateTotalYuzeyAlani();
    return totalYuzeyAlani > 0 ? 
      toplam_tuketilen_asit / totalYuzeyAlani : 
      0.0647625; // Default value if totalYuzeyAlani is zero
  };
  
  // Calculate TLC_Hiz based on HM_Cap and Cap values
  // TLC_Hiz= =DÃœÅžEYARA(BÄ°RLEÅžTÄ°R(HM_Cap;"x"; Ã‡ap);'TLC_HÄ±zlar'!C:F;4;YANLIÅž)*0.7
  const calculateTlcHiz = (hmCap, cap) => {
    // Format inputs to ensure consistency
    const formattedHmCap = parseFloat(hmCap);
    const formattedCap = parseFloat(cap);
    
    // Create lookup code in format: "7x1.25"
    const lookupCode = `${formattedHmCap}x${formattedCap}`;
    
    // Use DÃœÅžEYARA (VLOOKUP) to find the closest match from database
    const calismaHizMs = duseyaraLookup(lookupCode, null, null, false);
    
    // Apply the formula: TLC_Hiz = DÃœÅžEYARA(...) * 0.7
    // Exactly as specified in GalvanizliFormulas.txt
    return calismaHizMs ? calismaHizMs * 0.7 : 7; // Default to 7 (10*0.7) if not found
  };

  // Excel dosyalarÄ±nÄ± oluÅŸtur
  const generateExcelFiles = async () => {
    try {
      setIsLoading(true);
      setError(null);
      
      // Talep kullanÄ±ldÄ±ysa uyarÄ± gÃ¶ster
      if (isRequestUsed) {
        const confirmDelete = window.confirm('Bir talep seÃ§tiniz. Excel dosyalarÄ±nÄ± oluÅŸturduktan sonra bu talebi silmek ister misiniz?');
        if (confirmDelete && selectedRequest) {
          try {
            await deleteRequest(selectedRequest.id);
            setIsRequestUsed(false);
            setSelectedRequest(null);
          } catch (error) {
            console.error('Talep silme hatasÄ±:', error);
            // Talep silinemese bile Excel oluÅŸturmaya devam et
          }
        }
      }
      
      if (![...selectedYmSts, ...autoGeneratedYmSts].length) {
        toast.error('En az bir YM ST seÃ§melisiniz veya oluÅŸturmalÄ±sÄ±nÄ±z');
        setIsLoading(false);
        return;
      }
      
      // Ã–NEMLÄ°: Ã–nce MMGT ve YMGT iÃ§in veritabanÄ±nda aynÄ± key deÄŸerlere sahip Ã¼rÃ¼nleri kontrol et
      // Bu ÅŸekilde key deÄŸiÅŸimi olan Ã¼rÃ¼nlerin doÄŸru sequence ile Excel'e eklenmesini saÄŸla
      let sequence = '00';
      let mmGtStokKodu = '';
      
      console.log(`Excel oluÅŸturulurken, key deÄŸerlere sahip Ã¼rÃ¼nlerin sequence'i kontrol ediliyor...`);
      
      // 1. Ã–nce tamamen aynÄ± key deÄŸerlere sahip Ã¼rÃ¼n iÃ§in veritabanÄ±nÄ± sorgula
      const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
      const baseCode = `GT.${mmGtData.kod_2}.${capFormatted}`;
      console.log(`MMGT iÃ§in baseCode: ${baseCode}`);
      
      try {
        // AynÄ± key deÄŸerlere sahip Ã¼rÃ¼nleri veritabanÄ±nda ara
        const response = await fetchWithAuth(`${API_URLS.galMmGt}?stok_kodu_like=${encodeURIComponent(baseCode)}`);
        if (response && response.ok) {
          const existingProducts = await response.json();
          console.log(`${existingProducts.length} adet benzer Ã¼rÃ¼n bulundu`);
          
          if (existingProducts.length > 0) {
            // Tamamen aynÄ± Ã¼rÃ¼n var mÄ± kontrol et (stok_kodu ve stok_adi etkileyen tÃ¼m deÄŸerler)
            const stokAdi = `Galvanizli Tel ${parseFloat(mmGtData.cap).toFixed(2)} mm -${Math.abs(parseFloat(mmGtData.tolerans_minus)).toFixed(2)}/+${parseFloat(mmGtData.tolerans_plus).toFixed(2)} ${mmGtData.kaplama} gr/mÂ² ${mmGtData.min_mukavemet}-${mmGtData.max_mukavemet} MPa ID:${mmGtData.ic_cap} cm OD:${mmGtData.dis_cap} cm ${mmGtData.kg} kg`;
            const normalizedStokAdi = stokAdi.replace(/\s+/g, ' ').trim().toLowerCase();
            
            // TÃ¼m Ã¼rÃ¼nleri kontrol et ve tam eÅŸleÅŸen bir Ã¼rÃ¼n bulmaya Ã§alÄ±ÅŸ
            for (const product of existingProducts) {
              const normalizedProductAdi = product.stok_adi.replace(/\s+/g, ' ').trim().toLowerCase();
              
              // Stok adÄ± ile karÅŸÄ±laÅŸtÄ±rma
              if (normalizedProductAdi === normalizedStokAdi) {
                // Tam eÅŸleÅŸme bulundu - bu Ã¼rÃ¼nÃ¼n sequence'ini kullan
                sequence = product.stok_kodu.split('.').pop();
                mmGtStokKodu = product.stok_kodu;
                console.log(`Excel iÃ§in tam eÅŸleÅŸen Ã¼rÃ¼n bulundu: ${mmGtStokKodu}, Sequence: ${sequence}`);
                break;
              }
            }
            
            // EÄŸer eÅŸleÅŸen Ã¼rÃ¼n bulunamadÄ±ysa, en yÃ¼ksek sequence'i kullan
            if (sequence === '00' && existingProducts.length > 0) {
              // En yÃ¼ksek sequence'i bul
              let maxSequence = -1;
              existingProducts.forEach(product => {
                const sequencePart = product.stok_kodu.split('.').pop();
                const sequenceNum = parseInt(sequencePart);
                if (!isNaN(sequenceNum) && sequenceNum > maxSequence) {
                  maxSequence = sequenceNum;
                }
              });
              
              // Yeni Ã¼rÃ¼n iÃ§in sequence'i artÄ±r
              sequence = (maxSequence + 1).toString().padStart(2, '0');
              console.log(`Excel iÃ§in en yÃ¼ksek sequence+1 kullanÄ±lÄ±yor: ${sequence}`);
            }
          }
        }
      } catch (error) {
        console.error('VeritabanÄ±ndan Ã¼rÃ¼n sorgulanÄ±rken hata:', error);
      }
      
      // 2. EÄŸer veritabanÄ±nda Ã¼rÃ¼n bulunamadÄ±ysa veya sequence hala 00 ise kayÄ±tlÄ± Ã¼rÃ¼nleri kontrol et
      if (sequence === '00' && savedToDatabase && databaseIds && databaseIds.mmGtIds && databaseIds.mmGtIds[0]) {
        // KayÄ±tlÄ± Ã¼rÃ¼nÃ¼n stok kodundan sequence'i al
        const savedMmGtResponse = await fetchWithAuth(`${API_URLS.galMmGt}/${databaseIds.mmGtIds[0]}`);
        if (savedMmGtResponse && savedMmGtResponse.ok) {
          const savedMmGt = await savedMmGtResponse.json();
          if (savedMmGt && savedMmGt.stok_kodu) {
            sequence = savedMmGt.stok_kodu.split('.').pop();
            mmGtStokKodu = savedMmGt.stok_kodu;
            console.log(`Excel iÃ§in kaydedilmiÅŸ MMGT'den sequence alÄ±ndÄ±: ${sequence}`);
          }
        }
      }
      
      // 3. Hala sequence belirlenemediyse yeni hesapla
      if (sequence === '00') {
        try {
          // checkForExistingProducts fonksiyonu zaten mevcut Ã¼rÃ¼nleri kontrol eder
          const nextSequence = await checkForExistingProducts(
            mmGtData.cap,
            mmGtData.kod_2,
            mmGtData.kaplama,
            mmGtData.min_mukavemet,
            mmGtData.max_mukavemet,
            mmGtData.kg
          );
          sequence = nextSequence.toString().padStart(2, '0');
          console.log(`Excel iÃ§in yeni sequence hesaplandÄ±: ${sequence}`);
        } catch (error) {
          console.error('Sequence hesaplama hatasÄ±:', error);
          // KullanÄ±cÄ± Ä°ptal'e tÄ±kladÄ±ÄŸÄ±nda
          if (error.message === 'Ä°ÅŸlem kullanÄ±cÄ± tarafÄ±ndan iptal edildi') {
            setIsLoading(false);
            toast.info('Ä°ÅŸlem iptal edildi');
            throw error; // Ä°ÅŸlemi tamamen durdur
          }
          sequence = '00'; // En son Ã§are olarak 00 kullan
        }
      }
      
      console.log(`Excel oluÅŸturma iÃ§in KULLANILACAK SEQUENCE: ${sequence}`);
      if (sequence === '00') {
        console.warn(`UYARI: Excel oluÅŸturma iÃ§in '00' sequence'i kullanÄ±lÄ±yor. Bu istenmeyen bir durum olabilir.`);
      }
      
      // Her iki Excel'de de aynÄ± sequence'i kullan
      // Stok KartÄ± Excel
      await generateStokKartiExcel(sequence);
      
      // ReÃ§ete Excel
      await generateReceteExcel(sequence);
      
      setSuccessMessage('Excel dosyalarÄ± baÅŸarÄ±yla oluÅŸturuldu');
      toast.success('Excel dosyalarÄ± baÅŸarÄ±yla oluÅŸturuldu');
    } catch (error) {
      console.error('Excel oluÅŸturma hatasÄ±:', error);
      setError('Excel oluÅŸturma hatasÄ±: ' + error.message);
      toast.error('Excel oluÅŸturma hatasÄ±: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  // Stok KartÄ± Excel oluÅŸtur - yeni 1:1:n iliÅŸki modeli ile
  const generateStokKartiExcel = async (sequence = '00') => {
    const workbook = new ExcelJS.Workbook();
    const allYmSts = [...selectedYmSts, ...autoGeneratedYmSts];
    
    // Ana YM ST'yi belirle (ya seÃ§ilmiÅŸ ya da otomatik oluÅŸturulmuÅŸ)
    const mainYmSt = allYmSts[mainYmStIndex] || allYmSts[0];
    
    console.log(`Stok KartÄ± Excel oluÅŸturuluyor, sequence: ${sequence}`);
    
    // MM GT Sheet - ArtÄ±k sadece 1 tane MM GT
    const mmGtSheet = workbook.addWorksheet('MM GT');
    const mmGtHeaders = getStokKartiHeaders();
    mmGtSheet.addRow(mmGtHeaders);
    
    // Sadece 1 MM GT ekle (doÄŸru sequence ile)
    mmGtSheet.addRow(generateMmGtStokKartiData(sequence));
    
    // YM GT Sheet - ArtÄ±k sadece 1 tane YM GT
    const ymGtSheet = workbook.addWorksheet('YM GT');
    const ymGtHeaders = getYmGtHeaders();
    ymGtSheet.addRow(ymGtHeaders);
    
    // Sadece 1 YM GT ekle (doÄŸru sequence ile)
    ymGtSheet.addRow(generateYmGtStokKartiData(sequence));
    
    // YM ST Sheet - TÃ¼m YM ST'ler
    const ymStSheet = workbook.addWorksheet('YM ST');
    const ymStHeaders = getYmStHeaders();
    ymStSheet.addRow(ymStHeaders);
    
    // Ä°lk olarak ana YM ST'yi ekle
    ymStSheet.addRow(generateYmStStokKartiData(mainYmSt));
    
    // Sonra diÄŸer YM ST'leri ekle
    allYmSts.forEach((ymSt, index) => {
      // Ana YM ST'yi atla (zaten ekledik)
      if (index !== mainYmStIndex) {
        ymStSheet.addRow(generateYmStStokKartiData(ymSt));
      }
    });
    
    const buffer = await workbook.xlsx.writeBuffer();
    saveAs(new Blob([buffer]), 'Galvaniz_Stok_Karti.xlsx');
  };

  // ReÃ§ete Excel oluÅŸtur - Yeni 1:1:n iliÅŸki modeli ile
  const generateReceteExcel = async (sequence = '00') => {
    const workbook = new ExcelJS.Workbook();
    const allYmSts = [...selectedYmSts, ...autoGeneratedYmSts];
    
    // Ana YM ST'yi belirle (ya seÃ§ilmiÅŸ ya da otomatik oluÅŸturulmuÅŸ)
    const mainYmSt = allYmSts[mainYmStIndex] || allYmSts[0];
    const mainYmStIndex_ = mainYmStIndex; // Closure iÃ§in yerel deÄŸiÅŸken
    
    // Ã–nemli: Son kontrol - stok kartÄ± Excel'i ile aynÄ± sequence'i kullandÄ±ÄŸÄ±mÄ±zdan emin olalÄ±m
    if (sequence === '00') {
      console.warn('UYARI! ReÃ§ete Excel iÃ§in "00" sequence kullanÄ±lÄ±yor. VeritabanÄ±nÄ± kontrol et.');
    }
    
    console.log(`ReÃ§ete Excel oluÅŸturuluyor, sequence: ${sequence} -- VeritabanÄ±ndaki Ã¼rÃ¼nle eÅŸleÅŸtiÄŸinden emin olun!`);
    
    // MM GT REÃ‡ETE Sheet
    const mmGtReceteSheet = workbook.addWorksheet('MM GT REÃ‡ETE');
    const receteHeaders = getReceteHeaders();
    mmGtReceteSheet.addRow(receteHeaders);
    
    // Sadece ana YMST iÃ§in MM GT reÃ§ete satÄ±rlarÄ± ekle
    const mmGtRecipe = { ...allRecipes.mmGtRecipes[mainYmStIndex_] } || {}; // Clone to avoid modifying the original
    
    // DÃœZELTME: EÄŸer YM.GT kodu yanlÄ±ÅŸ sequence'e sahipse dÃ¼zelt
    // DoÄŸru YM.GT kodu oluÅŸtur - MMGT ile aynÄ± sequence kullanÄ±lmalÄ±
    const correctStokKodu = `YM.GT.${mmGtData.kod_2}.${Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0')}.${sequence}`;
    console.log(`MMGT reÃ§etesi iÃ§in YMGT kodlarÄ± kontrol ediliyor, doÄŸru kod: ${correctStokKodu}`);
    
    // ReÃ§etedeki YM.GT kodlarÄ±nÄ± dÃ¼zelt - yeni bir obje oluÅŸturarak
    const fixedRecipe = {};
    Object.entries(mmGtRecipe).forEach(([key, value]) => {
      if (key.includes('YM.GT.') && key !== correctStokKodu) {
        console.log(`âš ï¸ YanlÄ±ÅŸ YMGT kodu dÃ¼zeltiliyor: ${key} â†’ ${correctStokKodu}`);
        fixedRecipe[correctStokKodu] = value;
      } else {
        fixedRecipe[key] = value;
      }
    });
    
    // DÃ¼zeltilmiÅŸ reÃ§eteyi kullan
    const processedMmGtRecipe = fixedRecipe;
    
    let siraNo = 1;
    
    // MMGT reÃ§ete sÄ±ralamasÄ±: fixed exact order as specified
    const recipeEntries = Object.entries(processedMmGtRecipe);
    
    // Maintain fixed order: YM.GT.*.*, GTPKT01, AMB.Ã‡EM.KARTON.GAL, AMB.SHRÄ°NK.*, SM.7MMHALKA, AMB.APEX CEMBER, AMB.TOKA.SIGNODE, SM.DESÄ°.PAK
    // DÃ¼zeltme: YM.GT kodunu mamul_kodu ile aynÄ± sequence'e sahip olacak ÅŸekilde ara
    const correctYmGtStokKodu = `YM.GT.${mmGtData.kod_2}.${Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0')}.${sequence}`;
    console.log(`ðŸ” MMGT reÃ§etesi Excel iÃ§in doÄŸru YMGT kodu aranÄ±yor: ${correctYmGtStokKodu}`);
    const ymGtEntry = recipeEntries.find(([key]) => key === correctYmGtStokKodu) || 
                      recipeEntries.find(([key]) => key.includes('YM.GT.'));
    const gtpkt01Entry = recipeEntries.find(([key]) => key === 'GTPKT01');
    const kartonEntry = recipeEntries.find(([key]) => key === 'AMB.Ã‡EM.KARTON.GAL');
    const shrinkEntry = recipeEntries.find(([key]) => key.includes('AMB.SHRÄ°NK.'));
    const halkaEntry = recipeEntries.find(([key]) => key === 'SM.7MMHALKA');
    const cemberEntry = recipeEntries.find(([key]) => key === 'AMB.APEX CEMBER 38X080');
    const tokaEntry = recipeEntries.find(([key]) => key === 'AMB.TOKA.SIGNODE.114P. DKP');
    const desiEntry = recipeEntries.find(([key]) => key === 'SM.DESÄ°.PAK');
    
    // Other entries that might exist but aren't in the fixed order
    const otherEntries = recipeEntries.filter(([key]) => 
      !key.includes('YM.GT.') && 
      key !== 'GTPKT01' &&
      key !== 'AMB.Ã‡EM.KARTON.GAL' &&
      !key.includes('AMB.SHRÄ°NK.') &&
      key !== 'SM.7MMHALKA' &&
      key !== 'AMB.APEX CEMBER 38X080' &&
      key !== 'AMB.TOKA.SIGNODE.114P. DKP' &&
      key !== 'SM.DESÄ°.PAK'
    );
    
    // SÄ±rayla ekle - exact order
    const orderedEntries = [
      ymGtEntry, 
      gtpkt01Entry, 
      kartonEntry,
      shrinkEntry,
      halkaEntry,
      cemberEntry,
      tokaEntry,
      desiEntry,
      ...otherEntries
    ].filter(Boolean);
    
    // MM GT reÃ§ete satÄ±rlarÄ±nÄ± eklerken doÄŸru sequence'i kullan
    orderedEntries.forEach(([key, value]) => {
      if (value > 0) {
        mmGtReceteSheet.addRow(generateMmGtReceteRow(key, value, siraNo, sequence));
        siraNo++;
      }
    });
    
    // YM GT REÃ‡ETE Sheet - ArtÄ±k sadece 1 tane YM GT reÃ§etesi
    const ymGtReceteSheet = workbook.addWorksheet('YM GT REÃ‡ETE');
    ymGtReceteSheet.addRow(receteHeaders);
    
    // Sadece 1 YM GT reÃ§etesi ekle - aynÄ± sequence'i kullan
    let siraNo2 = 1;
    
    // YM GT reÃ§etesinden sequence'e uygun deÄŸerleri al - fixed exact order
    const ymGtRecipeEntries = Object.entries(allRecipes.ymGtRecipe);
    
    // Fixed order: YM.ST.*.*.*, GLV01, 150 03, SM.HÄ°DROLÄ°K.ASÄ°T
    // Ana YMST'nin stok kodunu kullan
    const ymStEntry = ymGtRecipeEntries.find(([key]) => key.includes('YM.ST.') || key === mainYmSt.stok_kodu);
    const glv01Entry = ymGtRecipeEntries.find(([key]) => key === 'GLV01');
    const zincEntry = ymGtRecipeEntries.find(([key]) => key === '150 03');
    const asitEntry = ymGtRecipeEntries.find(([key]) => key === 'SM.HÄ°DROLÄ°K.ASÄ°T');
    
    // Other entries that might exist but aren't in the fixed order
    const otherYmGtEntries = ymGtRecipeEntries.filter(([key]) => 
      !key.includes('YM.ST.') && 
      key !== 'GLV01' && 
      key !== '150 03' && 
      key !== 'SM.HÄ°DROLÄ°K.ASÄ°T' && 
      key !== mainYmSt.stok_kodu
    );
    
    // SÄ±rayla ekle - exact order
    const orderedYmGtEntries = [
      ymStEntry ? [mainYmSt.stok_kodu, ymStEntry[1]] : null,
      glv01Entry,
      zincEntry,
      asitEntry,
      ...otherYmGtEntries
    ].filter(Boolean);
    
    orderedYmGtEntries.forEach(([key, value]) => {
      if (value > 0) {
        ymGtReceteSheet.addRow(generateYmGtReceteRow(key, value, siraNo2, sequence));
        siraNo2++;
      }
    });
    
    // YM ST REÃ‡ETE Sheet - TÃ¼m YM ST'ler iÃ§in reÃ§eteleri oluÅŸtur
    const ymStReceteSheet = workbook.addWorksheet('YM ST REÃ‡ETE');
    ymStReceteSheet.addRow(receteHeaders);
    
    // Ä°lk olarak ana YM ST'nin reÃ§etesini ekle
    const mainYmStRecipe = allRecipes.ymStRecipes[mainYmStIndex_] || {};
    let siraNoMain = 1;
    
    // Ana YMST reÃ§ete sÄ±ralamasÄ±: fixed exact order - 1) FLM bileÅŸeni, 2) TLC01 operasyonu
    const mainRecipeEntries = Object.entries(mainYmStRecipe);
    
    // Fixed order: FLM.*.*, TLC01
    const mainFlmEntry = mainRecipeEntries.find(([key]) => key.includes('FLM.'));
    const mainTlc01Entry = mainRecipeEntries.find(([key]) => key === 'TLC01');
    
    // Any other entries that might exist but aren't in the fixed order
    const mainOtherEntries = mainRecipeEntries.filter(([key]) => 
      !key.includes('FLM.') && 
      key !== 'TLC01'
    );
    
    // SÄ±rayla ekle - exact order
    const mainOrderedEntries = [
      mainFlmEntry,
      mainTlc01Entry,
      ...mainOtherEntries
    ].filter(Boolean);
    
    mainOrderedEntries.forEach(([key, value]) => {
      if (value > 0) {
        ymStReceteSheet.addRow(generateYmStReceteRow(key, value, siraNoMain, mainYmSt));
        siraNoMain++;
      }
    });
    
    // DiÄŸer YM ST'lerin reÃ§etelerini ekle
    allYmSts.forEach((ymSt, index) => {
      // Ana YM ST'yi atla (zaten ekledik)
      if (index !== mainYmStIndex_) {
        const ymStRecipe = allRecipes.ymStRecipes[index] || {};
        let siraNo = 1;
        
        // YMST reÃ§ete sÄ±ralamasÄ±: fixed exact order - 1) FLM bileÅŸeni, 2) TLC01 operasyonu
        const recipeEntries = Object.entries(ymStRecipe);
        
        // Fixed order: FLM.*.*, TLC01
        const flmEntry = recipeEntries.find(([key]) => key.includes('FLM.'));
        const tlc01Entry = recipeEntries.find(([key]) => key === 'TLC01');
        
        // Any other entries that might exist but aren't in the fixed order
        const otherEntries = recipeEntries.filter(([key]) => 
          !key.includes('FLM.') && 
          key !== 'TLC01'
        );
        
        // SÄ±rayla ekle - exact order
        const orderedEntries = [
          flmEntry,
          tlc01Entry,
          ...otherEntries
        ].filter(Boolean);
        
        orderedEntries.forEach(([key, value]) => {
          if (value > 0) {
            ymStReceteSheet.addRow(generateYmStReceteRow(key, value, siraNo, ymSt));
            siraNo++;
          }
        });
      }
    });
    
    const buffer = await workbook.xlsx.writeBuffer();
    saveAs(new Blob([buffer]), 'Galvanizli_Tel_Recete.xlsx');
  };

  // Excel header fonksiyonlarÄ±
  const getStokKartiHeaders = () => [
    'Stok Kodu', 'Stok AdÄ±', 'Grup Kodu', 'Kod-1', 'Kod-2', 'Cari/SatÄ±cÄ± Kodu',
    'Ä°ngilizce Ä°sim', 'SatÄ±cÄ± Ä°smi', 'Muh. Detay', 'Depo Kodu', 'Br-1', 'Br-2',
    'Pay-1', 'Payda-1', 'Ã‡evrim DeÄŸeri-1', 'Ã–lÃ§Ã¼ Br-3', 'Ã‡evrim Pay-2', 'Ã‡evrim Payda-2',
    'Ã‡evrim DeÄŸeri-2', 'Ã‡ap', 'Kaplama', 'Min Mukavemet', 'Max Mukavemet', 'KG',
    'Ä°Ã§ Ã‡ap/Boy Ã‡ubuk AD', 'DÄ±ÅŸ Ã‡ap/En Ã‡ubuk AD', 'Ã‡ap2', 'Shrink', 'Tolerans(+)',
    'Tolerans(-)', 'Ebat(En)', 'GÃ¶z AralÄ±ÄŸÄ±', 'Ebat(Boy)', 'HasÄ±r Tipi',
    'Ã–zel Saha 8 (Alf.)', 'AlÄ±ÅŸ FiyatÄ±', 'Fiyat Birimi', 'SatÄ±ÅŸ FiyatÄ±-1',
    'SatÄ±ÅŸ FiyatÄ±-2', 'SatÄ±ÅŸ FiyatÄ±-3', 'SatÄ±ÅŸ FiyatÄ±-4', 'SatÄ±ÅŸ Tipi',
    'DÃ¶viz AlÄ±ÅŸ', 'DÃ¶viz Maliyeti', 'DÃ¶viz SatÄ±ÅŸ FiyatÄ±', 'Azami Stok',
    'Asgari Stok', 'DÃ¶v.Tutar', 'DÃ¶v.Tipi', 'Bekleme SÃ¼resi', 'Temin SÃ¼resi',
    'Birim AÄŸÄ±rlÄ±k', 'Nakliye Tutar', 'SatÄ±ÅŸ KDV OranÄ±', 'AlÄ±ÅŸ KDV OranÄ±',
    'Stok TÃ¼rÃ¼', 'Mali Grup Kodu', 'Barkod 1', 'Barkod 2', 'Barkod 3',
    'Kod-3', 'Kod-4', 'Kod-5', 'Esnek YapÄ±landÄ±r', 'SÃ¼per ReÃ§ete KullanÄ±lsÄ±n',
    'BaÄŸlÄ± Stok Kodu', 'YapÄ±landÄ±rma Kodu', 'Yap. AÃ§Ä±klama', 'AlÄ±ÅŸ DÃ¶viz Tipi',
    'GÃ¼mrÃ¼k Tarife Kodu', 'DaÄŸÄ±tÄ±cÄ± Kodu', 'MenÅŸei', 'METARIAL', 'DIA (MM)',
    'DIA TOL (MM) +', 'DIA TOL (MM) -', 'ZING COATING (GR/M2)', 'TENSILE ST. (MPA) MIN',
    'TENSILE ST. (MPA) MAX', 'WAX', 'LIFTING LUGS', 'UNWINDING', 'CAST KONT. (CM)',
    'HELIX KONT. (CM)', 'ELONGATION (%) MIN', 'COIL DIMENSIONS (CM) ID',
    'COIL DIMENSIONS (CM) OD', 'COIL WEIGHT (KG)', 'COIL WEIGHT (KG) MIN',
    'COIL WEIGHT (KG) MAX'
  ];

  const getYmGtHeaders = () => [
    'Stok Kodu', 'Stok AdÄ±', 'Grup Kodu', 'Kod-1', 'Kod-2', 'Cari/SatÄ±cÄ± Kodu',
    'Ä°ngilizce Ä°sim', 'SatÄ±cÄ± Ä°smi', 'Muh. Detay', 'Depo Kodu', 'Br-1', 'Br-2',
    'Pay-1', 'Payda-1', 'Ã‡evrim DeÄŸeri-1', 'Ã–lÃ§Ã¼ Br-3', 'Ã‡evrim Pay-2', 'Ã‡evrim Payda-2',
    'Ã‡evrim DeÄŸeri-2', 'Ã‡ap', 'Kaplama', 'Min Mukavemet', 'Max Mukavemet', 'KG',
    'Ä°Ã§ Ã‡ap/Boy Ã‡ubuk AD', 'DÄ±ÅŸ Ã‡ap/En Ã‡ubuk AD', 'Ã‡ap2', 'Shrink', 'Tolerans(+)',
    'Tolerans(-)', 'Ebat(En)', 'GÃ¶z AralÄ±ÄŸÄ±', 'Ebat(Boy)', 'HasÄ±r Tipi',
    'Ã–zel Saha 8 (Alf.)', 'AlÄ±ÅŸ FiyatÄ±', 'Fiyat Birimi', 'SatÄ±ÅŸ FiyatÄ±-1',
    'SatÄ±ÅŸ FiyatÄ±-2', 'SatÄ±ÅŸ FiyatÄ±-3', 'SatÄ±ÅŸ FiyatÄ±-4', 'SatÄ±ÅŸ Tipi',
    'DÃ¶viz AlÄ±ÅŸ', 'DÃ¶viz Maliyeti', 'DÃ¶viz SatÄ±ÅŸ FiyatÄ±', 'Azami Stok',
    'Asgari Stok', 'DÃ¶v.Tutar', 'DÃ¶v.Tipi', 'Bekleme SÃ¼resi', 'Temin SÃ¼resi',
    'Birim AÄŸÄ±rlÄ±k', 'Nakliye Tutar', 'SatÄ±ÅŸ KDV OranÄ±', 'AlÄ±ÅŸ KDV OranÄ±',
    'Stok TÃ¼rÃ¼', 'Mali Grup Kodu', 'Barkod 1', 'Barkod 2', 'Barkod 3',
    'Kod-3', 'Kod-4', 'Kod-5', 'Esnek YapÄ±landÄ±r', 'SÃ¼per ReÃ§ete KullanÄ±lsÄ±n',
    'BaÄŸlÄ± Stok Kodu', 'YapÄ±landÄ±rma Kodu', 'Yap. AÃ§Ä±klama', 'AlÄ±ÅŸ DÃ¶viz Tipi',
    'GÃ¼mrÃ¼k Tarife Kodu', 'DaÄŸÄ±tÄ±cÄ± Kodu', 'MenÅŸei'
  ];

  const getYmStHeaders = () => [
    'Stok Kodu', 'Stok AdÄ±', 'Grup Kodu', 'Kod-1', 'Kod-2', 'Kod-3',
    'SatÄ±ÅŸ KDV OranÄ±', 'Muh.Detay', 'Depo Kodu', 'Br-1', 'Br-2', 'Pay-1',
    'Payda-1', 'Ã‡evrim DeÄŸeri-1', 'Ã–lÃ§Ã¼ Br-3', 'Ã‡evrim Pay-2', 'Ã‡evrim Payda-2',
    'Ã‡evrim DeÄŸeri-2', 'AlÄ±ÅŸ FiyatÄ±', 'Fiyat Birimi', 'SatÄ±ÅŸ FiyatÄ±-1',
    'SatÄ±ÅŸ FiyatÄ±-2', 'SatÄ±ÅŸ FiyatÄ±-3', 'SatÄ±ÅŸ FiyatÄ±-4', 'DÃ¶viz Tip',
    'DÃ¶viz AlÄ±ÅŸ', 'DÃ¶viz Maliyeti', 'DÃ¶viz SatÄ±ÅŸ FiyatÄ±', 'Azami Stok',
    'Asgari Stok', 'DÃ¶v.Tutar', 'DÃ¶v.Tipi', 'AlÄ±ÅŸ DÃ¶viz Tipi', 'Bekleme SÃ¼resi',
    'Temin SÃ¼resi', 'Birim AÄŸÄ±rlÄ±k', 'Nakliye Tutar', 'Stok TÃ¼rÃ¼', 'Mali Grup Kodu',
    'Ä°ngilizce Ä°sim', 'Ã–zel Saha 1 (Say.)', 'Ã–zel Saha 2 (Say.)', 'Ã–zel Saha 3 (Say.)',
    'Ã–zel Saha 4 (Say.)', 'Ã–zel Saha 5 (Say.)', 'Ã–zel Saha 6 (Say.)', 'Ã–zel Saha 7 (Say.)',
    'Ã–zel Saha 8 (Say.)', 'Ã–zel Saha 1 (Alf.)', 'Ã–zel Saha 2 (Alf.)', 'Ã–zel Saha 3 (Alf.)',
    'Ã–zel Saha 4 (Alf.)', 'Ã–zel Saha 5 (Alf.)', 'Ã–zel Saha 6 (Alf.)', 'Ã–zel Saha 7 (Alf.)',
    'Ã–zel Saha 8 (Alf.)', 'Kod-4', 'Kod-5', 'Esnek YapÄ±landÄ±r', 'SÃ¼per ReÃ§ete KullanÄ±lsÄ±n',
    'BaÄŸlÄ± Stok Kodu', 'YapÄ±landÄ±rma Kodu', 'Yap. AÃ§Ä±klama'
  ];

  const getReceteHeaders = () => [
    'Mamul Kodu(*)', 'ReÃ§ete Top.', 'Fire OranÄ± (%)', 'Oto.ReÃ§.', 'Ã–lÃ§Ã¼ Br.',
    'SÄ±ra No(*)', 'Operasyon BileÅŸen', 'BileÅŸen Kodu(*)', 'Ã–lÃ§Ã¼ Br. - BileÅŸen',
    'Miktar(*)', 'AÃ§Ä±klama', 'Miktar Sabitle', 'Stok/Maliyet', 'Fire Mik.',
    'Sabit Fire Mik.', 'Ä°stasyon Kodu', 'HazÄ±rlÄ±k SÃ¼resi', 'Ãœretim SÃ¼resi',
    'Ãœ.A.Dahil Edilsin', 'Son Operasyon', 'Ã–ncelik', 'Planlama OranÄ±',
    'Alternatif Politika - D.A.Transfer FiÅŸi', 'Alternatif Politika - Ambar Ã‡. FiÅŸi',
    'Alternatif Politika - Ãœretim S.KaydÄ±', 'Alternatif Politika - MRP', 'Ä°Ã‡/DIÅž'
  ];

  // Excel veri oluÅŸturma fonksiyonlarÄ± - doÄŸru formatlar ve COMMA usage
  const generateMmGtStokKartiData = (sequence = '00') => {
    const cap = parseFloat(mmGtData.cap);
    const capFormatted = Math.round(cap * 100).toString().padStart(4, '0');
    
    return [
      `GT.${mmGtData.kod_2}.${capFormatted}.${sequence}`, // Stok Kodu
      generateStokAdi(), // Stok AdÄ±
      'MM', // Grup Kodu
      'GT', // Kod-1
      mmGtData.kod_2, // Kod-2
      '', // Cari/SatÄ±cÄ± Kodu
      generateEnglishName(), // Ä°ngilizce Ä°sim
      '', // SatÄ±cÄ± Ä°smi
      '26', // Muh. Detay
      '36', // Depo Kodu
      'KG', // Br-1
      'TN', // Br-2
      '1', // Pay-1
      '1,000', // Payda-1 (Excel formatÄ± - COMMA here)
      '0.001', // Ã‡evrim DeÄŸeri-1
      '', // Ã–lÃ§Ã¼ Br-3
      '1', // Ã‡evrim Pay-2
      '1', // Ã‡evrim Payda-2
      '1', // Ã‡evrim DeÄŸeri-2
      cap.toFixed(2), // Ã‡ap (NOKTA)
      mmGtData.kaplama, // Kaplama
      mmGtData.min_mukavemet, // Min Mukavemet
      mmGtData.max_mukavemet, // Max Mukavemet
      mmGtData.kg, // KG
      mmGtData.ic_cap, // Ä°Ã§ Ã‡ap
      mmGtData.dis_cap, // DÄ±ÅŸ Ã‡ap
      '', // Ã‡ap2
      mmGtData.shrink, // Shrink
      mmGtData.tolerans_plus, // Tolerans(+) (NOKTA format)
      mmGtData.tolerans_minus, // Tolerans(-) (NOKTA format)
      '', // Ebat(En)
      '', // GÃ¶z AralÄ±ÄŸÄ±
      '', // Ebat(Boy)
      '', // HasÄ±r Tipi
      '', // Ã–zel Saha 8 (Alf.)
      '0', // AlÄ±ÅŸ FiyatÄ±
      '1', // Fiyat Birimi
      '0', // SatÄ±ÅŸ FiyatÄ±-1
      '0', // SatÄ±ÅŸ FiyatÄ±-2
      '0', // SatÄ±ÅŸ FiyatÄ±-3
      '0', // SatÄ±ÅŸ FiyatÄ±-4
      '1', // SatÄ±ÅŸ Tipi
      '0', // DÃ¶viz AlÄ±ÅŸ
      '0', // DÃ¶viz Maliyeti
      '0', // DÃ¶viz SatÄ±ÅŸ FiyatÄ±
      '0', // Azami Stok
      '0', // Asgari Stok
      '', // DÃ¶v.Tutar
      '0', // DÃ¶v.Tipi
      '0', // Bekleme SÃ¼resi
      '0', // Temin SÃ¼resi
      '0', // Birim AÄŸÄ±rlÄ±k
      '0', // Nakliye Tutar
      '20', // SatÄ±ÅŸ KDV OranÄ±
      '20', // AlÄ±ÅŸ KDV OranÄ±
      'D', // Stok TÃ¼rÃ¼
      '', // Mali Grup Kodu
      '', // Barkod 1
      '', // Barkod 2
      '', // Barkod 3
      '', // Kod-3
      '', // Kod-4
      '', // Kod-5
      'H', // Esnek YapÄ±landÄ±r
      'H', // SÃ¼per ReÃ§ete KullanÄ±lsÄ±n
      '', // BaÄŸlÄ± Stok Kodu
      '', // YapÄ±landÄ±rma Kodu
      '', // Yap. AÃ§Ä±klama
      '2', // AlÄ±ÅŸ DÃ¶viz Tipi
      getGumrukTarifeKodu(), // GÃ¼mrÃ¼k Tarife Kodu
      '', // DaÄŸÄ±tÄ±cÄ± Kodu
      '052', // MenÅŸei
      'Galvanizli Tel', // METARIAL
      cap.toFixed(2).replace('.', ','), // DIA (MM) - COMMA for Excel
      parseFloat(mmGtData.tolerans_plus || 0).toFixed(2).replace('.', ','), // DIA TOL (MM) + - COMMA
      parseFloat(mmGtData.tolerans_minus || 0).toFixed(2).replace('.', ','), // DIA TOL (MM) - - COMMA
      mmGtData.kaplama, // ZING COATING (GR/M2)
      mmGtData.min_mukavemet, // TENSILE ST. (MPA) MIN
      mmGtData.max_mukavemet, // TENSILE ST. (MPA) MAX
      '+', // WAX
      '+', // LIFTING LUGS
      mmGtData.unwinding === 'Clockwise' ? 'Clockwise' : '', // UNWINDING
      mmGtData.cast_kont || '', // CAST KONT. (CM)
      mmGtData.helix_kont || '', // HELIX KONT. (CM)
      mmGtData.elongation || '', // ELONGATION (%) MIN
      mmGtData.ic_cap, // COIL DIMENSIONS (CM) ID
      mmGtData.dis_cap, // COIL DIMENSIONS (CM) OD
      mmGtData.kg, // COIL WEIGHT (KG)
      '', // COIL WEIGHT (KG) MIN
      '' // COIL WEIGHT (KG) MAX
    ];
  };

  const generateYmGtStokKartiData = (sequence = '00') => {
    const cap = parseFloat(mmGtData.cap);
    const capFormatted = Math.round(cap * 100).toString().padStart(4, '0');
    
    return [
      `YM.GT.${mmGtData.kod_2}.${capFormatted}.${sequence}`, // Stok Kodu - sequence eÅŸleÅŸtirme!
      generateYmGtStokAdi(sequence), // Stok AdÄ± - gÃ¼ncel sequence ile!
      'YM', // Grup Kodu
      'GT', // Kod-1
      mmGtData.kod_2, // Kod-2
      generateYmGtCariadiKodu(), // Cari/SatÄ±cÄ± Kodu
      generateYmGtInglizceIsim(), // Ä°ngilizce Ä°sim
      '', // SatÄ±cÄ± Ä°smi
      '83', // Muh. Detay
      '35', // Depo Kodu
      'KG', // Br-1
      'TN', // Br-2
      '1', // Pay-1
      '1,000', // Payda-1 (Excel formatÄ± - COMMA here)
      '0.001', // Ã‡evrim DeÄŸeri-1
      '', // Ã–lÃ§Ã¼ Br-3
      '1', // Ã‡evrim Pay-2
      '1', // Ã‡evrim Payda-2
      '1', // Ã‡evrim DeÄŸeri-2
      cap.toFixed(2), // Ã‡ap (NOKTA)
      mmGtData.kaplama, // Kaplama
      mmGtData.min_mukavemet, // Min Mukavemet
      mmGtData.max_mukavemet, // Max Mukavemet
      mmGtData.kg, // KG
      mmGtData.ic_cap, // Ä°Ã§ Ã‡ap
      mmGtData.dis_cap, // DÄ±ÅŸ Ã‡ap
      '', // Ã‡ap2
      mmGtData.shrink, // Shrink
      mmGtData.tolerans_plus, // Tolerans(+) - POINT for Excel
      mmGtData.tolerans_minus, // Tolerans(-) - POINT for Excel
      '', // Ebat(En)
      '', // GÃ¶z AralÄ±ÄŸÄ±
      '', // Ebat(Boy)
      '', // HasÄ±r Tipi
      '', // Ã–zel Saha 8 (Alf.)
      '0', // AlÄ±ÅŸ FiyatÄ±
      '1', // Fiyat Birimi
      '0', // SatÄ±ÅŸ FiyatÄ±-1
      '0', // SatÄ±ÅŸ FiyatÄ±-2
      '0', // SatÄ±ÅŸ FiyatÄ±-3
      '0', // SatÄ±ÅŸ FiyatÄ±-4
      '1', // SatÄ±ÅŸ Tipi
      '0', // DÃ¶viz AlÄ±ÅŸ
      '0', // DÃ¶viz Maliyeti
      '0', // DÃ¶viz SatÄ±ÅŸ FiyatÄ±
      '0', // Azami Stok
      '0', // Asgari Stok
      '', // DÃ¶v.Tutar
      '0', // DÃ¶v.Tipi
      '0', // Bekleme SÃ¼resi
      '0', // Temin SÃ¼resi
      '0', // Birim AÄŸÄ±rlÄ±k
      '0', // Nakliye Tutar
      '20', // SatÄ±ÅŸ KDV OranÄ±
      '20', // AlÄ±ÅŸ KDV OranÄ±
      'D', // Stok TÃ¼rÃ¼
      '', // Mali Grup Kodu
      '', // Barkod 1
      '', // Barkod 2
      '', // Barkod 3
      '', // Kod-3
      '', // Kod-4
      '', // Kod-5
      'H', // Esnek YapÄ±landÄ±r
      'H', // SÃ¼per ReÃ§ete KullanÄ±lsÄ±n
      '', // BaÄŸlÄ± Stok Kodu
      '', // YapÄ±landÄ±rma Kodu
      '', // Yap. AÃ§Ä±klama
      '', // AlÄ±ÅŸ DÃ¶viz Tipi
      '', // GÃ¼mrÃ¼k Tarife Kodu
      '', // DaÄŸÄ±tÄ±cÄ± Kodu
      '' // MenÅŸei
    ];
  };

  const generateYmStStokKartiData = (ymSt) => {
    return [
      ymSt.stok_kodu, // Stok Kodu
      ymSt.stok_adi, // Stok AdÄ±
      'YM', // Grup Kodu
      'ST', // Kod-1
      '', // Kod-2
      '', // Kod-3
      '20', // SatÄ±ÅŸ KDV OranÄ±
      '28', // Muh.Detay
      '35', // Depo Kodu
      'KG', // Br-1
      'TN', // Br-2
      '1', // Pay-1
      '1,000', // Payda-1 (Excel formatÄ± - COMMA here)
      '0.001', // Ã‡evrim DeÄŸeri-1
      '', // Ã–lÃ§Ã¼ Br-3
      '1', // Ã‡evrim Pay-2
      '1', // Ã‡evrim Payda-2
      '1', // Ã‡evrim DeÄŸeri-2
      '0', // AlÄ±ÅŸ FiyatÄ±
      '1', // Fiyat Birimi
      '0', // SatÄ±ÅŸ FiyatÄ±-1
      '0', // SatÄ±ÅŸ FiyatÄ±-2
      '0', // SatÄ±ÅŸ FiyatÄ±-3
      '0', // SatÄ±ÅŸ FiyatÄ±-4
      '1', // DÃ¶viz Tip
      '0', // DÃ¶viz AlÄ±ÅŸ
      '0', // DÃ¶viz Maliyeti
      '0', // DÃ¶viz SatÄ±ÅŸ FiyatÄ±
      '0', // Azami Stok
      '0', // Asgari Stok
      '', // DÃ¶v.Tutar
      '0', // DÃ¶v.Tipi
      '0', // AlÄ±ÅŸ DÃ¶viz Tipi
      '0', // Bekleme SÃ¼resi
      '0', // Temin SÃ¼resi
      '0', // Birim AÄŸÄ±rlÄ±k
      '0', // Nakliye Tutar
      'D', // Stok TÃ¼rÃ¼
      '', // Mali Grup Kodu
      '', // Ä°ngilizce Ä°sim
      '1', // Ã–zel Saha 1 (Say.)
      '0', // Ã–zel Saha 2 (Say.)
      '0', // Ã–zel Saha 3 (Say.)
      '0', // Ã–zel Saha 4 (Say.)
      '0', // Ã–zel Saha 5 (Say.)
      '0', // Ã–zel Saha 6 (Say.)
      '0', // Ã–zel Saha 7 (Say.)
      '0', // Ã–zel Saha 8 (Say.)
      '', // Ã–zel Saha 1 (Alf.)
      '', // Ã–zel Saha 2 (Alf.)
      '', // Ã–zel Saha 3 (Alf.)
      '', // Ã–zel Saha 4 (Alf.)
      '', // Ã–zel Saha 5 (Alf.)
      '', // Ã–zel Saha 6 (Alf.)
      '', // Ã–zel Saha 7 (Alf.)
      '', // Ã–zel Saha 8 (Alf.)
      '', // Kod-4
      '', // Kod-5
      'H', // Esnek YapÄ±landÄ±r
      'H', // SÃ¼per ReÃ§ete KullanÄ±lsÄ±n
      '', // BaÄŸlÄ± Stok Kodu
      '', // YapÄ±landÄ±rma Kodu
      '' // Yap. AÃ§Ä±klama
    ];
  };

  // ReÃ§ete satÄ±r oluÅŸturma fonksiyonlarÄ±
  const generateMmGtReceteRow = (bilesenKodu, miktar, siraNo, sequence = '00') => {
    const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
    
    return [
      `GT.${mmGtData.kod_2}.${capFormatted}.${sequence}`, // Mamul Kodu - gÃ¼ncel sequence ile!
      '1', // ReÃ§ete Top.
      '0.0004', // Fire OranÄ± (%) - NOKTA for decimals as requested
      '', // Oto.ReÃ§.
      getOlcuBr(bilesenKodu), // Ã–lÃ§Ã¼ Br.
      siraNo, // SÄ±ra No - incremental as requested
      bilesenKodu === 'GTPKT01' ? 'Operasyon' : 'BileÅŸen', // GTPKT01 should be marked as Operasyon per Excel format
      bilesenKodu, // BileÅŸen Kodu
      '1', // Ã–lÃ§Ã¼ Br. - BileÅŸen
      miktar, // Miktar (nokta formatÄ±nda internal)
      getReceteAciklama(bilesenKodu), // AÃ§Ä±klama
      '', // Miktar Sabitle
      '', // Stok/Maliyet
      '', // Fire Mik.
      '', // Sabit Fire Mik.
      '', // Ä°stasyon Kodu
      '', // HazÄ±rlÄ±k SÃ¼resi
      bilesenKodu === 'GTPKT01' ? miktar : '', // Ãœretim SÃ¼resi - only for GTPKT01
      'evet', // Ãœ.A.Dahil Edilsin
      'evet', // Son Operasyon
      '', // Ã–ncelik
      '', // Planlama OranÄ±
      '', // Alternatif Politika - D.A.Transfer FiÅŸi
      '', // Alternatif Politika - Ambar Ã‡. FiÅŸi
      '', // Alternatif Politika - Ãœretim S.KaydÄ±
      '', // Alternatif Politika - MRP
      '' // Ä°Ã‡/DIÅž
    ];
  };

  const generateYmGtReceteRow = (bilesenKodu, miktar, siraNo, sequence = '00') => {
    const capFormatted = Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0');
    
    return [
      `YM.GT.${mmGtData.kod_2}.${capFormatted}.${sequence}`, // Mamul Kodu - gÃ¼ncel sequence ile!
      '1', // ReÃ§ete Top.
      '0', // Fire OranÄ± (%)
      '', // Oto.ReÃ§.
      getOlcuBr(bilesenKodu), // Ã–lÃ§Ã¼ Br.
      siraNo, // SÄ±ra No - incremental as requested
      bilesenKodu === 'GLV01' ? 'Operasyon' : 'BileÅŸen', // According to Excel format, only GLV01 is Operasyon, all others are BileÅŸen
      bilesenKodu, // BileÅŸen Kodu
      '1', // Ã–lÃ§Ã¼ Br. - BileÅŸen
      miktar, // Miktar (nokta formatÄ±nda internal)
      getReceteAciklama(bilesenKodu), // AÃ§Ä±klama
      '', // Miktar Sabitle
      '', // Stok/Maliyet
      '', // Fire Mik.
      '', // Sabit Fire Mik.
      '', // Ä°stasyon Kodu
      '', // HazÄ±rlÄ±k SÃ¼resi
      bilesenKodu === 'GLV01' ? miktar : '', // Ãœretim SÃ¼resi - only for GLV01
      '', // Ãœ.A.Dahil Edilsin
      '', // Son Operasyon
      '', // Ã–ncelik
      '', // Planlama OranÄ±
      '', // Alternatif Politika - D.A.Transfer FiÅŸi
      '', // Alternatif Politika - Ambar Ã‡. FiÅŸi
      '', // Alternatif Politika - Ãœretim S.KaydÄ±
      '', // Alternatif Politika - MRP
      '' // Ä°Ã‡/DIÅž
    ];
  };

  const generateYmStReceteRow = (bilesenKodu, miktar, siraNo, ymSt) => {
    return [
      ymSt.stok_kodu || '', // Mamul Kodu
      '1', // ReÃ§ete Top.
      '', // Fire OranÄ± (%)
      '', // Oto.ReÃ§.
      getOlcuBr(bilesenKodu), // Ã–lÃ§Ã¼ Br.
      siraNo, // SÄ±ra No - incremental as requested
      bilesenKodu.includes('FLM.') ? 'BileÅŸen' : (bilesenKodu === 'TLC01' ? 'Operasyon' : 'BileÅŸen'), // FLM kodu her zaman BileÅŸen olmalÄ±, sadece TLC01 Operasyon olmalÄ±
      bilesenKodu, // BileÅŸen Kodu
      '1', // Ã–lÃ§Ã¼ Br. - BileÅŸen
      miktar, // Miktar (nokta formatÄ±nda internal)
      getReceteAciklama(bilesenKodu), // AÃ§Ä±klama
      '', // Miktar Sabitle
      '', // Stok/Maliyet
      '', // Fire Mik.
      '', // Sabit Fire Mik.
      '', // Ä°stasyon Kodu
      '', // HazÄ±rlÄ±k SÃ¼resi
      bilesenKodu === 'TLC01' ? miktar : '', // Ãœretim SÃ¼resi - Sadece TLC01 iÃ§in
      '', // Ãœ.A.Dahil Edilsin
      '', // Son Operasyon
      '', // Ã–ncelik
      '', // Planlama OranÄ±
      '', // Alternatif Politika - D.A.Transfer FiÅŸi
      '', // Alternatif Politika - Ambar Ã‡. FiÅŸi
      '', // Alternatif Politika - Ãœretim S.KaydÄ±
      '', // Alternatif Politika - MRP
      '' // Ä°Ã‡/DIÅž
    ];
  };

  // String oluÅŸturma fonksiyonlarÄ± - COMMA Excel formatÄ±nda
  const generateStokAdi = () => {
    const cap = parseFloat(mmGtData.cap) || 0;
    const toleransPlus = parseFloat(mmGtData.tolerans_plus) || 0;
    const toleransMinus = parseFloat(mmGtData.tolerans_minus) || 0;
    
    // Use comma for decimal separators in Excel output
    return `Galvanizli Tel ${cap.toFixed(2).replace('.', ',')} mm -${Math.abs(toleransMinus).toFixed(2).replace('.', ',')}/+${toleransPlus.toFixed(2).replace('.', ',')} ${mmGtData.kaplama || '0'} gr/mÂ² ${mmGtData.min_mukavemet || '0'}-${mmGtData.max_mukavemet || '0'} MPa ID:${mmGtData.ic_cap || '45'} cm OD:${mmGtData.dis_cap || '75'} cm ${mmGtData.kg || '0'} kg`;
  };

  const generateYmGtStokAdi = (sequence = '00') => {
    const cap = parseFloat(mmGtData.cap) || 0;
    const toleransPlus = parseFloat(mmGtData.tolerans_plus) || 0;
    const toleransMinus = parseFloat(mmGtData.tolerans_minus) || 0;
    
    return `YM Galvanizli Tel ${cap.toFixed(2).replace('.', ',')} mm -${Math.abs(toleransMinus).toFixed(2).replace('.', ',')}/+${toleransPlus.toFixed(2).replace('.', ',')} ${mmGtData.kaplama || '0'} gr/mÂ² ${mmGtData.min_mukavemet || '0'}-${mmGtData.max_mukavemet || '0'} MPa ID:${mmGtData.ic_cap || '45'} cm OD:${mmGtData.dis_cap || '75'} cm ${mmGtData.kg || '0'} kg`;
  };

  const generateYmGtCariadiKodu = () => {
    const cap = parseFloat(mmGtData.cap) || 0;
    const toleransPlus = parseFloat(mmGtData.tolerans_plus) || 0;
    const toleransMinus = parseFloat(mmGtData.tolerans_minus) || 0;
    
    // Use comma for decimal separators in Excel output
    return `Tel ${cap.toFixed(2).replace('.', ',')} mm -${Math.abs(toleransMinus).toFixed(2).replace('.', ',')}/+${toleransPlus.toFixed(2).replace('.', ',')} ${mmGtData.kaplama || '0'} gr/mÂ²${mmGtData.min_mukavemet || '0'}-${mmGtData.max_mukavemet || '0'} MPa ID:${mmGtData.ic_cap || '45'} cm OD:${mmGtData.dis_cap || '75'} cm ${mmGtData.kg || '0'} kg`;
  };

  const generateYmGtInglizceIsim = () => {
    const cap = parseFloat(mmGtData.cap) || 0;
    const toleransPlus = parseFloat(mmGtData.tolerans_plus) || 0;
    const toleransMinus = parseFloat(mmGtData.tolerans_minus) || 0;
    
    return `Galvanized Steel Wire ${cap.toFixed(2).replace('.', ',')} mm -${Math.abs(toleransMinus).toFixed(2).replace('.', ',')}/+${toleransPlus.toFixed(2).replace('.', ',')} ${mmGtData.kaplama || '0'} gr/mÂ² ${mmGtData.min_mukavemet || '0'}-${mmGtData.max_mukavemet || '0'} MPa ID:${mmGtData.ic_cap || '45'} cm OD:${mmGtData.dis_cap || '75'} cm ${mmGtData.kg || '0'} kg`;
  };

  const generateEnglishName = () => {
    const cap = parseFloat(mmGtData.cap) || 0;
    const toleransPlus = parseFloat(mmGtData.tolerans_plus) || 0;
    const toleransMinus = parseFloat(mmGtData.tolerans_minus) || 0;
    
    // Use comma for decimal separators in Excel output
    return `Galvanized Steel Wire ${cap.toFixed(2).replace('.', ',')} mm -${Math.abs(toleransMinus).toFixed(2).replace('.', ',')}/+${toleransPlus.toFixed(2).replace('.', ',')} ${mmGtData.kaplama || '0'} gr/mÂ² ${mmGtData.min_mukavemet || '0'}-${mmGtData.max_mukavemet || '0'} MPa ID:${mmGtData.ic_cap || '45'} cm OD:${mmGtData.dis_cap || '75'} cm ${mmGtData.kg || '0'} kg`;
  };

  // Talep onaylama
  const handleApproveRequest = async () => {
    if (!selectedRequest || !databaseIds.mmGtIds.length) {
      toast.error('Onaylamak iÃ§in Ã¶nce veritabanÄ±na kaydedin');
      return;
    }
    
    try {
      setIsLoading(true);
      
      const response = await fetchWithAuth(`${API_URLS.galSalRequests}/${selectedRequest.id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          status: 'approved',
          processed_by: user.username,
          processed_at: new Date().toISOString(),
          mm_gt_id: databaseIds.mmGtIds[0] // Ä°lk MM GT ID'yi kullan
        })
      });
      
      if (response && response.ok) {
        toast.success('Talep baÅŸarÄ±yla onaylandÄ±');
        fetchRequests();
        setSelectedRequest(null);
      } else {
        throw new Error('Talep onaylanamadÄ±');
      }
    } catch (error) {
      console.error('Talep onaylama hatasÄ±:', error);
      toast.error('Talep onaylama hatasÄ±: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  // Talep reddetme
  const handleRejectRequest = async () => {
    if (!selectedRequest) return;
    
    const reason = prompt('Red nedeni:');
    if (!reason) return;
    
    try {
      setIsLoading(true);
      
      const response = await fetchWithAuth(`${API_URLS.galSalRequests}/${selectedRequest.id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          status: 'rejected',
          processed_by: user.username,
          processed_at: new Date().toISOString(),
          rejection_reason: reason
        })
      });
      
      if (response && response.ok) {
        toast.success('Talep baÅŸarÄ±yla reddedildi');
        fetchRequests();
        setSelectedRequest(null);
      } else {
        throw new Error('Talep reddedilemedi');
      }
    } catch (error) {
      console.error('Talep reddetme hatasÄ±:', error);
      toast.error('Talep reddetme hatasÄ±: ' + error.message);
    } finally {
      setIsLoading(false);
    }
  };

  // Shrink miktarÄ± ve tipi ile ilgili yardÄ±mcÄ± fonksiyonlar
  const handleShrinkChange = (recipeIndex, newShrinkCode) => {
    const currentShrinkAmount = calculateShrinkAmount(parseFloat(mmGtData.kg) || 0);
    const allYmSts = [...selectedYmSts, ...autoGeneratedYmSts];
    
    // Mevcut reÃ§eteleri gÃ¼ncelle
    updateRecipeValue('mmgt', recipeIndex, newShrinkCode, currentShrinkAmount);
    
    // Eski shrink kodlarÄ±nÄ± temizle (eÄŸer farklÄ±ysa)
    const shrinkTypes = ['AMB.SHRÄ°NK.200*140CM', 'AMB.SHRÄ°NK.200*160CM', 'AMB.SHRÄ°NK.200*190CM'];
    shrinkTypes.forEach(shrinkType => {
      if (shrinkType !== newShrinkCode) {
        updateRecipeValue('mmgt', recipeIndex, shrinkType, 0);
      }
    });
  };

  return (
    <div className="p-6 max-w-7xl mx-auto bg-gray-50 min-h-screen">
      {/* Ana BaÅŸlÄ±k ve Butonlar */}
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-3">
          <div className="w-8 h-8 bg-red-600 rounded-lg flex items-center justify-center">
            <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
          </div>
          Galvanizli Tel Netsis Entegrasyonu
        </h1>
        
        <div className="flex gap-3">
          <button
            onClick={() => setShowSettingsModal(true)}
            className="px-3 py-2 bg-gray-800 text-white rounded-md text-sm flex items-center"
          >
            <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Hesaplama DeÄŸerleri
          </button>
          <button
            onClick={() => setShowExistingMmGtModal(true)}
            className="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors shadow-lg flex items-center gap-2"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            VeritabanÄ±ndan SeÃ§
          </button>
          
          <button
            onClick={() => setShowRequestsModal(true)}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-lg relative flex items-center gap-2"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
            </svg>
            Talepler
            {requests.length > 0 && (
              <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                {requests.length}
              </span>
            )}
          </button>
        </div>
      </div>

      {/* Ana Ä°Ã§erik */}
      {currentStep === 'input' && (
        <div className="bg-white rounded-xl shadow-lg p-8">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-xl font-semibold text-gray-800">MM GT ÃœrÃ¼n Bilgileri</h2>
            <div className="flex items-center gap-2 text-sm text-gray-500">
              <span className="w-2 h-2 bg-red-500 rounded-full"></span>
              <span>Zorunlu Alanlar</span>
            </div>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Ã‡ap (mm) <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                inputMode="decimal"
                value={normalizeDecimalDisplay(mmGtData.cap)}
                onChange={(e) => handleInputChange('cap', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
                placeholder="0.00000"
                lang="en-US" // Force EN-US locale with point decimal separator
                onKeyDown={(e) => handleCommaToPoint(e, 'cap')}
              />
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Kaplama TÃ¼rÃ¼ <span className="text-red-500">*</span>
              </label>
              <select
                value={mmGtData.kod_2}
                onChange={(e) => handleInputChange('kod_2', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
              >
                <option value="NIT">NIT</option>
                <option value="PAD">PAD</option>
              </select>
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Kaplama (gr/mÂ²) <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                inputMode="decimal"
                value={normalizeDecimalDisplay(mmGtData.kaplama)}
                onChange={(e) => handleInputChange('kaplama', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
                disabled={mmGtData.kod_2 === 'PAD'}
                placeholder="50-400"
                onKeyDown={(e) => handleCommaToPoint(e, 'kaplama')}
              />
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Min Mukavemet (MPa) <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                inputMode="decimal"
                value={normalizeDecimalDisplay(mmGtData.min_mukavemet)}
                onChange={(e) => handleInputChange('min_mukavemet', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
                placeholder="350-1000"
                onKeyDown={(e) => handleCommaToPoint(e, 'min_mukavemet')}
              />
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Max Mukavemet (MPa) <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                inputMode="decimal"
                value={normalizeDecimalDisplay(mmGtData.max_mukavemet)}
                onChange={(e) => handleInputChange('max_mukavemet', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
                placeholder="350-1000"
                onKeyDown={(e) => handleCommaToPoint(e, 'max_mukavemet')}
              />
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                AÄŸÄ±rlÄ±k (kg) <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                inputMode="decimal"
                value={normalizeDecimalDisplay(mmGtData.kg)}
                onChange={(e) => handleInputChange('kg', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
                placeholder="250-1250"
                onKeyDown={(e) => handleCommaToPoint(e, 'kg')}
              />
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Ä°Ã§ Ã‡ap (cm)
              </label>
              <select
                value={mmGtData.ic_cap}
                onChange={(e) => handleInputChange('ic_cap', parseInt(e.target.value))}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
              >
                <option value={45}>45</option>
                <option value={50}>50</option>
                <option value={55}>55</option>
              </select>
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                DÄ±ÅŸ Ã‡ap (cm)
              </label>
              <input
                type="text"
                inputMode="decimal"
                value={normalizeDecimalDisplay(mmGtData.dis_cap || '')}
                onChange={(e) => handleInputChange('dis_cap', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all bg-gray-50"
                readOnly
              />
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Tolerans (+)
              </label>
              <input
                type="text"
                inputMode="decimal"
                value={normalizeDecimalDisplay(mmGtData.tolerans_plus || '')}
                onChange={(e) => handleInputChange('tolerans_plus', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
                placeholder="0.00000"
                onKeyDown={(e) => handleCommaToPoint(e, 'tolerans_plus')}
              />
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Tolerans (-)
              </label>
              <input
                type="text"
                inputMode="decimal"
                value={normalizeDecimalDisplay(mmGtData.tolerans_minus || '')}
                onChange={(e) => handleInputChange('tolerans_minus', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
                placeholder="0.00000"
                onKeyDown={(e) => handleCommaToPoint(e, 'tolerans_minus')}
              />
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Shrink
              </label>
              <select
                value={mmGtData.shrink}
                onChange={(e) => handleInputChange('shrink', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
              >
                <option value="evet">Evet</option>
                <option value="hayÄ±r">HayÄ±r</option>
              </select>
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Unwinding
              </label>
              <select
                value={mmGtData.unwinding}
                onChange={(e) => handleInputChange('unwinding', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
              >
                <option value="">Anti-Clockwise (VarsayÄ±lan)</option>
                <option value="Clockwise">Clockwise</option>
              </select>
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Cast Kont
              </label>
              <input
                type="text"
                value={mmGtData.cast_kont}
                onChange={(e) => handleInputChange('cast_kont', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
                placeholder="Opsiyonel"
              />
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Helix Kont
              </label>
              <input
                type="text"
                value={mmGtData.helix_kont}
                onChange={(e) => handleInputChange('helix_kont', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
                placeholder="Opsiyonel"
              />
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Elongation
              </label>
              <input
                type="text"
                value={mmGtData.elongation}
                onChange={(e) => handleInputChange('elongation', e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
                placeholder="Opsiyonel"
              />
            </div>
          </div>

          <div className="mt-8 flex justify-end">
            <button
              onClick={handleNext}
              disabled={isLoading}
              className="bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 shadow-lg flex items-center gap-2"
            >
              {isLoading ? (
                <>
                  <svg className="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Ä°ÅŸleniyor...
                </>
              ) : (
                <>
                  Devam
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </>
              )}
            </button>
          </div>
        </div>
      )}

      {currentStep === 'summary' && (
        <div className="space-y-6">
          {/* Durum Ã‡ubuÄŸu */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                {selectedRequest && (
                  <div className="bg-blue-50 px-4 py-2 rounded-lg">
                    <span className="text-blue-700 font-medium">ðŸ“‹ Talep SeÃ§ildi</span>
                  </div>
                )}
                {selectedExistingMmGt && (
                  <div className="bg-purple-50 px-4 py-2 rounded-lg">
                    <span className="text-purple-700 font-medium">ðŸ” Mevcut MM GT SeÃ§ildi</span>
                  </div>
                )}
                {isRequestUsed && (
                  <div className="bg-yellow-50 px-4 py-2 rounded-lg border border-yellow-200">
                    <span className="text-yellow-700 font-medium">âš ï¸ KullanÄ±lan talep var - Kaydet/Export sonrasÄ± silinebilir</span>
                  </div>
                )}
              </div>
              
              <button
                onClick={handleBackToManual}
                className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Manuel GiriÅŸe DÃ¶n
              </button>
            </div>
          </div>

          {/* MM GT Ã–zet */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <div className="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                <span className="text-red-600 font-bold">MM</span>
              </div>
              MM GT ÃœrÃ¼n Ã–zeti
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {[
                { label: 'Stok Kodu', value: `GT.${mmGtData.kod_2}.${Math.round(parseFloat(mmGtData.cap || 0) * 100).toString().padStart(4, '0')}.00` },
                { label: 'Ã‡ap', value: `${mmGtData.cap || '0'} mm` },
                { label: 'Kaplama TÃ¼rÃ¼', value: mmGtData.kod_2 },
                { label: 'Kaplama', value: `${mmGtData.kaplama || '0'} gr/mÂ²` },
                { label: 'Mukavemet', value: `${mmGtData.min_mukavemet || '0'}-${mmGtData.max_mukavemet || '0'} MPa` },
                { label: 'AÄŸÄ±rlÄ±k', value: `${mmGtData.kg || '0'} kg` }
              ].map((item, index) => (
                <div key={index} className="bg-gray-50 p-4 rounded-lg">
                  <span className="text-sm text-gray-500 block">{item.label}:</span>
                  <p className="font-semibold text-gray-800">{item.value}</p>
                </div>
              ))}
            </div>
          </div>

          {/* YM GT Ã–zet */}
          {ymGtData && (
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                <div className="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                  <span className="text-yellow-600 font-bold">YM</span>
                </div>
                YM GT ÃœrÃ¼n Ã–zeti
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-gray-50 p-4 rounded-lg">
                  <span className="text-sm text-gray-500 block">Stok Kodu:</span>
                  <p className="font-semibold text-gray-800">{ymGtData.stok_kodu}</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <span className="text-sm text-gray-500 block">Stok AdÄ±:</span>
                  <p className="font-semibold text-gray-800">{ymGtData.stok_adi}</p>
                </div>
              </div>
            </div>
          )}

          {/* YM ST YÃ¶netimi - GeliÅŸtirilmiÅŸ UI */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-xl font-semibold flex items-center gap-2">
                <div className="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                  <span className="text-green-600 font-bold">ST</span>
                </div>
                YM ST SeÃ§imi ve YÃ¶netimi
              </h2>
              <div className="flex gap-3">
                <button
                  onClick={() => setShowAddYmStModal(true)}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-lg flex items-center gap-2"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                  </svg>
                  YM ST Ekle
                </button>
                <button
                  onClick={findSuitableYmSts}
                  disabled={isLoading}
                  className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors shadow-lg flex items-center gap-2 disabled:opacity-50"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                  YM ST Listesini GÃ¼ncelle
                </button>
                <button
                  onClick={generateAutoYmSts}
                  className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-lg flex items-center gap-2"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                  Otomatik OluÅŸtur
                </button>
              </div>
            </div>

            {/* Uygun YM ST'ler - Ä°yileÅŸtirilmiÅŸ tasarÄ±m */}
            {suitableYmSts.length > 0 && (
              <div className="mb-8">
                <h3 className="text-lg font-medium mb-4 text-gray-700">VeritabanÄ±ndan Uygun YM ST'ler</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {suitableYmSts.map(ymSt => {
                    const isSelected = selectedYmSts.find(item => item.stok_kodu === ymSt.stok_kodu);
                    return (
                      <div
                        key={ymSt.id}
                        className={`p-4 border-2 rounded-lg cursor-pointer transition-all transform hover:scale-105 ${
                          isSelected
                            ? 'bg-blue-100 border-blue-500 shadow-lg ring-2 ring-blue-200'
                            : 'bg-gray-50 border-gray-200 hover:bg-blue-50 hover:border-blue-300'
                        }`}
                        onClick={() => handleYmStSelection(ymSt)}
                      >
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex-1">
                            <p className="font-semibold text-gray-800 text-sm">{ymSt.stok_kodu || ''}</p>
                            <p className="text-xs text-gray-600 mt-1 line-clamp-2">{ymSt.stok_adi || ''}</p>
                          </div>
                          <div className={`ml-3 text-center ${isSelected ? 'text-blue-600' : 'text-gray-400'}`}>
                            {isSelected ? (
                              <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                              </svg>
                            ) : (
                              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                              </svg>
                            )}
                          </div>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="inline-block px-3 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                            VeritabanÄ±
                          </span>
                          <span className="text-sm font-medium text-gray-700">
                            {parseFloat(ymSt.cap || 0)} mm
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* SeÃ§ilen YM ST'ler - Ä°yileÅŸtirilmiÅŸ tasarÄ±m */}
            {(selectedYmSts.length > 0 || autoGeneratedYmSts.length > 0) && (
              <div className="border-t pt-6">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-medium text-gray-700">SeÃ§ilen / OluÅŸturulan YM ST'ler</h3>
                  <div className="flex items-center">
                    <span className="text-sm text-blue-700 font-semibold mr-2">
                      <svg className="w-5 h-5 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fillRule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732l-3.354 1.935-1.18 4.455a1 1 0 01-1.933 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732l3.354-1.935 1.18-4.455A1 1 0 0112 2z" clipRule="evenodd" />
                      </svg>
                      Ana YM ST'yi seÃ§in - ÃœrÃ¼n iliÅŸkisi buna gÃ¶re kurulacak
                    </span>
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {/* SeÃ§ilen YM ST'ler */}
                  {selectedYmSts.map((ymSt, index) => {
                    const selectedIndex = index;
                    const isMain = mainYmStIndex === selectedIndex;
                    
                    return (
                      <div
                        key={`selected-${index}`}
                        className={`p-4 border-2 rounded-lg ${
                          isMain ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-300' : 'border-green-200 bg-green-50'
                        }`}
                      >
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex-1">
                            <div className="flex items-center">
                              <input
                                type="radio"
                                name="mainYmSt"
                                id={`main-ymst-${index}`}
                                checked={isMain}
                                onChange={() => setMainYmStIndex(selectedIndex)}
                                className="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500"
                              />
                              <label htmlFor={`main-ymst-${index}`} className="font-semibold text-gray-800 text-sm">
                                {isMain && (
                                  <span className="text-blue-700 font-bold mr-1">Ana YM ST - </span>
                                )}
                                {ymSt.stok_kodu || ''}
                              </label>
                            </div>
                            <p className="text-xs text-gray-600 mt-1 line-clamp-2 ml-6">{ymSt.stok_adi || ''}</p>
                          </div>
                          <button
                            onClick={() => {
                              // If removing the main YMST, set a new main YMST
                              if (isMain) {
                                // Find new main index - prefer to keep among selected YMSTs
                                const newMainIndex = selectedYmSts.length > 1 
                                  ? (index === selectedYmSts.length - 1 ? index - 1 : index + 1) 
                                  : (autoGeneratedYmSts.length > 0 ? selectedYmSts.length : 0);
                                setMainYmStIndex(newMainIndex);
                              } else if (index < mainYmStIndex) {
                                // If removing an YMST with index less than main, adjust main index
                                setMainYmStIndex(mainYmStIndex - 1);
                              }
                              removeSelectedYmSt(index);
                            }}
                            className="ml-3 text-red-500 hover:text-red-700 transition-colors"
                          >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className={`inline-block px-3 py-1 text-xs rounded-full ${
                            isMain ? 'bg-blue-200 text-blue-800' : 'bg-green-100 text-green-800'
                          }`}>
                            {ymSt.source === 'manual-added' ? 'Elle Eklendi' : 'VeritabanÄ±'}
                            {isMain && ' (Ana)'}
                          </span>
                          <span className="text-sm font-medium text-gray-700">
                            {parseFloat(ymSt.cap || 0)} mm
                          </span>
                        </div>
                      </div>
                    );
                  })}

                  {/* Otomatik oluÅŸturulan YM ST'ler */}
                  {autoGeneratedYmSts.map((ymSt, index) => {
                    const autoIndex = selectedYmSts.length + index;
                    const isMain = mainYmStIndex === autoIndex;
                    
                    return (
                      <div
                        key={`auto-${index}`}
                        className={`p-4 border-2 rounded-lg ${
                          isMain ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-300' : 'border-purple-200 bg-purple-50'
                        }`}
                      >
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex-1">
                            <div className="flex items-center">
                              <input
                                type="radio"
                                name="mainYmSt"
                                id={`main-ymst-auto-${index}`}
                                checked={isMain}
                                onChange={() => setMainYmStIndex(autoIndex)}
                                className="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500"
                              />
                              <label htmlFor={`main-ymst-auto-${index}`} className="font-semibold text-gray-800 text-sm">
                                {isMain && (
                                  <span className="text-blue-700 font-bold mr-1">Ana YM ST - </span>
                                )}
                                {ymSt.stok_kodu || ''}
                              </label>
                            </div>
                            <p className="text-xs text-gray-600 mt-1 line-clamp-2 ml-6">{ymSt.stok_adi || ''}</p>
                          </div>
                          <button
                            onClick={() => {
                              // If removing the main YMST, set a new main YMST
                              if (isMain) {
                                // Find new main index - prefer to keep among auto YMSTs or selected YMSTs
                                const newMainIndex = autoGeneratedYmSts.length > 1 
                                  ? (index === autoGeneratedYmSts.length - 1 
                                    ? selectedYmSts.length + index - 1 
                                    : selectedYmSts.length + index + 1) 
                                  : (selectedYmSts.length > 0 ? 0 : 0);
                                setMainYmStIndex(newMainIndex);
                              } else if (autoIndex < mainYmStIndex) {
                                // If removing an YMST with index less than main, adjust main index
                                setMainYmStIndex(mainYmStIndex - 1);
                              }
                              removeAutoGeneratedYmSt(index);
                            }}
                            className="ml-3 text-red-500 hover:text-red-700 transition-colors"
                          >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className={`inline-block px-3 py-1 text-xs rounded-full ${
                            isMain ? 'bg-blue-200 text-blue-800' : 'bg-purple-100 text-purple-800'
                          }`}>
                            Otomatik OluÅŸturuldu
                            {isMain && ' (Ana)'}
                          </span>
                          <span className="text-sm font-medium text-gray-700">
                            {parseFloat(ymSt.cap || 0)} mm
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>

          {/* ReÃ§ete BÃ¶lÃ¼mÃ¼ - Kategorize GÃ¶rÃ¼ntÃ¼leme */}
          {(selectedYmSts.length > 0 || autoGeneratedYmSts.length > 0) && (
            <div className="bg-white rounded-xl shadow-lg p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-semibold flex items-center gap-2">
                  <div className="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                    <span className="text-purple-600 font-bold">R</span>
                  </div>
                  ReÃ§ete DeÄŸerleri
                </h2>
                <div className="flex gap-3">
                  <button
                    onClick={() => fetchRecipesFromDatabase()}
                    disabled={isLoading}
                    className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors shadow-lg flex items-center gap-2 disabled:opacity-50"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    VeritabanÄ±ndan Getir
                  </button>
                  <button
                    onClick={() => {
                      // First calculate auto recipe values
                      calculateAutoRecipeValues();
                      
                      // Then ensure the FilmaÅŸin Tipi field is updated in the UI
                      setTimeout(() => {
                        // Force UI refresh by setting state
                        setAllRecipes(prevRecipes => ({ ...prevRecipes }));
                      }, 100);
                    }}
                    className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors shadow-lg flex items-center gap-2"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7l4-4 4 4m0 6l-4 4-4-4" />
                    </svg>
                    Otomatik Doldur
                  </button>
                </div>
              </div>

              {/* YM ST Sekmeleri */}
              <div className="flex flex-wrap gap-2 mb-6 border-b">
                {[...selectedYmSts, ...autoGeneratedYmSts].map((ymSt, index) => (
                  <button
                    key={index}
                    onClick={() => setActiveRecipeTab(index)}
                    className={`px-4 py-2 rounded-t-lg font-medium transition-colors ${
                      activeRecipeTab === index
                        ? 'bg-purple-100 text-purple-700 border-b-2 border-purple-600'
                        : 'text-gray-600 hover:text-purple-600 hover:bg-purple-50'
                    }`}
                  >
                    YM ST #{index + 1}
                    <span className="text-xs block">
                      {parseFloat(ymSt.cap || 0)} mm
                    </span>
                  </button>
                ))}
              </div>

              {/* ReÃ§ete Ä°Ã§eriklerini Kategorize GÃ¶ster */}
              {activeRecipeTab !== null && (
                <div className="space-y-6">
                  {/* MM GT ReÃ§ete */}
                  <div className="p-6 bg-red-50 rounded-lg">
                    <h3 className="text-lg font-medium mb-4 text-red-700">
                      MM GT #{activeRecipeTab + 1} ReÃ§etesi
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {/* 8 alan iÃ§in Ã¶zel dÃ¼zenleme - Shrink alanÄ± dropdown ile */}
                      {[
                        { key: `YM.GT.${mmGtData.kod_2}.${Math.round(parseFloat(mmGtData.cap) * 100).toString().padStart(4, '0')}.${activeRecipeTab.toString().padStart(2, '0')}`, type: 'readonly' }, // YM GT bileÅŸeni - sequence eÅŸleÅŸtirme
                        { key: 'GTPKT01', type: 'input' },
                        { key: 'AMB.Ã‡EM.KARTON.GAL', type: 'input' },
                        { key: 'SM.7MMHALKA', type: 'input' },
                        { key: 'AMB.TOKA.SIGNODE.114P. DKP', type: 'input' },
                        { key: 'shrink', type: 'dropdown' }, // Ã–zel shrink dropdown
                        { key: 'AMB.APEX CEMBER 38X080', type: 'input' },
                        { key: 'SM.DESÄ°.PAK', type: 'input' }
                      ].map(({ key, type }, idx) => {
                        const allYmSts = [...selectedYmSts, ...autoGeneratedYmSts];
                        let currentValue = '';
                        
                        if (type === 'readonly') {
                          currentValue = key;
                        } else if (key === 'shrink') {
                          // Mevcut shrink tipini bul
                          const shrinkKeys = ['AMB.SHRÄ°NK.200*140CM', 'AMB.SHRÄ°NK.200*160CM', 'AMB.SHRÄ°NK.200*190CM'];
                          const currentShrinkKey = shrinkKeys.find(sk => allRecipes.mmGtRecipes[activeRecipeTab]?.[sk] > 0);
                          currentValue = currentShrinkKey || '';
                        } else {
                          currentValue = allRecipes.mmGtRecipes[activeRecipeTab]?.[key] || '';
                        }
                        
                        const friendlyName = type === 'readonly' ? 'YM GT BileÅŸeni' : friendlyNames[key] || key;
                        const statusText = type === 'readonly' ? 'Otomatik oluÅŸturuldu' : getRecipeStatusText('mmgt', activeRecipeTab, key);
                        // Force 'readonly' type to use KG as the unit
                        
                        return (
                          <div key={key} className="space-y-2">
                            <label className="block text-sm font-medium text-gray-700">
                              {friendlyName}
                              <span className="text-xs text-gray-500 ml-2">
                                ({getOlcuBr(key)})
                              </span>
                            </label>
                            {type === 'readonly' ? (
                              <input
                                type="text"
                                value={currentValue}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600 focus:outline-none cursor-not-allowed"
                                readOnly
                              />
                            ) : type === 'dropdown' ? (
                              <div className="space-y-4">
                                <div className="space-y-2">
                                  <label className="block text-sm font-medium text-gray-700">
                                    Shrink Tipi
                                  </label>
                                  <select
                                    value={currentValue}
                                    onChange={(e) => handleShrinkChange(activeRecipeTab, e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                  >
                                    <option value="">Shrink Tipi SeÃ§in</option>
                                    <option value="AMB.SHRÄ°NK.200*140CM">AMB.SHRÄ°NK.200*140CM</option>
                                    <option value="AMB.SHRÄ°NK.200*160CM">AMB.SHRÄ°NK.200*160CM</option>
                                    <option value="AMB.SHRÄ°NK.200*190CM">AMB.SHRÄ°NK.200*190CM</option>
                                  </select>
                                </div>
                                <div className="space-y-2">
                                  <label className="block text-sm font-medium text-gray-700">
                                    Shrink TÃ¼ketimi
                                  </label>
                                  <input
                                    type="text"
                                    inputMode="decimal"
                                    value={currentValue ? normalizeDecimalDisplay(allRecipes.mmGtRecipes[activeRecipeTab]?.[currentValue] || 0) : ''}
                                    onChange={(e) => currentValue && updateRecipeValue('mmgt', activeRecipeTab, currentValue, e.target.value)}
                                    placeholder="Shrink MiktarÄ±"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                    disabled={!currentValue}
                                    onKeyDown={(e) => currentValue && handleRecipeCommaToPoint(e, 'mmgt', activeRecipeTab, currentValue)}
                                  />
                                </div>
                              </div>
                            ) : (
                              <input
                                type="text"
                                inputMode="decimal"
                                value={normalizeDecimalDisplay(currentValue || '')}
                                onChange={(e) => updateRecipeValue('mmgt', activeRecipeTab, key, e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                onKeyDown={(e) => handleRecipeCommaToPoint(e, 'mmgt', activeRecipeTab, key)}
                              />
                            )}
                            {statusText && (
                              <p className="text-xs text-gray-500 italic">{statusText}</p>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {/* YM GT ReÃ§ete */}
                  <div className="p-6 bg-yellow-50 rounded-lg">
                    <h3 className="text-lg font-medium mb-4 text-yellow-700">
                      YM GT ReÃ§etesi
                    </h3>
                    <p className="text-sm text-gray-600 mb-3">
                      YM ST baÄŸlantÄ±sÄ± otomatik olarak yapÄ±lÄ±r. Sadece aÅŸaÄŸÄ±daki 3 deÄŸeri dÃ¼zenleyebilirsiniz:
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      {/* 3 alan iÃ§in Ã¶zel dÃ¼zenleme - YM ST bileÅŸeni readonly */}
                      {[
                        { key: [...selectedYmSts, ...autoGeneratedYmSts][activeRecipeTab]?.stok_kodu || 'YM.ST.PLACEHOLDER', type: 'readonly' }, // YM ST bileÅŸeni otomatik
                        { key: 'GLV01', type: 'input' },
                        { key: '150 03', type: 'input' },
                        { key: 'SM.HÄ°DROLÄ°K.ASÄ°T', type: 'input' }
                      ].map(({ key, type }, idx) => {
                        if (idx === 0) {
                          // Ä°lk alan YM ST bileÅŸeni - sadece gÃ¶sterim iÃ§in
                          return (
                            <div key={key} className="space-y-2">
                              <label className="block text-sm font-medium text-gray-700">
                                YM ST BileÅŸeni (Otomatik)
                                <span className="text-xs text-gray-500 ml-2">
                                  (KG)
                                </span>
                              </label>
                              <input
                                type="text"
                                value={key || ''}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600 focus:outline-none cursor-not-allowed"
                                readOnly
                              />
                              <p className="text-xs text-gray-500 italic">
                                Otomatik belirlendi
                              </p>
                            </div>
                          );
                        }
                        
                        const friendlyName = friendlyNames[key] || key;
                        const currentValue = allRecipes.ymGtRecipe?.[key] || '';
                        const statusText = getRecipeStatusText('ymgt', null, key);
                        
                        return (
                          <div key={key} className="space-y-2">
                            <label className="block text-sm font-medium text-gray-700">
                              {friendlyName}
                              <span className="text-xs text-gray-500 ml-2">
                                ({getOlcuBr(key)})
                              </span>
                            </label>
                            <input
                              type="text"
                              inputMode="decimal"
                              value={normalizeDecimalDisplay(currentValue || '')}
                              onChange={(e) => updateRecipeValue('ymgt', null, key, e.target.value)}
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                              onKeyDown={(e) => handleRecipeCommaToPoint(e, 'ymgt', null, key)}
                            />
                            {statusText && (
                              <p className="text-xs text-gray-500 italic">{statusText}</p>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {/* YM ST ReÃ§ete */}
                  <div className="p-6 bg-green-50 rounded-lg">
                    <h3 className="text-lg font-medium mb-4 text-green-700">
                      YM ST #{activeRecipeTab + 1} ReÃ§etesi
                    </h3>
                    <p className="text-sm text-gray-600 mb-3">
                      FLM baÄŸlantÄ±sÄ± otomatik olarak oluÅŸturulan versiyonu dÃ¼zenleyebilirsiniz:
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {/* FLM ve TLC01 alanlarÄ± */}
                      {[
                        { key: 'filmasin_kodu', type: 'input' }, // FilmaÅŸin tipi dÃ¼zenlenebilir
                        { key: 'TLC01', type: 'input' }
                      ].map(({ key, type }, idx) => {
                        if (idx === 0) {
                          // Ä°lk alan FilmaÅŸin tipi - dÃ¼zenlenebilir
                          const filmasinCode = getFilmasinKodu([...selectedYmSts, ...autoGeneratedYmSts][activeRecipeTab]);
                          const statusText = getRecipeStatusText('ymst', activeRecipeTab, 'filmasin_kodu');
                          
                          return (
                            <div key={key} className="space-y-2">
                              <label className="block text-sm font-medium text-gray-700">
                                FilmaÅŸin Tipi
                                <span className="text-xs text-gray-500 ml-2">
                                  (Kod)
                                </span>
                              </label>
                              <div className="flex gap-2">
                                <select
                                  className="w-1/3 p-2 border border-gray-300 rounded-md"
                                  value={filmasinCode.substring(4, 8)}
                                  onChange={(e) => {
                                    // Get the diameter part
                                    const newDiameter = e.target.value;
                                    // Get the quality part from existing code
                                    const quality = filmasinCode.substring(9);
                                    
                                    // Construct new filmasin code
                                    const newFilmasinCode = `FLM.${newDiameter}.${quality}`;
                                    
                                    // Get the active YM ST and its current filmasin code
                                    const activeYmSt = [...selectedYmSts, ...autoGeneratedYmSts][activeRecipeTab];
                                    const oldKey = getFilmasinKodu(activeYmSt);
                                    const oldValue = allRecipes.ymStRecipes[activeRecipeTab]?.[oldKey] || 1;
                                    
                                    // Update recipes with new key
                                    const updatedRecipes = { ...allRecipes };
                                    delete updatedRecipes.ymStRecipes[activeRecipeTab][oldKey];
                                    updatedRecipes.ymStRecipes[activeRecipeTab][newFilmasinCode] = oldValue;
                                    setAllRecipes(updatedRecipes);
                                    
                                    // Update recipe status
                                    const updatedStatus = { ...recipeStatus };
                                    updatedStatus.ymStRecipes[activeRecipeTab][newFilmasinCode] = 'manual';
                                    setRecipeStatus(updatedStatus);
                                  }}
                                >
                                  <option value="0550">5.50 mm</option>
                                  <option value="0600">6.00 mm</option>
                                  <option value="0700">7.00 mm</option>
                                  <option value="0800">8.00 mm</option>
                                  <option value="0900">9.00 mm</option>
                                </select>
                                
                                <select
                                  className="w-1/3 p-2 border border-gray-300 rounded-md"
                                  value={filmasinCode.substring(9)}
                                  onChange={(e) => {
                                    // Get the quality part
                                    const newQuality = e.target.value;
                                    // Get the diameter part from existing code
                                    const diameter = filmasinCode.substring(4, 8);
                                    
                                    // Construct new filmasin code
                                    const newFilmasinCode = `FLM.${diameter}.${newQuality}`;
                                    
                                    // Get the active YM ST and its current filmasin code
                                    const activeYmSt = [...selectedYmSts, ...autoGeneratedYmSts][activeRecipeTab];
                                    const oldKey = getFilmasinKodu(activeYmSt);
                                    const oldValue = allRecipes.ymStRecipes[activeRecipeTab]?.[oldKey] || 1;
                                    
                                    // Update recipes with new key
                                    const updatedRecipes = { ...allRecipes };
                                    delete updatedRecipes.ymStRecipes[activeRecipeTab][oldKey];
                                    updatedRecipes.ymStRecipes[activeRecipeTab][newFilmasinCode] = oldValue;
                                    setAllRecipes(updatedRecipes);
                                    
                                    // Update recipe status
                                    const updatedStatus = { ...recipeStatus };
                                    updatedStatus.ymStRecipes[activeRecipeTab][newFilmasinCode] = 'manual';
                                    setRecipeStatus(updatedStatus);
                                  }}
                                >
                                  <option value="1005">1005</option>
                                  <option value="1006">1006</option>
                                  <option value="1008">1008</option>
                                  <option value="1010">1010</option>
                                </select>
                              </div>
                              {statusText && (
                                <p className="text-xs text-gray-500 italic">{statusText}</p>
                              )}
                            </div>
                          );
                        }
                        
                        const friendlyName = friendlyNames[key] || key;
                        const currentValue = allRecipes.ymStRecipes[activeRecipeTab]?.[key] || '';
                        const statusText = getRecipeStatusText('ymst', activeRecipeTab, key);
                        
                        return (
                          <div key={key} className="space-y-2">
                            <label className="block text-sm font-medium text-gray-700">
                              {friendlyName}
                              <span className="text-xs text-gray-500 ml-2">
                                ({getOlcuBr(key)})
                              </span>
                            </label>
                            <input
                              type="text"
                              inputMode="decimal"
                              value={normalizeDecimalDisplay(currentValue || '')}
                              onChange={(e) => updateRecipeValue('ymst', activeRecipeTab, key, e.target.value)}
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                              onKeyDown={(e) => handleRecipeCommaToPoint(e, 'ymst', activeRecipeTab, key)}
                            />
                            {statusText && (
                              <p className="text-xs text-gray-500 italic">{statusText}</p>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Ä°ÅŸlem ButonlarÄ± */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <div className="flex flex-wrap gap-4 justify-center">
              <button
                onClick={() => setCurrentStep('input')}
                className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors shadow-lg flex items-center gap-2"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
                Geri
              </button>
              
              <button
                onClick={async () => {
                  try {
                    // First save to database if not already saved
                    if (!savedToDatabase) {
                      await saveToDatabase();
                    }
                    // Then generate Excel files
                    await generateExcelFiles();
                  } catch (error) {
                    console.error("Ä°ÅŸlem sÄ±rasÄ±nda hata oluÅŸtu:", error);
                    setError(`Ä°ÅŸlem hatasÄ±: ${error.message}`);
                    toast.error(`Ä°ÅŸlem hatasÄ±: ${error.message}`);
                  }
                }}
                disabled={isLoading}
                className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 shadow-lg flex items-center gap-2"
              >
                {isLoading ? (
                  <>
                    <svg className="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Ä°ÅŸlem YapÄ±lÄ±yor...
                  </>
                ) : (
                  <>
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                    VeritabanÄ±na Kaydet ve Excel OluÅŸtur
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Settings Modal for User Input Values */}
      {showSettingsModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl">
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                  <svg className="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  Hesaplama DeÄŸerleri
                </h2>
                <button
                  onClick={() => setShowSettingsModal(false)}
                  className="text-gray-400 hover:text-gray-600"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              
              <div className="space-y-6">
                <p className="text-sm text-gray-600 mb-4">
                  Bu deÄŸerler hesaplamalarda kullanÄ±lacak olan sabit deÄŸerlerdir. DeÄŸiÅŸiklik yaptÄ±ktan sonra "Kaydet" dÃ¼ÄŸmesine basarak kaydedin.
                </p>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                  <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-700">
                      Ash (KÃ¼l) (Kg/tonne)
                    </label>
                    <input
                      type="text"
                      value={userInputValues.ash}
                      onChange={(e) => setUserInputValues(prev => ({ 
                        ...prev, 
                        ash: e.target.value.replace(/,/g, '.') // Replace commas with points
                      }))}
                      onBlur={(e) => setUserInputValues(prev => ({
                        ...prev,
                        ash: parseFloat(e.target.value.replace(/,/g, '.')) || prev.ash // Convert to number on blur
                      }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                  </div>
                  
                  <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-700">
                      Lapa (Kg/tonne)
                    </label>
                    <input
                      type="text"
                      value={userInputValues.lapa}
                      onChange={(e) => setUserInputValues(prev => ({ 
                        ...prev, 
                        lapa: e.target.value.replace(/,/g, '.') 
                      }))}
                      onBlur={(e) => setUserInputValues(prev => ({
                        ...prev,
                        lapa: parseFloat(e.target.value.replace(/,/g, '.')) || prev.lapa
                      }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                  </div>
                  
                  <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-700">
                      Ãœretim Kapasitesi (AylÄ±k)
                    </label>
                    <input
                      type="text"
                      value={userInputValues.uretim_kapasitesi_aylik}
                      onChange={(e) => setUserInputValues(prev => ({ 
                        ...prev, 
                        uretim_kapasitesi_aylik: e.target.value.replace(/,/g, '.') 
                      }))}
                      onBlur={(e) => setUserInputValues(prev => ({
                        ...prev,
                        uretim_kapasitesi_aylik: parseFloat(e.target.value.replace(/,/g, '.')) || prev.uretim_kapasitesi_aylik
                      }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                  </div>
                  
                  <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-700">
                      Toplam TÃ¼ketilen Asit
                    </label>
                    <input
                      type="text"
                      value={userInputValues.toplam_tuketilen_asit}
                      onChange={(e) => setUserInputValues(prev => ({ 
                        ...prev, 
                        toplam_tuketilen_asit: e.target.value.replace(/,/g, '.') 
                      }))}
                      onBlur={(e) => setUserInputValues(prev => ({
                        ...prev,
                        toplam_tuketilen_asit: parseFloat(e.target.value.replace(/,/g, '.')) || prev.toplam_tuketilen_asit
                      }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                  </div>
                  
                  <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-700">
                      Ortalama Ãœretim Ã‡apÄ±
                    </label>
                    <input
                      type="text"
                      value={userInputValues.ortalama_uretim_capi}
                      onChange={(e) => setUserInputValues(prev => ({ 
                        ...prev, 
                        ortalama_uretim_capi: e.target.value.replace(/,/g, '.') 
                      }))}
                      onBlur={(e) => setUserInputValues(prev => ({
                        ...prev,
                        ortalama_uretim_capi: parseFloat(e.target.value.replace(/,/g, '.')) || prev.ortalama_uretim_capi
                      }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                  </div>
                  
                  <div className="space-y-2">
                    <label className="block text-sm font-medium text-gray-700">
                      Paketleme Dk. Adet
                    </label>
                    <input
                      type="text"
                      value={userInputValues.paketlemeDkAdet}
                      onChange={(e) => setUserInputValues(prev => ({ 
                        ...prev, 
                        paketlemeDkAdet: e.target.value.replace(/,/g, '.') 
                      }))}
                      onBlur={(e) => setUserInputValues(prev => ({
                        ...prev,
                        paketlemeDkAdet: parseFloat(e.target.value.replace(/,/g, '.')) || prev.paketlemeDkAdet
                      }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                  </div>
                </div>
                
                <div className="flex justify-end space-x-3">
                  <button
                    onClick={() => setShowSettingsModal(false)}
                    className="px-4 py-2 text-sm border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50"
                  >
                    Ä°ptal
                  </button>
                  <button
                    onClick={saveUserInputValues}
                    className="px-4 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700"
                  >
                    Kaydet
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* YM ST Ekleme ModalÄ± */}
      {showAddYmStModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-800">YM ST Ekle</h2>
                <button
                  onClick={() => setShowAddYmStModal(false)}
                  className="text-gray-500 hover:text-gray-700 transition-colors"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Ã‡ap (mm)
                  </label>
                  <input
                    type="text"
                    inputMode="decimal"
                    value={normalizeDecimalDisplay(newYmStData.cap)}
                    onChange={(e) => setNewYmStData(prev => ({ ...prev, cap: normalizeInputValue(e.target.value) }))}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="0.00000"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    FilmaÅŸin
                  </label>
                  <select
                    value={newYmStData.filmasin}
                    onChange={(e) => setNewYmStData(prev => ({ ...prev, filmasin: e.target.value }))}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">SeÃ§in</option>
                    <option value="0550">0550</option>
                    <option value="0600">0600</option>
                    <option value="0700">0700</option>
                    <option value="0800">0800</option>
                    <option value="0900">0900</option>
                    <option value="1000">1000</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Kalite
                  </label>
                  <select
                    value={newYmStData.quality}
                    onChange={(e) => setNewYmStData(prev => ({ ...prev, quality: e.target.value }))}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">SeÃ§in</option>
                    <option value="1006">1006</option>
                    <option value="1008">1008</option>
                    <option value="1010">1010</option>
                  </select>
                </div>
              </div>
              
              <div className="flex gap-3 mt-6">
                <button
                  onClick={() => setShowAddYmStModal(false)}
                  className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  Ä°ptal
                </button>
                <button
                  onClick={handleAddYmSt}
                  className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Ekle
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Talepler ModalÄ± */}
      {showRequestsModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[80vh] overflow-auto">
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                  <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                  </svg>
                  Bekleyen Talepler
                </h2>
                <div className="flex gap-3">
                  <button
                    onClick={fetchRequests}
                    disabled={isLoading}
                    className="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors shadow-sm flex items-center gap-2"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Yenile
                  </button>
                  <button
                    onClick={() => setShowRequestsModal(false)}
                    className="text-gray-500 hover:text-gray-700 transition-colors"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
              
              {isLoading ? (
                <div className="flex justify-center items-center py-12">
                  <div className="text-gray-500 flex items-center gap-2">
                    <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    YÃ¼kleniyor...
                  </div>
                </div>
              ) : requests.length === 0 ? (
                <div className="text-center py-12">
                  <svg className="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                  </svg>
                  <p className="text-gray-500 text-lg">Bekleyen talep bulunamadÄ±.</p>
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Ã‡ap
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Kaplama TÃ¼rÃ¼
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Kaplama
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Mukavemet
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          AÄŸÄ±rlÄ±k
                        </th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          Ä°ÅŸlem
                        </th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {requests.map((request) => (
                        <tr key={request.id} className="hover:bg-gray-50 transition-colors">
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {request.cap || 0} mm
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                              request.kod_2 === 'NIT' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'
                            }`}>
                              {request.kod_2 || ''}
                            </span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {request.kaplama || '0'} gr/mÂ²
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {request.min_mukavemet || '0'}-{request.max_mukavemet || '0'} MPa
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {request.kg || '0'} kg
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div className="flex gap-2">
                              <button
                                onClick={() => handleSelectRequest(request)}
                                className="text-blue-600 hover:text-blue-900 transition-colors"
                              >
                                SeÃ§
                              </button>
                              <button
                                onClick={() => {
                                  if (window.confirm('Bu talebi silmek istediÄŸinizden emin misiniz?')) {
                                    deleteRequest(request.id);
                                  }
                                }}
                                className="text-red-600 hover:text-red-900 transition-colors"
                              >
                                Sil
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Mevcut MM GT / YM ST ModalÄ± */}
      {showExistingMmGtModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[80vh] overflow-auto">
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                  <svg className="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                  VeritabanÄ±ndan SeÃ§
                </h2>
                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      fetchExistingMmGts();
                      fetchExistingYmSts();
                    }}
                    disabled={isLoading}
                    className="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors shadow-sm flex items-center gap-2"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Yenile
                  </button>
                  <button
                    onClick={() => setShowExistingMmGtModal(false)}
                    className="text-gray-500 hover:text-gray-700 transition-colors"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
              
              {/* Tab'lar */}
              <div className="flex gap-4 mb-6 border-b">
                <button
                  onClick={() => setActiveDbTab('mmgt')}
                  className={`px-4 py-2 font-medium transition-colors ${
                    activeDbTab === 'mmgt'
                      ? 'text-purple-600 border-b-2 border-purple-600'
                      : 'text-gray-600 hover:text-purple-600'
                  }`}
                >
                  MM GT
                </button>
                <button
                  onClick={() => setActiveDbTab('ymst')}
                  className={`px-4 py-2 font-medium transition-colors ${
                    activeDbTab === 'ymst'
                      ? 'text-purple-600 border-b-2 border-purple-600'
                      : 'text-gray-600 hover:text-purple-600'
                  }`}
                >
                  YM ST
                </button>
              </div>
              
              {/* MM GT Tab Ä°Ã§eriÄŸi */}
              {activeDbTab === 'mmgt' && (
                <>
                  {existingMmGts.length === 0 ? (
                    <div className="text-center py-12">
                      <svg className="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                      <p className="text-gray-500 text-lg">Mevcut MM GT bulunamadÄ±.</p>
                    </div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Stok Kodu
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Ã‡ap
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Kaplama TÃ¼rÃ¼
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Kaplama
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Mukavemet
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              AÄŸÄ±rlÄ±k
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Ä°ÅŸlem
                            </th>
                          </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                          {existingMmGts.map((mmGt) => (
                            <tr key={mmGt.id} className="hover:bg-gray-50 transition-colors">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {mmGt.stok_kodu || ''}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {parseFloat(mmGt.cap || 0)} mm
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                  mmGt.kod_2 === 'NIT' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'
                                }`}>
                                  {mmGt.kod_2 || ''}
                                </span>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {mmGt.kaplama || '0'} gr/mÂ²
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {mmGt.min_mukavemet || '0'}-{mmGt.max_mukavemet || '0'} MPa
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {mmGt.kg || '0'} kg
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div className="flex gap-2">
                                  <button
                                    onClick={() => handleSelectExistingMmGt(mmGt)}
                                    className="text-purple-600 hover:text-purple-900 transition-colors"
                                  >
                                    SeÃ§
                                  </button>
                                  <button
                                    onClick={() => handleDeleteClick(mmGt, 'mmgt')}
                                    className="text-red-600 hover:text-red-900 transition-colors"
                                  >
                                    Sil
                                  </button>
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </>
              )}
              
              {/* YM ST Tab Ä°Ã§eriÄŸi */}
              {activeDbTab === 'ymst' && (
                <>
                  {existingYmSts.length === 0 ? (
                    <div className="text-center py-12">
                      <svg className="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                      <p className="text-gray-500 text-lg">Mevcut YM ST bulunamadÄ±.</p>
                    </div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Stok Kodu
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Ã‡ap
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              FilmaÅŸin
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Kalite
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              Ä°ÅŸlem
                            </th>
                          </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                          {existingYmSts.map((ymSt) => (
                            <tr key={ymSt.id} className="hover:bg-gray-50 transition-colors">
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {ymSt.stok_kodu || ''}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {parseFloat(ymSt.cap || 0)} mm
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {ymSt.filmasin || ''}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {ymSt.quality || ''}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button
                                  onClick={() => handleDeleteClick(ymSt, 'ymst')}
                                  className="text-red-600 hover:text-red-900 transition-colors"
                                >
                                  Sil
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Silme Onay ModalÄ± */}
      {showDeleteConfirm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-800">Silme OnayÄ±</h2>
                <button
                  onClick={() => handleDeleteCancel()}
                  className="text-gray-500 hover:text-gray-700 transition-colors"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              
              <p className="text-gray-600 mb-6">
                {deleteType === 'mmgt' 
                  ? 'Bu MM GT\'yi ve tÃ¼m baÄŸlÄ± verilerini (YM GT\'ler, reÃ§eteler vb.) silmek istediÄŸinizden emin misiniz?'
                  : 'Bu YM ST\'yi ve baÄŸlÄ± reÃ§etelerini silmek istediÄŸinizden emin misiniz?'
                }
              </p>
              
              <div className="flex gap-3">
                <button
                  onClick={() => handleDeleteCancel()}
                  className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  Ä°ptal
                </button>
                <button
                  onClick={() => deleteType === 'mmgt' ? deleteMmGt(itemToDelete) : deleteYmSt(itemToDelete)}
                  disabled={isLoading}
                  className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50"
                >
                  {isLoading ? 'Siliniyor...' : 'Sil'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Hata ve BaÅŸarÄ± MesajlarÄ± */}
      {error && (
        <div className="mt-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 shadow-sm">
          <div className="flex items-center gap-2">
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            {error}
          </div>
        </div>
      )}
      
      {successMessage && (
        <div className="mt-6 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-4 shadow-sm">
          <div className="flex items-center gap-2">
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {successMessage}
          </div>
        </div>
      )}
    </div>
  );
};

export default GalvanizliTelNetsis;